<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
  <title>Solar System</title>
  <link rel="icon" href="img/icon_white.png" type="image/x-icon">
  <link rel="stylesheet" href="css/font-awesome.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <!------ æœˆé£Ÿè·³è½¬æµ®åŠ¨banner ------>
  <div id="eclipseBanner" class="eclipse-banner hidden">
    <div class="banner-content">
      <div class="banner-icon">ğŸŒ™</div>
      <div class="banner-info">
        <div class="banner-header">
          <div class="banner-title">å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆé£Ÿ</div>
          <div class="eclipse-type-badge">æœˆå…¨é£Ÿ</div>
        </div>
        <div class="banner-tips">ğŸ’¡ æ‰“å¼€ç”»ä¸­ç”»è§‚çœ‹å®Œæ•´æœˆé£Ÿè¿‡ç¨‹</div>
      </div>
      <button class="banner-close" onclick="hideEclipseBanner()">Ã—</button>
    </div>
    <div class="banner-progress"></div>
  </div>

  <!------ æ—¥é£Ÿè·³è½¬æµ®åŠ¨banner ------>
  <div id="solarEclipseBanner" class="eclipse-banner hidden">
    <div class="banner-content">
      <div class="banner-icon">â˜€ï¸</div>
      <div class="banner-info">
        <div class="banner-header">
          <div class="banner-title">å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥é£Ÿ</div>
          <div class="eclipse-type-badge"></div>
        </div>
        <div class="banner-tips">ğŸ’¡ æ‰“å¼€ç”»ä¸­ç”»è§‚çœ‹å®Œæ•´æ—¥é£Ÿè¿‡ç¨‹</div>
      </div>
      <button class="banner-close" onclick="hideSolarEclipseBanner()">Ã—</button>
    </div>
    <div class="banner-progress"></div>
  </div>

  <!------ æ ‡é¢˜ ------>
  <div id="title">
    <img src="img/icon_white.png" alt="Solar System">
    <h1>Solar System Sim</h1>
  </div>

  <!------ ä»ªè¡¨ç›˜åŒºåŸŸ ------>
  <div id="dashboard">
    <div class="dashboard-item">
      <span class="db-label">é€Ÿåº¦æ¯”ä¾‹</span>
      <span class="db-value" id="db-speed">1d/s</span>
    </div>
    <div class="dashboard-divider"></div>
    <div class="dashboard-item">
      <span class="db-label">æ²™ç½—å‘¨æœŸè¿›åº¦</span>
      <span class="db-value" id="db-saros">0%</span>
    </div>
    <div class="dashboard-divider"></div>
    <div class="dashboard-item moon-phase">
      <span class="db-label">æœˆç›¸çŠ¶æ€</span>
      <span class="db-value" id="db-moonphase">æ–°æœˆ</span>
    </div>
    <div class="dashboard-divider"></div>
    <div class="dashboard-item">
      <span class="db-label">å¯¹é½ç¨‹åº¦</span>
      <span class="db-value" id="db-alignment">0%</span>
    </div>
  </div>

  <!------ æ§åˆ¶é¢æ¿ ------>
  <button id="controlBtn" aria-label="æ‰“å¼€/å…³é—­æ§åˆ¶é¢æ¿">
    <span>â‰¡</span>
  </button>
  <aside id="controlPanel">
    <!---- æ ‡ç­¾é¡µåˆ‡æ¢å¯¼èˆª ---->
    <nav id="tabs">
      <button class="tab active" data-tab="page1">
        <i class="fa fa-info-circle"></i>
        <span>ä¿¡æ¯</span>
      </button>
      <button class="tab" data-tab="page2">
        <i class="fa fa-eye"></i>
        <span>è§†å›¾</span>
      </button>
      <button class="tab" data-tab="page3">
        <i class="fa fa-cog"></i>
        <span>å‚æ•°</span>
      </button>
    </nav>
    <!---- æ ‡ç­¾é¡µå†…å®¹ ---->
    <div id="panels">
      <!-- æ ‡ç­¾é¡µ1ï¼šä¿¡æ¯é¡µ -->
      <div class="panel active" id="page1">
        <div class="contorl-block" id="infoBlock">
          <div id="infoBody">
            <h4>&emsp;æ¬¢è¿ä½¿ç”¨Solar System Sim!<br>è¿™æ˜¯ä¸€ä¸ªåœ¨çº¿å¤©ä½“è¿è¡Œæ¼”ç¤ºå¹³å°</h4>
            <img src="img/introduce.png" width="90%">
            <p>&emsp;&emsp;æœ¬é¡¹ç›®æ—¨åœ¨é€šè¿‡äº¤äº’å¼æ¨¡æ‹Ÿï¼Œç›´è§‚å‘ˆç°å¤ªé˜³ã€åœ°çƒã€æœˆçƒçš„è¿è¡Œå…³ç³»ï¼Œä»¥åŠç”±æ­¤äº§ç”Ÿçš„æœˆç›¸å˜åŒ–ã€æ—¥é£Ÿå’Œæœˆé£Ÿç°è±¡ã€‚æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š
            <ul>
              <li>- å®æ—¶æ¨¡æ‹Ÿæ—¥æœˆåœ°ç›¸å¯¹è¿åŠ¨è½¨è¿¹ï¼›</li>
              <li>- äº¤äº’å¼çš„3Dè‡ªç”±è§†è§’è§‚å¯Ÿï¼›</li>
              <li>- åŠ¨æ€å±•ç¤ºä¸åŒæ—¶é—´ç‚¹çš„æœˆç›¸ï¼›</li>
              <li>- é¢„æµ‹å’Œæ¼”ç¤ºæ—¥é£Ÿï¼ˆæ—¥å…¨é£Ÿã€æ—¥åé£Ÿã€æ—¥ç¯é£Ÿï¼‰å’Œæœˆé£Ÿï¼ˆæœˆå…¨é£Ÿã€æœˆåé£Ÿï¼‰çš„å‘ç”Ÿè¿‡ç¨‹ï¼›</li>
              <li>- æ”¯æŒè°ƒæ•´æ—¶é—´æµé€Ÿã€è§‚æµ‹è§†è§’ç­‰å‚æ•°ã€‚</li>
            </ul>
            </p>
            <p>æ›´å¤šä½¿ç”¨ä¿¡æ¯è¯·æŸ¥çœ‹<a href="javascript:void(0)" onclick="clickOnToolHelp()">å¸®åŠ©æ‰‹å†Œ</a></p>
          </div>
          <div id="infoFooter">
            <p>- Â© 2025 Solar System Sim. All rights reserved. -</p>
            <p>- Developed by OneSony,&ensp;isXSong,&ensp;VoinCiao. -</p>
            <p>- Powered by Three.js -</p>
            <p>
              æœ¬é¡¹ç›®ä»…ç”¨äºå­¦ä¹ å’Œæ•™å­¦å®è·µ&ensp;|&ensp;
              <a href="https://github.com/OneSony/SolarSystem" target="_blank">GitHub é¡¹ç›®ä»“åº“</a>
            </p>
          </div>
        </div>
      </div>
      <!-- æ ‡ç­¾é¡µ2ï¼šè§†å›¾é¡µ -->
      <div class="panel" id="page2">
        <!-- æ§åˆ¶å—ï¼šç›¸æœºè§†è§’ -->
        <div class="contorl-block" id="viewSettings">
          <h4>
            <span class="zh">ç›¸æœºè§†è§’</span>
            <span class="en">Camera View</span>
          </h4>
          <ul>
            <li>
              <input type="radio" name="view" id="top-view" value="top-view" hidden>
              <label for="top-view" class="view-label">
                <i class="fa fa-toggle-down"></i>
                <span>ä¿¯è§†å›¾</span>
              </label>
            </li>
            <li>
              <input type="radio" name="view" id="side-view" value="side-view" hidden>
              <label for="side-view" class="view-label">
                <i class="fa fa-toggle-right"></i>
                <span>ä¾§è§†å›¾</span>
              </label>
            </li>
            <li>
              <input type="radio" name="view" id="3D-view" value="3D-view" checked hidden>
              <label for="3D-view" class="view-label">
                <i class="fa fa-cube"></i>
                <span>3Dè§†å›¾</span>
              </label>
            </li>
          </ul>
        </div>
        <hr>
        <!-- æ§åˆ¶å—ï¼šè´´å›¾çº¹ç† -->
        <div class="contorl-block" id="textureSettings">
          <h4>
            <span class="zh">è´´å›¾çº¹ç†</span>
            <span class="en">Surface Texture</span>
          </h4>
          <div id="earthTexture">
            <h5>åœ°çƒè´´å›¾</h5>
            <ul>
              <li>
                <input type="radio" name="earth-texture" id="solid-blue" value="solid-blue" hidden>
                <label for="solid-blue" class="texture-label">
                  <i></i>
                  <span>çº¯è“è‰²</span>
                </label>
              </li>
              <li>
                <input type="radio" name="earth-texture" id="common-map" value="common-map" hidden>
                <label for="common-map" class="texture-label">
                  <i></i>
                  <span>ä¸–ç•ŒåŒºåˆ’åœ°å›¾</span>
                </label>
              </li>
              <li>
                <input type="radio" name="earth-texture" id="satellite-map" value="satellite-map" checked hidden>
                <label for="satellite-map" class="texture-label">
                  <i></i>
                  <span>å«æ˜Ÿåœ°å›¾</span>
                </label>
              </li>
            </ul>
          </div>
          <div id="sunTexture">
            <h5>å¤ªé˜³è´´å›¾</h5>
            <ul>
              <li>
                <input type="radio" name="sun-texture" id="solid-orange" value="solid-orange" hidden>
                <label for="solid-orange" class="texture-label">
                  <i></i>
                  <span>çº¯æ©™è‰²</span>
                </label>
              </li>
              <li>
                <input type="radio" name="sun-texture" id="true-surface" value="true-surface" checked hidden>
                <label for="true-surface" class="texture-label">
                  <i></i>
                  <span>çœŸå®è¡¨é¢</span>
                </label>
              </li>
            </ul>
          </div>
          <div id="starland">
            <h5>æ˜Ÿç©ºèƒŒæ™¯</h5>
            <ul>
              <li>
                <input type="radio" name="starland" id="solid-black" value="solid-black" hidden>
                <label for="solid-black" class="texture-label">
                  <i></i>
                  <span>çº¯é»‘</span>
                </label>
              </li>
              <li>
                <input type="radio" name="starland" id="stars" value="stars" checked hidden>
                <label for="stars" class="texture-label">
                  <i></i>
                  <span>ç¹æ˜Ÿ</span>
                </label>
              </li>
            </ul>
          </div>
        </div>
        <hr>
        <div class="contorl-block" id="auxiliarySettings">
          <h4>
            <span class="zh">è¾…åŠ©æ˜¾ç¤º</span>
            <span class="en">Auxiliary Information</span>
          </h4>
          <ul>
            <li>
              <input type="checkbox" id="axisSwitch" checked hidden>
              <label for="axisSwitch" class="texture-label">
                <span>æ˜¾ç¤ºåœ°è½´</span>
                <i><span>âˆš</span></i>
              </label>
            </li>
            <li>
              <input type="checkbox" id="moonNormalSwitch" checked hidden>
              <label for="moonNormalSwitch" class="texture-label">
                <span>æ˜¾ç¤ºè½¨é“æ³•å‘é‡</span>
                <i><span>âˆš</span></i>
              </label>
            </li>
            <li>
                <input type="checkbox" id="moonNodesSwitch" checked hidden>
                <label for="moonNodesSwitch" class="texture-label">
                  <span>æ˜¾ç¤ºé»„ç™½äº¤ç‚¹</span>
                  <i><span>âˆš</span></i>
                </label>
            </li>
          </ul>
        </div>
        <hr>
        <!-- æ§åˆ¶å—ï¼šæ—¥æœˆé£Ÿç”»ä¸­ç”» -->
        <div class="contorl-block" id="PIPSettings">
          <h4>
            <span class="zh">æ—¥æœˆé£Ÿç”»ä¸­ç”»</span>
            <span class="en">Solar/Moon Eclipse PIP</span>
          </h4>
          <ul><li>
            <input type="checkbox" id="PIPSwitch" hidden>
            <label for="PIPSwitch" class="PIP-label">
              <h5>ç”»ä¸­ç”»å¼€å…³</h5>
              <i></i>
            </label>
          </li></ul>
        </div>
      </div>
      <!-- æ ‡ç­¾é¡µ3ï¼šå‚æ•°è°ƒæ•´ -->
      <div class="panel" id="page3">
        <!-- æ§åˆ¶å—ï¼šé€Ÿåº¦æ§åˆ¶ -->
        <div class="contorl-block" id="speedSettings">
          <h4>
            <span class="zh">é€Ÿåº¦æ§åˆ¶</span>
            <span class="en">Speed Control</span>
          </h4>
          <ul><li>
            <h5>é€Ÿåº¦è°ƒèŠ‚</h5>
            <input type="range" id="speedInput" min="-7" max="7" step="1" value="1">
            <label for="speedInput" class="speed-label" id="speedLabel">x1</label>
          </li></ul>
          <ul>
            <li>
              <h5>è¿åŠ¨åå‘</h5>
              <input type="checkbox" id="reserveSwitch" hidden>
              <label for="reserveSwitch">
                <i></i>
              </label>
            </li>
            <li>
              <h5>è¿åŠ¨æš‚åœ</h5>
              <input type="checkbox" id="stopSwitch" hidden>
              <label for="stopSwitch">
                <i></i>
              </label>
            </li>
          </ul>
        </div>
        <hr>
        <!-- æ§åˆ¶å—ï¼šæ—¶é—´æ§åˆ¶ -->
        <div class="contorl-block" id="timeSettings">
          <h4>
            <span class="zh">å¿«æ·è·³è½¬</span>
            <span class="en">Quick Jump</span>
          </h4>
          <ul>
            <li>
              <button id="oneYearAgo" onclick="dateJumpBy(-365)">-1å¹´</button>
              <button id="oneMonthAgo" onclick="dateJumpBy(-30)">-1æœˆ</button>
              <button id="oneMonthForward" onclick="dateJumpBy(30)">+1æœˆ</button>
              <button id="oneYearForward" onclick="dateJumpBy(365)">+1å¹´</button>
            </li>
            <li>
              <button id="nextSolarEclipse">ä¸‹ä¸€æ¬¡æ—¥é£Ÿ</button>
              <button id="nextLunarEclipse">ä¸‹ä¸€æ¬¡æœˆé£Ÿ</button>
            </li>
            <li>
              <button id="nextTotalSolarEclipse">ä¸‹ä¸€æ¬¡æ—¥å…¨é£Ÿ</button>
              <button id="nextTotalLunarEclipse">ä¸‹ä¸€æ¬¡æœˆå…¨é£Ÿ</button>
            </li>
            <li>
              <button id="nextPartialSolarEclipse">ä¸‹ä¸€æ¬¡æ—¥åé£Ÿ</button>
              <button id="nextPartialLunarEclipse">ä¸‹ä¸€æ¬¡æœˆåé£Ÿ</button>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </aside>

  <!------ ç”»ä¸­ç”»UIæ¡† ------>
  <div id="pipContainer" style="display: none;">
    <div id="pipHeader">
      <div class="pip-title">
        <i class="fa fa-video-camera"></i>
        <span>æ—¥æœˆé£Ÿè§‚æµ‹</span>
      </div>
      <div class="pip-controls">
        <button class="pip-btn" id="pipMinimize" title="æœ€å°åŒ–">
          <i class="fa fa-minus"></i>
        </button>
        <button class="pip-btn" id="pipClose" title="å…³é—­">
          <i class="fa fa-times"></i>
        </button>
      </div>
    </div>
    <div id="pipContent">
      <div id="pipCanvas">
        <!-- 3Dæœˆç›¸æ¸²æŸ“å®¹å™¨ -->
        <div id="moonPhase3D"></div>
      </div>
      <div id="pipInfo">
        <div class="pip-moon-distance">
          <span class="distance-label">æœˆçƒè·ç¦»</span>
          <select id="pipMoonDistanceSelect">
            <option value="perigee">è¿‘åœ°ç‚¹ (æ˜“å…¨é£Ÿ)</option>
            <option value="average" selected>å¹³å‡è·ç¦»</option>
            <option value="apogee">è¿œåœ°ç‚¹ (æ˜“ç¯é£Ÿ)</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!------ å°å·¥å…·æ¡ ------>
  <nav id="toolBar">
    <button class="tool-btn" id="toolPause" title="æš‚åœ" onclick="clickOnToolPause()">
      <i class="fa fa-pause"></i>
    </button>
    <button class="tool-btn" id="toolSpeed" title="é€Ÿåº¦" onclick="clickOnToolSpeed()">
      <i>x1</i>
    </button>
    <hr>
    <button class="tool-btn" id="toolView" title="åˆ‡æ¢è§†è§’" onclick="clickOnToolView()">
      <i class="fa fa-eye"></i>
    </button>
    <button class="tool-btn" id="toolScreenshot" title="æˆªå›¾" onclick="clickOnToolScreenshot()">
      <i class="fa fa-camera"></i>
    </button>
    <hr>
    <button class="tool-btn" id="toolHelp" title="å¸®åŠ©" onclick="clickOnToolHelp()">
      <i class="fa fa-question"></i>
    </button>
  </nav>

  <div id="modalMask" class="modal">
    <div id="helpWindow">
      <span id="closeWindowBtn" onclick="closeHelpWindow()">&times;</span>
      <div id="helpBody">
        <button id="prevPageBtn">&#60;</button>
        <div id="pagesContainer">
        <!-- æ¯ä¸€é¡µå†…å®¹å•ç‹¬ä¸€ä¸ªdiv -->
          <ul id="helpPages">
            <li id="helpPage0" class="helpPage">
              <h2>å¸®åŠ©æ–‡æ¡£</h2>
              <div class="helpContent"> 
                <p><strong>æ¬¢è¿æ¥åˆ° â€œSolar System Simâ€ ç½‘é¡µ</strong>ï¼</p>
                <p>è¿™æ˜¯ä¸€ä¸ªåŸºäº Three.js åº“æ‰“é€ çš„æ—¥æœˆåœ°è¿åŠ¨ä¸æ—¥é£Ÿã€æœˆé£Ÿåœ¨çº¿æ¨¡æ‹Ÿæ¼”ç¤ºå·¥å…·.</p>
                <p>
                  æœ¬å·¥å…·æ—¨åœ¨ä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªç›´è§‚æ˜“ç”¨çš„å¹³å°ï¼Œä»¥ 3D è§†è§’åŠ¨æ€åœ°è§‚å¯Ÿï¼š<br>
                  &emsp;- åœ°çƒã€æœˆçƒå’Œå¤ªé˜³ä¹‹é—´çš„è¿è¡Œè½¨è¿¹;<br>
                  &emsp;- å¤©ä½“çš„è‡ªè½¬ã€å…¬è½¬ã€è½¨é“è¿›åŠ¨ç­‰åŠ¨æ€å…³ç³»;<br>
                  &emsp;- æ—¥é£Ÿã€æœˆé£Ÿç­‰å¤©è±¡çš„å‘¨æœŸå˜åŒ–.
                </p>
                <p>é¡µé¢æä¾›äº†å°½å¯èƒ½å…¨é¢çš„åŠŸèƒ½å’Œç®€ä¾¿æ˜“ç”¨çš„æ“ä½œæ–¹å¼ï¼Œä»¥æœŸè®©ç”¨æˆ·æ›´å¥½çš„ä¸“æ³¨äºæ¢ç´¢å’Œç†è§£å¤©æ–‡ç°è±¡ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•ä½¿ç”¨è¯¥ç½‘é¡µçš„ç®€è¦æŒ‡å—</p>
              </div>
            </li>
            <li id="helpPage1" class="helpPage">
              <h2>ç•Œé¢</h2>
              <div class="helpContent">
                <p>Solar System Sim ç½‘é¡µç•Œé¢ä¸»è¦åŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š</p>
                <ul>
                  <li><strong>æ˜¾ç¤ºåŒºï¼š</strong>æ˜¯ä¸»è¦çš„å¯è§†åŒ–åœºæ™¯ï¼Œå±•ç°åœ°çƒã€æœˆçƒå’Œå¤ªé˜³çš„ç›¸å¯¹è¿åŠ¨åŠç›¸å…³å¤©è±¡ï¼›</li>
                  <li><strong>æ§åˆ¶é¢æ¿ï¼š</strong>é¡µé¢å·¦ä¾§è¾¹æ ï¼Œé€šè¿‡æŒ‰é’®å‘¼å‡ºæˆ–éšè—ï¼Œæä¾›äº†åŸºæœ¬ä¿¡æ¯ã€è§†å›¾åˆ‡æ¢ã€å‚æ•°è°ƒæ•´ã€è¾…åŠ©å·¥å…·ç­‰å†…å®¹;</li>
                  <li><strong>å°å·¥å…·æ¡ï¼š</strong>æ‚¬æµ®äºé¡µé¢å³ä¸‹è§’ï¼Œé›†åˆæš‚åœã€é€Ÿåº¦è°ƒèŠ‚ã€è§†è§’åˆ‡æ¢ã€æˆªå›¾ã€å¸®åŠ©ç­‰å¸¸ç”¨åŠŸèƒ½ï¼›</li>
                  <li><strong>ä»ªè¡¨ç›˜ï¼š</strong>ä½äºé¡µé¢å³ä¸Šè§’ï¼Œå®æ—¶æ˜¾ç¤ºå½“å‰æ—¥æœŸã€é€Ÿåº¦å’Œå¤©è±¡è¿›ç¨‹ç­‰çŠ¶æ€ï¼Œå¸®åŠ©ç”¨æˆ·æŠŠæ¡æ¨¡æ‹Ÿè¿›ç¨‹ä¸å…³é”®æ•°æ®;</li>
                  <li><strong>ç”»ä¸­ç”»æ¡†ï¼š</strong>é€šè¿‡æ§åˆ¶é¢æ¿æ‰“å¼€ï¼Œæ›´è¯¦ç»†çš„å±•ç¤ºæ—¥æœˆé£Ÿç­‰å¤©è±¡çš„2Dç»†èŠ‚.</li>
                </ul>
             </div>
            </li>
            <li id="helpPage2" class="helpPage">
              <h2>è§†è§’æ§åˆ¶</h2>
              <div class="helpContent">
                <p>Solar System Sim æ”¯æŒä¸‰ç§ä¸»è¦è§†è§’ï¼š
                <p>
                  &emsp;- <strong>æ­£è§†å›¾ï¼š</strong>ä¿¯è§†å¤ªé˜³ç³»å¹³é¢<br>
                  &emsp;- <strong>ä¾§è§†å›¾ï¼š</strong>å¹³è¡Œäºé»„é“è§‚å¯Ÿ<br>
                  &emsp;- <strong>3Dè§†å›¾ï¼š</strong>æ²‰æµ¸å¼ç«‹ä½“æ¨¡æ‹Ÿ
                </p>
                </p>
                <p>ç”¨æˆ·å¯ä»¥åœ¨<strong>æ§åˆ¶é¢æ¿</strong>ä¸­çš„è§†å›¾é¡µè‡ªç”±é€‰æ‹©ï¼Œä¹Ÿå¯é€šè¿‡<strong>å°å·¥å…·æ¡</strong>ä¸­çš„æ§ä»¶å¿«é€Ÿåˆ‡æ¢.</p>
                <p>åœ¨3Dè§†å›¾ä¸‹ï¼Œå¯ä»¥æŒ‰ä½å·¦é”®æ‹–åŠ¨ä»¥æ—‹è½¬è§†è§’ï¼Œæ»šåŠ¨æ»šè½®ä»¥ç¼©æ”¾ç”»é¢ï¼Œå®æ—¶è°ƒæ•´ç›¸æœºä½ç½®.</p>
              </div>
            </li>
            <li id="helpPage3" class="helpPage">
              <h2>æ—¥æœˆé£Ÿç”»ä¸­ç”»</h2>
              <div class="helpContent">
                <p>Solar System Sim æä¾›äº†ç”»ä¸­ç”»åŠŸèƒ½ï¼Œç”¨äºæ›´æ¸…æ™°çš„å±•ç¤º<strong>æœˆç›¸å˜åŒ–ã€æ—¥é£Ÿå’Œæœˆé£Ÿ</strong>çš„å‘ç”Ÿè¿‡ç¨‹.</p>
                <p>ä¸»æ˜¾ç¤ºåŒºçš„æ¨¡æ‹Ÿå·²ç»è¡¨ç°äº†çœŸå®çš„å¤©ä½“è‡ªè½¬ã€å…¬è½¬æ¯”ä¾‹ï¼Œè€ƒè™‘äº†ç™½é“éšæ²™ç½—å‘¨æœŸçš„è¿›åŠ¨ï¼Œæ¸²æŸ“äº†æ­£ç¡®çš„å…‰å½±æŠ•å°„å…³ç³».</p>
                <p>é€šè¿‡æ§åˆ¶é¢æ¿ä¸­çš„å¼€å…³å¯ä»¥æ‰“å¼€ç”»ä¸­ç”»å°çª—å£ï¼Œå…¶ä¸­å°†åŒæ­¥ä¸»æ˜¾ç¤ºåŒºæœˆç›¸ç›ˆäºã€å’Œæ—¥æœˆé£ŸçŠ¶æ€ï¼ˆæ¶µç›–å…¨é£Ÿã€åé£Ÿã€ç¯é£Ÿï¼‰ï¼Œæ›´è¿›ä¸€æ­¥çš„å±•ç¤ºå…‰çº¿å˜åŒ–å’Œé˜´å½±é®æŒ¡æ•ˆæœã€‚ç”»ä¸­ç”»è¿˜æä¾›æœˆçƒè·ç¦»è°ƒèŠ‚åŠŸèƒ½ï¼Œå¯ä»¥é€‰æ‹©è¿‘åœ°ç‚¹ã€è¿œåœ°ç‚¹æˆ–å¹³å‡è·ç¦»ï¼ŒåŠ¨æ€å±•ç¤ºä¸åŒè·ç¦»ä¸‹çš„æ—¥å…¨é£Ÿå’Œæ—¥ç¯é£Ÿæ•ˆæœï¼Œä»è€Œå¸®åŠ©ç”¨æˆ·ç†è§£è¿™äº›å¤æ‚ç°è±¡çš„å½¢æˆæœºåˆ¶.</p>
                <p>è€ƒè™‘åˆ°æ—¥æœˆé£Ÿå¤©è±¡é¢‘æ¬¡å°ã€æ—¶é—´çŸ­ï¼Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿï¼Œåœ¨æ§åˆ¶é¢æ¿å‚æ•°é¡µä¹Ÿæä¾›äº†å¿«é€Ÿè·³è½¬åˆ°æŒ‡å®šå¤©è±¡çš„åŠŸèƒ½ã€‚</p>
              </div>
            </li>
            <li id="helpPage4" class="helpPage">
              <h2>è¿åŠ¨è°ƒèŠ‚</h2>
              <div class="helpContent">
                <p>Solar System Sim æ”¯æŒçµæ´»çš„<strong>é€Ÿåº¦è°ƒèŠ‚</strong>ä¸<strong>å¿«é€Ÿè·³è½¬</strong>åŠŸèƒ½.</p>
                <p>
                  ä»ªè¡¨ç›˜ä¼šæ˜¾ç¤ºå½“å‰é€Ÿåº¦æ¯”ä¾‹å’Œå¤©è±¡è¿›ç¨‹ç­‰åŸºæœ¬çŠ¶æ€ä¿¡æ¯
                </p>
                <p>
                  é€šè¿‡æ§åˆ¶é¢æ¿ä¸Šçš„æ§ä»¶ï¼Œå¯ä»¥æ–¹ä¾¿çš„è°ƒèŠ‚æ¨¡æ‹Ÿè¿‡ç¨‹çš„é€Ÿåº¦ã€è¿›è¡Œæš‚åœå’Œå€’é€€ï¼ˆå°å·¥å…·æ¡ä¹Ÿæä¾›äº†æš‚åœå’Œé€Ÿåº¦è°ƒæ•´çš„å¿«æ·æŒ‰é’®ï¼‰ã€å¿«æ·è·³è½¬åˆ°æŒ‡å®šæ—¥æœŸæˆ–æŒ‡å®šå¤©è±¡ã€‚
                </p>
                <p>
                  æ— è®ºæ˜¯æƒ³é™æ­¢åˆ†ææŸä¸€æ—¶åˆ»çš„å¤©ä½“ä½ç½®ï¼Œè¿˜æ˜¯è¿ç»­è§‚å¯Ÿä¸€å¹´é—´æœˆç›¸å˜åŒ–ï¼Œéƒ½èƒ½è‡ªç”±åˆ‡æ¢ã€‚æ‰€æœ‰æ“ä½œä¹‹é—´ç›¸äº’å…¼å®¹ï¼Œæ•ˆæœå®æ—¶åé¦ˆåœ¨æ˜¾ç¤ºåŒºå’Œä»ªè¡¨ç›˜ï¼Œç¡®ä¿æ•°æ®å‡†ç¡®ã€æ“ä½œæµç•…
                </p>
              </div>
            </li>
            <li id="helpPage5" class="helpPage">
              <h2>å…¶ä»–åŠŸèƒ½</h2>
              <div class="helpContent">
                <ul>
                  <li><strong>æˆªå›¾ï¼š</strong>åœ¨å°å·¥å…·æ¡ä¸­ï¼Œä¸€é”®ä¿å­˜å¹¶ä¸‹è½½å½“å‰æ¨¡æ‹Ÿç”»é¢</li>
                  <li><strong>è´´å›¾åˆ‡æ¢ï¼š</strong>å…è®¸éšæ—¶ä¸ºå¤ªé˜³ã€åœ°çƒé€‰æ‹©ä¸åŒçš„å¤–è§‚è´´å›¾ï¼Œæˆ–ä¿®æ”¹å®‡å®™èƒŒæ™¯</li>
                  <li><strong>è¾…åŠ©æ˜¾ç¤ºï¼š</strong>å¯ä»¥æ‰“å¼€è‡ªè½¬è½´ã€è½¨é“é¢æ³•å‘é‡ã€é»„ç™½äº¤ç‚¹ç­‰è§†è§‰è¾…åŠ©ï¼Œæ›´ç²¾ç»†çš„è§‚å¯Ÿäº¤è§’åŠå…¶å˜åŒ–</li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
        <button id="nextPageBtn">&#62;</button>
      </div>
      <nav id="pageSwitcher">
        <ul>
          <li><button class="dot active" onclick="jumpToHelpPage(0)"></button></li>
          <li><button class="dot" onclick="jumpToHelpPage(1)"></button></li>
          <li><button class="dot" onclick="jumpToHelpPage(2)"></button></li>
          <li><button class="dot" onclick="jumpToHelpPage(3)"></button></li>
          <li><button class="dot" onclick="jumpToHelpPage(4)"></button></li>
          <li><button class="dot" onclick="jumpToHelpPage(5)"></button></li>
        </ul>
      </nav>
    </div>

  <!--------------------------------------------->
  <!------------ ä¸‹é¢æ˜¯JavaScriptä»£ç  ------------>
  <!--------------------------------------------->
  <script src="js/three.min.js"></script>
  <script>
    /* * * * * * * * * *
     * é‡è¦å…¨å±€å˜é‡å®šä¹‰
     * * * * * * * * * */
    // å…¬å…±å˜é‡ï¼šæ§ä»¶
    const controlBtn = document.getElementById('controlBtn');
    const controlPanel = document.getElementById('controlPanel');
    const tabs = document.querySelectorAll('#tabs .tab');
    const panels = document.querySelectorAll('#panels .panel');
    const earthTextureRadios = document.querySelectorAll('#earthTexture input');
    const sunTextureRadios = document.querySelectorAll('#sunTexture input');
    const starlandRadios = document.querySelectorAll('#starland input');
    const axisSwitch = document.getElementById('axisSwitch');
    const moonNormalSwitch = document.getElementById('moonNormalSwitch');
    const moonNodesSwitch = document.getElementById('moonNodesSwitch');
    const speedInput = document.getElementById('speedInput');
    const speedLabel = document.getElementById('speedLabel');
    const reserveSwitch = document.getElementById('reserveSwitch');
    const stopSwitch = document.getElementById('stopSwitch');
    const dashboardSpeed = document.getElementById('db-speed');
    const dashboardSaros = document.getElementById('db-saros');
    const dashboardMoonPhase = document.getElementById('db-moonphase');
    const dashboardAlignment = document.getElementById('db-alignment');
    const toolPause = document.getElementById('toolPause');
    const toolSpeed = document.getElementById('toolSpeed');
    const pipContainer = document.getElementById('pipContainer');
    const pipMinimize = document.getElementById('pipMinimize');
    const pipClose = document.getElementById('pipClose');
    const PIPSwitch = document.getElementById('PIPSwitch');
    
    // Bannerç®¡ç†å˜é‡
    let currentBannerTimer = null;
    let currentProgressTimer = null;
    let activeBanner = null;
    const prevPageBtn = document.getElementById('prevPageBtn');
    const nextPageBtn = document.getElementById('nextPageBtn');
    const helpModal = document.getElementById('modalMask');
    const helpPages = document.getElementById('helpPages');
    const pageSwitcherDots = document.querySelectorAll('#pageSwitcher .dot');
    let currentHelpPage = 0; // å½“å‰å¸®åŠ©é¡µé¢ç´¢å¼•

    // 3Dæœˆç›¸ç›¸å…³å˜é‡
    let pipScene = null;
    let pipCamera = null;
    let pipRenderer = null;
    let pip3DMoon = null;
    let pipSunLight = null;
    let pipAmbientLight = null;
    let pipViewLight = null; // è§†è§’æ–¹å‘è¡¥å…‰
    let lastPhaseAngle = 0;
    let lastIllumination = 0;
    let phaseTransitionSpeed = 0.02; // é™ä½è¿‡æ¸¡é€Ÿåº¦ï¼Œä½¿å˜åŒ–æ›´å¹³æ»‘
    let lastSunLightPosition = { x: 5, y: 0, z: 0 }; // è®°å½•ä¸Šæ¬¡å…‰æºä½ç½®
    let isControlPanelOpen = false;
    let mouseDragging = false;
    let isPipMinimized = false;
    let isPipVisible = false;
    let isEclipseMode = false;  // æ˜¯å¦ä¸ºæ—¥é£Ÿ/æœˆé£Ÿæ¨¡å¼
    let eclipse2DCanvas = null;  // 2Dæ—¥é£Ÿ/æœˆé£ŸCanvas
    let eclipse2DCtx = null;     // 2Dç»˜å›¾ä¸Šä¸‹æ–‡
    let eclipseAnimationId = null; // åŠ¨ç”»ID
    let cachedStars = null; // ç¼“å­˜çš„æ˜Ÿæ˜Ÿä½ç½®
    let currentEclipseInfo = null; // å­˜å‚¨å½“å‰æ—¥é£Ÿ/æœˆé£Ÿçš„ç±»å‹ä¿¡æ¯ï¼Œç¡®ä¿æ•´ä¸ªè¿‡ç¨‹ä¿æŒä¸€è‡´
    // ç»Ÿä¸€çš„å…¨é£Ÿ/åé£Ÿåˆ¤æ–­æ ‡å‡†
    const ECLIPSE_THRESHOLDS = {
      TOTAL: 0.105,    // çº¦6åº¦ - å…¨é£Ÿé˜ˆå€¼ï¼ˆè°ƒæ•´ä¸ºæ›´åˆç†çš„èŒƒå›´ï¼‰
      PARTIAL: 0.26,   // çº¦15åº¦ - åé£Ÿé˜ˆå€¼
      ALIGNMENT: 70    // å¯¹é½ç¨‹åº¦é˜ˆå€¼
    };

    /**
     * ç»Ÿä¸€çš„æœˆé£Ÿ/æ—¥é£Ÿç±»å‹åˆ¤æ–­å‡½æ•°
     * ç¡®ä¿æ‰€æœ‰åœ°æ–¹ä½¿ç”¨å®Œå…¨ç›¸åŒçš„æ ‡å‡†
     */
    function determineEclipseTypeUnified(minDistanceFromNode) {
      if (minDistanceFromNode < ECLIPSE_THRESHOLDS.TOTAL) {
        return 'total';
      } else if (minDistanceFromNode < ECLIPSE_THRESHOLDS.PARTIAL) {
        return 'partial';
      } else {
        return 'none';
      }
    }

    // å…¬å…±å˜é‡ï¼šå¤©ä½“å’Œè¿åŠ¨å‚æ•°
    const frameRate = 60; //åŠ¨ç”»å¸§æ•°
    const sunRotateAnglePerDay = 0.228729; //å¤ªé˜³æ¯å¤©è‡ªè½¬çš„è§’åº¦
    const earthRevolveAnglePerDay = 0.017202; //åœ°çƒæ¯å¤©å…¬è½¬çš„è§’åº¦ï¼ˆå¼§åº¦ï¼‰
    const earthRotateAnglePerDay = 6.283185; //åœ°çƒæ¯å¤©è‡ªè½¬çš„è§’åº¦
    const moonRevolveAnglePerDay = 0.213707; // è¡¥å¿è¿›åŠ¨å½±å“åçš„æœˆçƒå…¬è½¬è§’é€Ÿåº¦ï¼Œä¿æŒæœ”æœ›æœˆ29.53å¤©å‘¨æœŸ
    const moonRotateAnglePerDay = 0.229985; //æœˆçƒæ¯å¤©è‡ªè½¬çš„è§’åº¦
    // æœˆçƒè½¨é“è¿›åŠ¨ï¼š2Ï€ / (18.6å¹´ Ã— 365.25å¤©) = 2Ï€ / 6793å¤© â‰ˆ 0.000924
    const moonOrbitPrecessionPerDay = -0.000924; //æœˆçƒè½¨é“è¿›åŠ¨è§’é€Ÿåº¦ï¼ˆçº¦18.6å¹´ä¸€å‘¨æœŸï¼Œé€†è¡Œï¼‰
    const dateOrigin = new Date(2022, 11, 8); //æ—¥æœŸåŸç‚¹ï¼ˆæ—¥åœ°æœˆå…±çº¿ï¼Œæœˆçƒé»„çº¬çº¦ä¸º0ï¼‰
    let dateCurrent = new Date(dateOrigin); //å½“å‰æ—¥æœŸ
    let days = 0;             //ç»å†å¤©æ•°ï¼ˆå½“å‰æ—¥æœŸä¸åŸç‚¹ç›¸å·®å¤©æ•°ï¼‰
    const sarosCurrent = 6585.32; //æ²™ç½—å‘¨æœŸï¼š6585.32å¤©
    let speedFactor = 1;      //é€Ÿåº¦å› å­
    let isPaused = false;     //æš‚åœ
    let isbackwards = false;  //å€’é€€
    //è§†è§’ç›¸å…³å‚æ•°
    let isViewLocked = false; //æ˜¯å¦æ˜¯3Dè§†è§’
    let targetAzimuth = 0;     // æ°´å¹³è§’
    let targetElevation = 0;   // å‚ç›´è§’
    let targetRadius = 10;    // è·ç¦»
    let startMouseX = 0;
    let startMouseY = 0;
    let startAzimuth = 0;
    let startElevation = 0;
    let mouseOnPanel = false;
    // å…¬å…±å˜é‡ï¼šåœºæ™¯ã€ç›¸æœºã€æ¸²æŸ“å™¨ã€çº¹ç†
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 10;
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);
    let rendererLock = false;    //æ¸²æŸ“å™¨é”
    const textureLoader = new THREE.TextureLoader();
    const sunTextureTrue = textureLoader.load('https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/sun.jpg');
    const sunTextureOrange = textureLoader.load('https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/orange.jpg');
    const earthTextureSatellite = textureLoader.load('https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/earth-sate.jpg');
    const earthTextureCommon = textureLoader.load("https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/earth-common.png");
    const earthTextureBlue = textureLoader.load("https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/transparent.png");
    const moonTexture = textureLoader.load("https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/moon.png");


    /* * * * * * * * * *
     * 3Dåœºæ™¯åˆå§‹åŒ–
     * å±‚æ¬¡ç»“æ„è¯´æ˜ï¼š
     * scene
     * â”œâ”€â”€ sun (å¤ªé˜³ï¼šè‡ªè½¬)
     * â”œâ”€â”€ earthOrbit (åœ°çƒè½¨é“ï¼šç»•å¤ªé˜³å…¬è½¬)
     * â”‚   â””â”€â”€ earthGroup (åœ°çƒæ•´ä½“ç»„åˆï¼Œä½äºè½¨é“ä¸Š)
     * â”‚       â”œâ”€â”€ earthRotationGroup (åœ°çƒè‡ªè½¬ç»„ï¼šåªåŒ…å«åœ°çƒçƒä½“)
     * â”‚       â”‚   â””â”€â”€ earthSphere (åœ°çƒçƒä½“ï¼šè·Ÿéšåœ°çƒè‡ªè½¬)
     * â”‚       â”œâ”€â”€ moonOrbitGroup (æœˆçƒè½¨é“ç»„ï¼šç›¸å¯¹é»„é“é¢å€¾æ–œ5.15Â°ï¼ŒZè½´å€¾æ–œ)
     * â”‚       â”‚   â””â”€â”€ moonOrbit (æœˆçƒè½¨é“ï¼šç»•åœ°çƒå…¬è½¬)
     * â”‚       â”‚       â””â”€â”€ moon (æœˆçƒï¼šæ½®æ±é”å®šï¼Œä¸€é¢æœåœ°çƒ)
     * â”‚       â””â”€â”€ earthAxisGroup (åœ°è½´ç»„ï¼šå€¾æ–œ23.5Â°ï¼ŒZè½´å€¾æ–œï¼Œä¸è‡ªè½¬)
     * â”‚           â”œâ”€â”€ earthAxis (åœ°è½´çº¿)
     * â”‚           â”œâ”€â”€ northArrow (åŒ—æç®­å¤´)
     * â”‚           â””â”€â”€ southArrow (å—æç®­å¤´)
     * â”œâ”€â”€ earthOrbitRing (åœ°çƒè½¨é“ç¯)
     * â””â”€â”€ starfield (æ˜Ÿç©ºèƒŒæ™¯)
     * 
     * å€¾æ–œæ–¹å‘è¯´æ˜ï¼š
     * - åœ°è½´å€¾æ–œ23.5Â°ï¼ŒZè½´æ­£æ–¹å‘å€¾æ–œ(å¤è‡³æ—¶åŒ—ææœå‘å¤ªé˜³)
     * - æœˆçƒè½¨é“å€¾æ–œ-5.15Â°ï¼ŒZè½´è´Ÿæ–¹å‘ï¼Œä¸åœ°è½´å€¾æ–œæ–¹å‘ç›¸å¯¹
     * - è¿™ç§ç›¸å¯¹å€¾æ–œä½¿å¾—æœˆçƒè½¨é“ä¸é»„é“é¢æœ‰äº¤ç‚¹ï¼Œæ˜¯æ—¥æœˆé£Ÿå‘ç”Ÿçš„å…³é”®
     * * * * * * * * * */
    // è®¾ç½®èƒŒæ™¯
    scene.background = new THREE.Color(0x0d0f13);

    // åˆ›å»ºå¤ªé˜³
    const sunGeometry = new THREE.SphereGeometry(2, 32, 32);
    const sunMaterial = new THREE.MeshLambertMaterial({
      map: sunTextureTrue,
      color: 0xfcf083,
      emissive: 0xfcf083,
      emissiveMap: sunTextureTrue,
      emissiveIntensity: 0.8
    });
    const sun = new THREE.Mesh(sunGeometry, sunMaterial);
    scene.add(sun);

    // å…‰æºï¼šå¤ªé˜³å…‰å’Œç¯å¢ƒå…‰
    const sunLight = new THREE.PointLight(0xffffff, 100, 1000);
    sunLight.position.set(0, 0, 0);
    sunLight.castShadow = true;
    sunLight.shadow.mapSize.width = 2048;
    sunLight.shadow.mapSize.height = 2048;
    scene.add(sunLight);
    const ambientLight = new THREE.AmbientLight(0x101010, 30);
    scene.add(ambientLight);

    // åˆ›å»ºåœ°çƒæœ¬ä½“ï¼ˆåªåŒ…å«çƒä½“ï¼Œä¸åŒ…å«åœ°è½´ï¼‰
    const earthGeometry = new THREE.SphereGeometry(0.5, 32, 32);
    const earthMaterial = new THREE.MeshPhongMaterial({ 
      color: 0xcfe3fc,
      shininess: 30,
      map: earthTextureSatellite,
    });
    earthMaterial.needUpdate = true;
    const earthSphere = new THREE.Mesh(earthGeometry, earthMaterial);
    earthSphere.castShadow = true;
    earthSphere.receiveShadow = true;

    // åˆ›å»ºåœ°çƒè‡ªè½¬ç»„ï¼ˆåªåŒ…å«åœ°çƒçƒä½“ï¼‰
    const earthRotationGroup = new THREE.Object3D();
    earthRotationGroup.add(earthSphere);

    // åˆ›å»ºæœˆçƒ
    const moonGeometry = new THREE.SphereGeometry(0.15, 16, 16);
    const moonMaterial = new THREE.MeshPhongMaterial({ 
      color: 0xcccccc,
      map: moonTexture,
      shininess: 10
    });
    const moon = new THREE.Mesh(moonGeometry, moonMaterial);
    moon.castShadow = true;
    moon.receiveShadow = true;

    // æœˆçƒè½¨é“ç»„ï¼ˆç»•åœ°çƒå…¬è½¬ï¼‰
    const moonOrbit = new THREE.Object3D();
    moonOrbit.add(moon);
    moon.position.x = 1.2;

    // æœˆçƒè½¨é“å€¾æ–œç»„ï¼ˆç›¸å¯¹é»„é“é¢å€¾æ–œ5.15Â°ï¼‰
    const moonOrbitGroup = new THREE.Object3D();
    moonOrbitGroup.add(moonOrbit);
    // æœˆçƒè½¨é“ç›¸å¯¹é»„é“é¢å€¾æ–œ5.15åº¦ï¼Œå€¾æ–œæ–¹å‘ä¸åœ°è½´ç›¸å…³
    // ä½¿ç”¨Zè½´è´Ÿæ–¹å‘å€¾æ–œï¼Œä¸åœ°è½´å€¾æ–œæ–¹å‘ç›¸å¯¹
    moonOrbitGroup.rotation.z = THREE.MathUtils.degToRad(-5.15);
    
    // æ³¨æ„ï¼šæœˆçƒè½¨é“çš„è¿›åŠ¨
    // 1. moonOrbit.rotation.y æ§åˆ¶æœˆçƒç»•åœ°çƒçš„å…¬è½¬ï¼ˆçº¦27.3å¤©ä¸€å‘¨æœŸï¼‰
    // 2. moonOrbitGroup.rotation.y æ§åˆ¶æœˆçƒè½¨é“é¢çš„è¿›åŠ¨ï¼ˆçº¦18.6å¹´ä¸€å‘¨æœŸï¼‰
    // 3. æœˆçƒè½¨é“å¹³é¢ç›¸å¯¹äºé»„é“é¢å€¾æ–œçº¦5.15åº¦ï¼Œå€¾æ–œæ–¹å‘ä¸åœ°è½´ç›¸å¯¹
    // 4. æœˆçƒè½¨é“å¹³é¢çš„æ–¹å‘ä¼šç¼“æ…¢è¿›åŠ¨ï¼Œäº¤ç‚¹çº¿åœ¨é»„é“é¢ä¸Šæ—‹è½¬

    // åˆ›å»ºæœˆçƒè½¨é“æ³•å‘é‡ï¼ˆæ˜¾ç¤ºè½¨é“é¢çš„æ³•çº¿æ–¹å‘ï¼‰
    const moonOrbitNormalGeometry = new THREE.CylinderGeometry(0.01, 0.01, 1.5, 8);
    const moonOrbitNormalMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff0088,
      transparent: true,
      opacity: 1.0
    });
    const moonOrbitNormal = new THREE.Mesh(moonOrbitNormalGeometry, moonOrbitNormalMaterial);

    // åˆ›å»ºæ³•å‘é‡ç®­å¤´ï¼ˆæ­£æ–¹å‘ï¼‰
    const normalArrowGeometry = new THREE.ConeGeometry(0.03, 0.12, 8);
    const normalArrowMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff0088,
      transparent: true,
      opacity: 1.0
    });
    const normalArrowUp = new THREE.Mesh(normalArrowGeometry, normalArrowMaterial);
    normalArrowUp.position.set(0, 0.81, 0);

    // åˆ›å»ºæ³•å‘é‡ç®­å¤´ï¼ˆè´Ÿæ–¹å‘ï¼‰
    const normalArrowDown = new THREE.Mesh(normalArrowGeometry, normalArrowMaterial);
    normalArrowDown.position.set(0, -0.81, 0);
    normalArrowDown.rotation.x = Math.PI;

    // æœˆçƒè½¨é“æ³•å‘é‡ç»„ï¼ˆä½äºè½¨é“ä¸­å¿ƒï¼Œå‚ç›´äºè½¨é“å¹³é¢ï¼‰
    const moonOrbitNormalGroup = new THREE.Object3D();
    moonOrbitNormalGroup.add(moonOrbitNormal);
    moonOrbitNormalGroup.add(normalArrowUp);
    moonOrbitNormalGroup.add(normalArrowDown);
    
    // å°†æ³•å‘é‡æ·»åŠ åˆ°æœˆçƒè½¨é“ç»„ä¸­ï¼Œè¿™æ ·å®ƒä¼šè·Ÿéšè½¨é“å€¾æ–œå’Œè¿›åŠ¨
    moonOrbitGroup.add(moonOrbitNormalGroup);

    // åˆ›å»ºé»„ç™½äº¤ç‚¹æ ‡è®°ï¼ˆæœˆçƒè½¨é“ä¸é»„é“é¢çš„äº¤ç‚¹ï¼‰
    // å‡äº¤ç‚¹ï¼ˆä»é»„é“é¢ä¸‹æ–¹ç©¿è¿‡åˆ°ä¸Šæ–¹ï¼‰
    const ascendingNodeGeometry = new THREE.SphereGeometry(0.08, 16, 16);
    const ascendingNodeMaterial = new THREE.MeshBasicMaterial({ 
      color: 0x00ff00,  // ç»¿è‰²è¡¨ç¤ºå‡äº¤ç‚¹
      transparent: true,
      opacity: 0.9
    });
    const ascendingNode = new THREE.Mesh(ascendingNodeGeometry, ascendingNodeMaterial);
    
    // é™äº¤ç‚¹ï¼ˆä»é»„é“é¢ä¸Šæ–¹ç©¿è¿‡åˆ°ä¸‹æ–¹ï¼‰
    const descendingNodeGeometry = new THREE.SphereGeometry(0.08, 16, 16);
    const descendingNodeMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff0000,  // çº¢è‰²è¡¨ç¤ºé™äº¤ç‚¹
      transparent: true,
      opacity: 0.9
    });
    const descendingNode = new THREE.Mesh(descendingNodeGeometry, descendingNodeMaterial);
    
    // é»„ç™½äº¤ç‚¹ä½äºæœˆçƒè½¨é“ä¸Šï¼Œè·ç¦»åœ°çƒ1.2ä¸ªå•ä½
    // è€ƒè™‘åˆ°è½¨é“å€¾æ–œçš„å‡ ä½•å…³ç³»ï¼Œäº¤ç‚¹åº”è¯¥åœ¨zè½´æ–¹å‘
    // ç”±äºæœˆçƒè½¨é“å€¾æ–œ-5.15Â°ï¼Œå‡äº¤ç‚¹åœ¨Zè´Ÿæ–¹å‘ï¼Œé™äº¤ç‚¹åœ¨Zæ­£æ–¹å‘
    const moonOrbitRadius = 1.2;
    ascendingNode.position.set(0, 0, -moonOrbitRadius);  // å‡äº¤ç‚¹ï¼šä»ä¸‹æ–¹ç©¿è¿‡åˆ°ä¸Šæ–¹
    descendingNode.position.set(0, 0, moonOrbitRadius);   // é™äº¤ç‚¹ï¼šä»ä¸Šæ–¹ç©¿è¿‡åˆ°ä¸‹æ–¹
    
    // å°†äº¤ç‚¹æ·»åŠ åˆ°æœˆçƒè½¨é“ç»„ä¸­ï¼Œè¿™æ ·å®ƒä»¬ä¼šè·Ÿéšè½¨é“å€¾æ–œå’Œè¿›åŠ¨
    moonOrbitGroup.add(ascendingNode);
    moonOrbitGroup.add(descendingNode);
    
    // åˆ›å»ºäº¤ç‚¹æ ‡ç­¾
    const nodeLabels = createNodeLabels();
    moonOrbitGroup.add(nodeLabels.ascending);
    moonOrbitGroup.add(nodeLabels.descending);

    // åˆ›å»ºåœ°è½´ï¼ˆç‹¬ç«‹çš„ç»„ï¼Œä¸è·Ÿéšåœ°çƒè‡ªè½¬ï¼‰
    const axisGeometry = new THREE.CylinderGeometry(0.005, 0.005, 1.5, 8);
    const axisMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff4444,
      transparent: true,
      opacity: 0.8
    });
    const earthAxis = new THREE.Mesh(axisGeometry, axisMaterial);

    // åˆ›å»ºåœ°è½´ç®­å¤´ï¼ˆåŒ—æç«¯ï¼‰
    const arrowGeometry = new THREE.ConeGeometry(0.02, 0.08, 8);
    const arrowMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff4444,
      transparent: true,
      opacity: 0.8
    });
    const northArrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
    northArrow.position.set(0, 0.79, 0);

    // åˆ›å»ºåœ°è½´ç®­å¤´ï¼ˆå—æç«¯ï¼‰
    const southArrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
    southArrow.position.set(0, -0.79, 0);
    southArrow.rotation.x = Math.PI;

    // åœ°è½´ç»„ï¼ˆåŒ…å«è½´çº¿å’Œç®­å¤´ï¼Œæœ‰å€¾æ–œè§’åº¦ä½†ä¸è‡ªè½¬ï¼‰
    const earthAxisGroup = new THREE.Object3D();
    earthAxisGroup.add(earthAxis);
    earthAxisGroup.add(northArrow);
    earthAxisGroup.add(southArrow);
    // åœ°è½´å€¾æ–œ23.5åº¦
    earthAxisGroup.rotation.z = THREE.MathUtils.degToRad(23.5);

    // åœ°çƒæ•´ä½“ç»„ï¼ˆåŒ…å«è‡ªè½¬ç»„ + æœˆçƒè½¨é“ç»„ + åœ°è½´ç»„ï¼‰
    const earthGroup = new THREE.Object3D();
    earthGroup.add(earthRotationGroup);
    earthGroup.add(moonOrbitGroup);
    earthGroup.add(earthAxisGroup);

    // åœ°çƒè½¨é“ç»„ï¼ˆåœ°çƒæ•´ä½“ç»•å¤ªé˜³å…¬è½¬ï¼‰
    const earthOrbit = new THREE.Object3D();
    earthOrbit.add(earthGroup);
    earthGroup.position.x = 5;
    scene.add(earthOrbit);

    // åœ°çƒã€æœˆçƒè½¨é“ç¯æ˜¾ç¤º
    const earthOrbitGeometry = new THREE.RingGeometry(4.8, 5.2, 64);
    const earthOrbitMaterial = new THREE.MeshBasicMaterial({ 
      color: 0x444444, 
      side: THREE.DoubleSide,
      transparent: true,
      opacity: 0.3
    });
    const earthOrbitRing = new THREE.Mesh(earthOrbitGeometry, earthOrbitMaterial);
    earthOrbitRing.rotation.x = -Math.PI / 2;
    scene.add(earthOrbitRing);
    const moonOrbitGeometry = new THREE.RingGeometry(1.1, 1.3, 32);
    const moonOrbitMaterial = new THREE.MeshBasicMaterial({ 
      color: 0x888888, 
      side: THREE.DoubleSide,
      transparent: true,
      opacity: 0.4
    });
    const moonOrbitRing = new THREE.Mesh(moonOrbitGeometry, moonOrbitMaterial);
    moonOrbitRing.rotation.x = -Math.PI / 2;
    // æœˆçƒè½¨é“ç¯ç›¸å¯¹äºæœˆçƒè½¨é“ç»„çš„å€¾æ–œéœ€è¦è€ƒè™‘åˆ°ç»„æœ¬èº«çš„å€¾æ–œ
    moonOrbitGroup.add(moonOrbitRing);

    // åˆ›å»ºäº¤ç‚¹æ ‡ç­¾çš„å‡½æ•°
    function createNodeLabels() {
      // åˆ›å»ºå‡äº¤ç‚¹æ ‡ç­¾
      const canvas1 = document.createElement('canvas');
      canvas1.width = 128;
      canvas1.height = 64;
      const context1 = canvas1.getContext('2d');
      context1.font = '16px Arial';
      context1.fillStyle = '#00ff00';
      context1.textAlign = 'center';
      context1.fillText('å‡äº¤ç‚¹', 64, 32);
      
      const texture1 = new THREE.CanvasTexture(canvas1);
      const material1 = new THREE.SpriteMaterial({ map: texture1 });
      const ascending = new THREE.Sprite(material1);
      ascending.position.set(0, 0.2, -1.2);  // å‡äº¤ç‚¹åœ¨Zè´Ÿæ–¹å‘
      ascending.scale.set(0.5, 0.25, 1);
      
      // åˆ›å»ºé™äº¤ç‚¹æ ‡ç­¾
      const canvas2 = document.createElement('canvas');
      canvas2.width = 128;
      canvas2.height = 64;
      const context2 = canvas2.getContext('2d');
      context2.font = '16px Arial';
      context2.fillStyle = '#ff0000';
      context2.textAlign = 'center';
      context2.fillText('é™äº¤ç‚¹', 64, 32);
      
      const texture2 = new THREE.CanvasTexture(canvas2);
      const material2 = new THREE.SpriteMaterial({ map: texture2 });
      const descending = new THREE.Sprite(material2);
      descending.position.set(0, 0.2, 1.2);   // é™äº¤ç‚¹åœ¨Zæ­£æ–¹å‘
      descending.scale.set(0.5, 0.25, 1);
      
      return { ascending, descending };
    }

    //æ˜Ÿç©º
    const starfield = createStarfield(scene, 2000, 800);
    function createStarfield(scene, count = 10000, radius = 1000) {
      const positions = new Float32Array(count * 3);
      for (let i = 0; i < count; i++) {
          const i3 = i * 3;
          const phi = Math.random() * Math.PI * 2; 
          const theta = Math.random() * Math.PI;   
          positions[i3] = radius * Math.sin(theta) * Math.cos(phi); 
          positions[i3 + 1] = radius * Math.sin(theta) * Math.sin(phi);
          positions[i3 + 2] = radius * Math.cos(theta);
      }
      const geometry = new THREE.BufferGeometry();
      geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const material = new THREE.PointsMaterial({
          color: 0xffffff,
          size: 2, 
          sizeAttenuation: true,
          transparent: true,   
          opacity: 0.8           
      });
      const starfield = new THREE.Points(geometry, material);
      starfield.renderOrder = -100;
      starfield.frustumCulled = false; 
      scene.add(starfield);
      return starfield;
    }

    // é¼ æ ‡æ§åˆ¶
    let mouseX = 0, mouseY = 0;
    let targetX = 0, targetY = 0;
    const windowHalfX = window.innerWidth / 2;
    const windowHalfY = window.innerHeight / 2;
    
    document.addEventListener('mousedown', (event) => {
        mouseDragging = true;
        startMouseX = event.clientX;
        startMouseY = event.clientY;
        startAzimuth = targetAzimuth;
        startElevation = targetElevation;
    })
    document.addEventListener('mouseup', (event) => {
      mouseDragging = false;
    });
    
    document.addEventListener('mousemove', (event) => {
        if (!mouseDragging || isViewLocked || mouseOnPanel) return;

        const dx = event.clientX - startMouseX;
        const dy = event.clientY - startMouseY;

        // è°ƒæ•´çµæ•åº¦
        targetAzimuth = startAzimuth - dx * 0.005;
        targetElevation = startElevation + dy * 0.005;

        // é™åˆ¶ elevationï¼ˆä»°è§’ï¼‰èŒƒå›´
        const maxElevation = Math.PI / 2 - 0.01;
        const minElevation = -Math.PI / 2 + 0.01;
        targetElevation = Math.max(minElevation, Math.min(maxElevation, targetElevation));
    });
    document.addEventListener('wheel', (event) => {
        if(isViewLocked || mouseOnPanel) return;
        const delta = Math.sign(event.deltaY);
        targetRadius += delta * 0.5; // è°ƒæ•´ç¼©æ”¾çµæ•åº¦
        targetRadius = Math.max(3, Math.min(15, targetRadius)); // é™åˆ¶ç¼©æ”¾èŒƒå›´
      })

    /* * * * * * * * * *
     * åŠ¨ç”»æ›´æ–°
     * * * * * * * * * */
    function animate() {
      requestAnimationFrame(animate);
      // è¿åŠ¨å’Œæ—¶é—´æ›´æ–°
      if(!isPaused){     
        var dayDelta = 1 / 60 * speedFactor;
        if(isbackwards) dayDelta = -dayDelta;
        stepSimulation(dayDelta);
      }
        // ç›¸æœºæ§åˆ¶
        if (!isViewLocked) {
            const r = targetRadius; // ç›¸æœºåŠå¾„

            const x = r * Math.cos(targetElevation) * Math.sin(targetAzimuth);
            const y = r * Math.sin(targetElevation);
            const z = r * Math.cos(targetElevation) * Math.cos(targetAzimuth);

            camera.position.set(x, y, z);
            camera.up.set(0, 1, 0);
            camera.lookAt(scene.position);
        }

      if(!rendererLock)  renderer.render(scene, camera);
    }
    
    animate();

    /* * * * * * * * * *
     * 3Dæœˆç›¸æ¸²æŸ“åŠŸèƒ½
     * * * * * * * * * */
    
    /**
     * åˆå§‹åŒ–3Dæœˆç›¸åœºæ™¯
     */
    function init3DMoonPhase() {
      const container = document.getElementById('moonPhase3D');
      if (!container) {
        console.warn('3Dæœˆç›¸å®¹å™¨æœªæ‰¾åˆ°');
        return false;
      }
      
      try {
        // åˆ›å»ºåœºæ™¯
        pipScene = new THREE.Scene();
        // èƒŒæ™¯é¢œè‰²å°†é€šè¿‡ renderer.setClearColor åŠ¨æ€è®¾ç½®
        
        // åˆ›å»ºç›¸æœº
        const containerRect = container.getBoundingClientRect();
        pipCamera = new THREE.PerspectiveCamera(
          50,
          containerRect.width / containerRect.height,
          0.1,
          100
        );
        pipCamera.position.set(0, 0, 3); // åœ°çƒè§†è§’ï¼šä»Zè½´æ­£æ–¹å‘çœ‹æœˆçƒ
        pipCamera.lookAt(0, 0, 0); // æœå‘æœˆçƒä¸­å¿ƒ
        
        // åˆ›å»ºæ¸²æŸ“å™¨
        pipRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        pipRenderer.setSize(containerRect.width, containerRect.height);
        pipRenderer.shadowMap.enabled = true;
        pipRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
        pipRenderer.outputEncoding = THREE.sRGBEncoding;
        pipRenderer.toneMapping = THREE.ACESFilmicToneMapping;
        pipRenderer.toneMappingExposure = 1.2;
        
        container.appendChild(pipRenderer.domElement);
        
        // åˆ›å»º3Dæœˆçƒ
        create3DMoon();
        
        // åˆ›å»ºå…‰ç…§
        create3DLighting();
        
        // èƒŒæ™¯é¢œè‰²å°†æ ¹æ®æœˆç›¸åŠ¨æ€è®¾ç½®ï¼Œä¸åœ¨æ­¤å¤„å›ºå®š
        
        // å¼€å§‹æ¸²æŸ“å¾ªç¯
        start3DMoonAnimation();
        
        // ç›´æ¥ä½¿ç”¨åŒæ­¥æ–¹å¼åˆå§‹åŒ–æœˆç›¸æ˜¾ç¤º
        const syzygyData = calculateSyzygyProgress();
        updatePipMoonPhase(syzygyData);
        
        console.log('3Dæœˆç›¸åœºæ™¯åˆå§‹åŒ–æˆåŠŸ');
        return true;
      } catch (error) {
        console.error('3Dæœˆç›¸åœºæ™¯åˆå§‹åŒ–å¤±è´¥:', error);
        return false;
      }
    }
    
    /**
     * åˆ›å»º3Dæœˆçƒ
     */
    function create3DMoon() {
      // æœˆçƒå‡ ä½•ä½“
      const moonGeometry = new THREE.SphereGeometry(1, 64, 64);
      
      // æœˆçƒæè´¨
      const moonMaterial = new THREE.MeshPhongMaterial({
        color: 0xcccccc,
        shininess: 5,
        transparent: false
      });
      
      // å¦‚æœæœ‰æœˆçƒçº¹ç†ï¼Œä½¿ç”¨çº¹ç†
      if (typeof moonTexture !== 'undefined') {
        moonMaterial.map = moonTexture;
      }
      
      // åˆ›å»ºæœˆçƒmesh
      pip3DMoon = new THREE.Mesh(moonGeometry, moonMaterial);
      pip3DMoon.castShadow = true;
      pip3DMoon.receiveShadow = true;
      
      // æ½®æ±é”å®šï¼šæœˆçƒå§‹ç»ˆä»¥åŒä¸€é¢æœå‘åœ°çƒï¼ˆè§‚å¯Ÿè€…ï¼‰
      // è®¾ç½®åˆå§‹æœå‘ï¼Œç¡®ä¿æœˆçƒè¡¨é¢ç‰¹å¾å§‹ç»ˆé¢å‘è§‚å¯Ÿè€…
      pip3DMoon.rotation.y = 0;
      pip3DMoon.rotation.x = 0;
      pip3DMoon.rotation.z = 0;
      
      // æ·»åŠ æ³•çº¿è´´å›¾æ•ˆæœï¼ˆæ¨¡æ‹Ÿæœˆçƒè¡¨é¢å‡¹å‡¸ï¼‰
      const bumpTexture = createMoonBumpTexture();
      moonMaterial.bumpMap = bumpTexture;
      moonMaterial.bumpScale = 0.1;
      
      pipScene.add(pip3DMoon);
    }
    
    /**
     * åˆ›å»ºæœˆçƒå‡¹å‡¸çº¹ç†
     */
    function createMoonBumpTexture() {
      const canvas = document.createElement('canvas');
      canvas.width = 512;
      canvas.height = 512;
      const ctx = canvas.getContext('2d');
      
      // åˆ›å»ºå™ªå£°çº¹ç†æ¨¡æ‹Ÿæœˆçƒè¡¨é¢
      const imageData = ctx.createImageData(512, 512);
      const data = imageData.data;
      
      for (let i = 0; i < data.length; i += 4) {
        const x = (i / 4) % 512;
        const y = Math.floor((i / 4) / 512);
        
        // ä½¿ç”¨å¤šå±‚å™ªå£°åˆ›å»ºæœˆçƒè¡¨é¢æ•ˆæœ
        let noise = 0;
        noise += Math.sin(x * 0.02) * Math.cos(y * 0.02) * 0.3;
        noise += Math.sin(x * 0.05) * Math.cos(y * 0.05) * 0.2;
        noise += Math.random() * 0.1;
        
        // æ·»åŠ ä¸€äº›"ç¯å½¢å±±"
        const craters = [
          {x: 128, y: 128, radius: 30},
          {x: 300, y: 200, radius: 20},
          {x: 400, y: 350, radius: 25},
          {x: 150, y: 400, radius: 15}
        ];
        
        craters.forEach(crater => {
          const dist = Math.sqrt((x - crater.x) ** 2 + (y - crater.y) ** 2);
          if (dist < crater.radius) {
            noise -= (1 - dist / crater.radius) * 0.3;
          }
        });
        
        const value = Math.max(0, Math.min(255, (noise + 0.5) * 255));
        data[i] = value;     // R
        data[i + 1] = value; // G
        data[i + 2] = value; // B
        data[i + 3] = 255;   // A
      }
      
      ctx.putImageData(imageData, 0, 0);
      
      const texture = new THREE.CanvasTexture(canvas);
      texture.wrapS = THREE.RepeatWrapping;
      texture.wrapT = THREE.RepeatWrapping;
      return texture;
    }
    
    /**
     * åˆ›å»º3Då…‰ç…§ç³»ç»Ÿ
     */
    function create3DLighting() {
      // ä¸»å…‰æºï¼ˆå¤ªé˜³å…‰ï¼‰
      pipSunLight = new THREE.DirectionalLight(0xffffff, 2.5);
      pipSunLight.position.set(5, 0, 0);
      pipSunLight.castShadow = true;
      pipSunLight.shadow.mapSize.width = 1024;
      pipSunLight.shadow.mapSize.height = 1024;
      pipSunLight.shadow.camera.near = 0.1;
      pipSunLight.shadow.camera.far = 10;
      pipSunLight.shadow.camera.left = -2;
      pipSunLight.shadow.camera.right = 2;
      pipSunLight.shadow.camera.top = 2;
      pipSunLight.shadow.camera.bottom = -2;
      pipScene.add(pipSunLight);
      
      // ç¯å¢ƒå…‰ï¼ˆå¾®å¼±ï¼Œæ¨¡æ‹Ÿå®‡å®™ä¸­çš„æ•£å°„å…‰ï¼‰
      pipAmbientLight = new THREE.AmbientLight(0x404060, 0.2); // å¢å¼ºç¯å¢ƒå…‰åˆ°0.2
      pipScene.add(pipAmbientLight);
      
      // æ·»åŠ ä¸€äº›ç‚¹å…‰æºæ¨¡æ‹Ÿåœ°çƒåå°„å…‰
      const earthLight = new THREE.PointLight(0x6699ff, 0.2, 10);
      earthLight.position.set(-3, 1, 2);
      pipScene.add(earthLight);
      
      // æ·»åŠ è§†è§’æ–¹å‘è¡¥å…‰ï¼ˆä»ç›¸æœºæ–¹å‘ç…§äº®æœˆçƒï¼Œç¡®ä¿æ–°æœˆæ—¶ä¹Ÿèƒ½çœ‹åˆ°è½®å»“ï¼‰
      pipViewLight = new THREE.DirectionalLight(0x6080ff, 0.8); // å¢å¼ºäº®åº¦åˆ°0.8ï¼Œæ·¡è“ç™½è‰²
      pipViewLight.position.copy(pipCamera.position); // ä»ç›¸æœºä½ç½®å‘å‡º
      pipViewLight.target.position.set(0, 0, 0); // ç…§å‘æœˆçƒä¸­å¿ƒ
      pipViewLight.castShadow = false; // è¡¥å…‰ä¸äº§ç”Ÿé˜´å½±ï¼Œé¿å…å†²çª
      pipScene.add(pipViewLight);
      pipScene.add(pipViewLight.target);
    }
    
    /**
     * æ ¹æ®æœˆç›¸è®¡ç®—æœ€ä½³è§‚æµ‹æ—¶é—´çš„å¤©ç©ºé¢œè‰² - è‡ªç„¶æ·¡é›…çš„å¤©ç©ºæ¸å˜
     */
    function calculateSkyColor(moonRelativeAngle) {
      // å°†è§’åº¦æ ‡å‡†åŒ–åˆ° [0, 2Ï€] èŒƒå›´
      let normalizedAngle = ((moonRelativeAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
      
      // æ›´è‡ªç„¶ã€æ›´æ·¡é›…çš„å¤©ç©ºé¢œè‰²
      const colors = {
        newMoon: { r: 18, g: 32, b: 47 },        // æ–°æœˆï¼šæ·±è“å¤œç©º
        firstQuarter: { r: 60, g: 50, b: 80 },   // ä¸Šå¼¦æœˆï¼šæ·¡ç´«é»æ˜
        fullMoon: { r: 135, g: 206, b: 235 },   // æ»¡æœˆï¼šç»å…¸å¤©è“è‰²ï¼ˆç™½å¤©ï¼‰
        lastQuarter: { r: 255, g: 165, b: 79 }  // ä¸‹å¼¦æœˆï¼šè‡ªç„¶æ©™è‰²æ™šéœ
      };
      
      // æ·»åŠ ä¸­é—´è¿‡æ¸¡è‰²ï¼Œè®©å¤œæ™šæ—¶é—´æ›´é•¿
      let targetColor;
      
      if (normalizedAngle < Math.PI / 6) {
        // æ–°æœˆåŒºåŸŸï¼šæ·±å¤œè“ï¼ˆæ‰©å¤§å¤œæ™šèŒƒå›´ï¼‰
        targetColor = colors.newMoon;
      } else if (normalizedAngle < Math.PI / 3) {
        // æ·±å¤œåˆ°é»æ˜å‰
        const t = (normalizedAngle - Math.PI / 6) / (Math.PI / 6);
        const smoothT = t * t * (3 - 2 * t); // smoothstep
        targetColor = {
          r: Math.round(colors.newMoon.r + (colors.firstQuarter.r - colors.newMoon.r) * smoothT),
          g: Math.round(colors.newMoon.g + (colors.firstQuarter.g - colors.newMoon.g) * smoothT),
          b: Math.round(colors.newMoon.b + (colors.firstQuarter.b - colors.newMoon.b) * smoothT)
        };
      } else if (normalizedAngle < Math.PI / 2) {
        // é»æ˜åˆ°æœéœ
        const t = (normalizedAngle - Math.PI / 3) / (Math.PI / 6);
        const smoothT = 0.5 * (1 + Math.sin(Math.PI * (t - 0.5))); // æ­£å¼¦ç¼“åŠ¨
        // è¿‡æ¸¡åˆ°æ·¡æœéœè‰²
        const dawnColor = { r: 173, g: 216, b: 230 }; // æ·¡è“æœéœ
        targetColor = {
          r: Math.round(colors.firstQuarter.r + (dawnColor.r - colors.firstQuarter.r) * smoothT),
          g: Math.round(colors.firstQuarter.g + (dawnColor.g - colors.firstQuarter.g) * smoothT),
          b: Math.round(colors.firstQuarter.b + (dawnColor.b - colors.firstQuarter.b) * smoothT)
        };
      } else if (normalizedAngle < 2 * Math.PI / 3) {
        // æœéœåˆ°ç™½å¤©
        const t = (normalizedAngle - Math.PI / 2) / (Math.PI / 6);
        const smoothT = t * t * (3 - 2 * t);
        const dawnColor = { r: 173, g: 216, b: 230 };
        targetColor = {
          r: Math.round(dawnColor.r + (colors.fullMoon.r - dawnColor.r) * smoothT),
          g: Math.round(dawnColor.g + (colors.fullMoon.g - dawnColor.g) * smoothT),
          b: Math.round(dawnColor.b + (colors.fullMoon.b - dawnColor.b) * smoothT)
        };
      } else if (normalizedAngle < 4 * Math.PI / 3) {
        // æ»¡æœˆåŒºåŸŸï¼šæ˜äº®å¤©è“è‰²ï¼ˆç™½å¤©æ—¶é—´ï¼‰
        targetColor = colors.fullMoon;
      } else if (normalizedAngle < 3 * Math.PI / 2) {
        // ç™½å¤©åˆ°é»„æ˜
        const t = (normalizedAngle - 4 * Math.PI / 3) / (Math.PI / 6);
        const smoothT = 0.5 * (1 + Math.sin(Math.PI * (t - 0.5)));
        // è¿‡æ¸¡åˆ°æ¸©æš–çš„é»„æ˜æ©™è‰²
        const goldenColor = { r: 255, g: 193, b: 128 }; // æ¸©æš–æ©™è‰²
        targetColor = {
          r: Math.round(colors.fullMoon.r + (goldenColor.r - colors.fullMoon.r) * smoothT),
          g: Math.round(colors.fullMoon.g + (goldenColor.g - colors.fullMoon.g) * smoothT),
          b: Math.round(colors.fullMoon.b + (goldenColor.b - colors.fullMoon.b) * smoothT)
        };
      } else if (normalizedAngle < 5 * Math.PI / 3) {
        // é»„æ˜åˆ°æ—¥è½
        const t = (normalizedAngle - 3 * Math.PI / 2) / (Math.PI / 6);
        const smoothT = t * t * (3 - 2 * t);
        const goldenColor = { r: 255, g: 193, b: 128 };
        targetColor = {
          r: Math.round(goldenColor.r + (colors.lastQuarter.r - goldenColor.r) * smoothT),
          g: Math.round(goldenColor.g + (colors.lastQuarter.g - goldenColor.g) * smoothT),
          b: Math.round(goldenColor.b + (colors.lastQuarter.b - goldenColor.b) * smoothT)
        };
      } else {
        // æ—¥è½åˆ°æ·±å¤œï¼ˆæ›´é•¿çš„å¤œæ™šè¿‡æ¸¡ï¼‰
        const t = (normalizedAngle - 5 * Math.PI / 3) / (Math.PI / 3);
        const smoothT = 0.5 * (1 + Math.sin(Math.PI * (t - 0.5)));
        targetColor = {
          r: Math.round(colors.lastQuarter.r + (colors.newMoon.r - colors.lastQuarter.r) * smoothT),
          g: Math.round(colors.lastQuarter.g + (colors.newMoon.g - colors.lastQuarter.g) * smoothT),
          b: Math.round(colors.lastQuarter.b + (colors.newMoon.b - colors.lastQuarter.b) * smoothT)
        };
      }
      
      // è½¬æ¢ä¸º16è¿›åˆ¶é¢œè‰²
      const hexColor = (targetColor.r << 16) | (targetColor.g << 8) | targetColor.b;
      
      return hexColor;
    }
    
    /**
     * é¢œè‰²æ’å€¼å‡½æ•°
     */
    function lerpColor(color1, color2, t) {
      const r1 = (color1 >> 16) & 0xff;
      const g1 = (color1 >> 8) & 0xff;
      const b1 = color1 & 0xff;
      
      const r2 = (color2 >> 16) & 0xff;
      const g2 = (color2 >> 8) & 0xff;
      const b2 = color2 & 0xff;
      
      const r = Math.round(r1 + (r2 - r1) * t);
      const g = Math.round(g1 + (g2 - g1) * t);
      const b = Math.round(b1 + (b2 - b1) * t);
      
      return (r << 16) | (g << 8) | b;
    }

    /**
     * åŒæ­¥æ›´æ–°3Dæœˆç›¸å…‰ç…§ï¼ˆç›´æ¥åŒ¹é…å¯¹é½ç¨‹åº¦ï¼Œæ— è¿‡æ¸¡åŠ¨ç”»ï¼‰
     */
    function update3DMoonPhaseSync(moonRelativeAngle, illumination) {
      if (!pipSunLight || !pip3DMoon) return;
      
      // æ ¹æ®æœˆç›¸è®¡ç®—æœ€ä½³è§‚æµ‹æ—¶é—´çš„å¤©ç©ºé¢œè‰²
      const skyColor = calculateSkyColor(moonRelativeAngle);
      
      // ç›´æ¥ä½¿ç”¨æœˆçƒç›¸å¯¹åœ°çƒçš„è§’åº¦ï¼Œç§»é™¤Ï€/2ä¿®æ­£
      const sunAngleFor3D = moonRelativeAngle;
      
      const sunDistance = 8;
      const targetSunX = Math.sin(sunAngleFor3D) * sunDistance;
      const targetSunY = 0; // ä¿æŒåœ¨èµ¤é“å¹³é¢
      const targetSunZ = Math.cos(sunAngleFor3D) * sunDistance;
      
      // æ›´æ–°èƒŒæ™¯é¢œè‰²
      if (pipRenderer) {
        pipRenderer.setClearColor(skyColor, 1.0);
      }
      
      // ç›´æ¥è®¾ç½®å…‰æºä½ç½®ï¼Œä¸ä½¿ç”¨è¿‡æ¸¡åŠ¨ç”»
      pipSunLight.position.set(targetSunX, targetSunY, targetSunZ);
      pipSunLight.lookAt(0, 0, 0);
      
      // ç›´æ¥è®¾ç½®å…‰ç…§å¼ºåº¦
      const targetIntensity = 1.5 + illumination * 1.5;
      pipSunLight.intensity = targetIntensity;
      
      // ç›´æ¥è®¾ç½®ç¯å¢ƒå…‰ - æ–°æœˆæ—¶ä¿æŒè¶³å¤Ÿäº®åº¦
      const targetAmbient = 0.15 + illumination * 0.15; // åŸºç¡€äº®åº¦ä»0.15å¼€å§‹
      pipAmbientLight.intensity = targetAmbient;
      
      // åŠ¨æ€è°ƒæ•´è§†è§’è¡¥å…‰å¼ºåº¦ï¼šæ–°æœˆæ—¶æœ€å¼ºï¼Œæ»¡æœˆæ—¶æœ€å¼±
      if (pipViewLight) {
        // illumination èŒƒå›´ 0-1ï¼Œæ–°æœˆæ—¶ä¸º0ï¼Œæ»¡æœˆæ—¶ä¸º1
        // è¡¥å…‰å¼ºåº¦ï¼šæ–°æœˆæ—¶1.0ï¼Œæ»¡æœˆæ—¶0.2ï¼Œå‘ˆåæ¯”å…³ç³»
        const viewLightIntensity = 1.0 - (illumination * 0.8);
        pipViewLight.intensity = Math.max(0.2, viewLightIntensity); // æœ€å°ä¿æŒ0.2ï¼Œæœ€å¤§1.0
      }
      
      // æœˆçƒæ½®æ±é”å®š - å®Œå…¨é™æ­¢ï¼Œä¸è‡ªè½¬
      pip3DMoon.rotation.set(0, 0, 0);
      
      pipCamera.lookAt(0, 0, 0);
    }

    /**
     * 3Dæœˆç›¸åŠ¨ç”»å¾ªç¯
     */
    function start3DMoonAnimation() {
      function animate3DMoon() {
        if (!pipRenderer || !pipScene || !pipCamera) return;
        
        requestAnimationFrame(animate3DMoon);
        
        // åªåœ¨ç”»ä¸­ç”»å¯è§æ—¶æ¸²æŸ“
        if (isPipVisible) {
          pipRenderer.render(pipScene, pipCamera);
        }
      }
      
      animate3DMoon();
    }
    
    /**
     * è°ƒæ•´3Dæœˆç›¸æ¸²æŸ“å™¨å¤§å°
     */
    function resize3DMoonPhase() {
      if (!pipRenderer || !pipCamera) return;
      
      const container = document.getElementById('moonPhase3D');
      if (!container) return;
      
      const containerRect = container.getBoundingClientRect();
      if (containerRect.width === 0 || containerRect.height === 0) return;
      
      pipCamera.aspect = containerRect.width / containerRect.height;
      pipCamera.updateProjectionMatrix();
      pipRenderer.setSize(containerRect.width, containerRect.height);
    }
    
    /**
     * æ¸…ç†3Dæœˆç›¸èµ„æº
     */
    function cleanup3DMoonPhase() {
      if (pipRenderer) {
        const container = document.getElementById('moonPhase3D');
        if (container && pipRenderer.domElement.parentNode === container) {
          container.removeChild(pipRenderer.domElement);
        }
        pipRenderer.dispose();
        pipRenderer = null;
      }
      
      if (pipScene) {
        pipScene.clear();
        pipScene = null;
      }
      
      pipCamera = null;
      pip3DMoon = null;
      pipSunLight = null;
      pipAmbientLight = null;
      pipViewLight = null; // æ¸…ç†è§†è§’è¡¥å…‰
    }

    /* * * * * * * * * *
     * 2Dæ—¥é£Ÿ/æœˆé£ŸåŠ¨ç”»åŠŸèƒ½
     * * * * * * * * * */

    /**
     * åˆå§‹åŒ–2Dæ—¥é£Ÿ/æœˆé£ŸCanvas
     */
    function init2DEclipse() {
      const container = document.getElementById('moonPhase3D');
      if (!container) {
        console.warn('2Dæ—¥é£Ÿ/æœˆé£Ÿå®¹å™¨æœªæ‰¾åˆ°');
        return false;
      }

      try {
        // åˆ›å»ºCanvaså…ƒç´ 
        eclipse2DCanvas = document.createElement('canvas');
        eclipse2DCanvas.style.position = 'absolute';
        eclipse2DCanvas.style.top = '0';
        eclipse2DCanvas.style.left = '0';
        eclipse2DCanvas.style.width = '100%';
        eclipse2DCanvas.style.height = '100%';
        eclipse2DCanvas.style.zIndex = '10';
        
        // è®¾ç½®Canvaså°ºå¯¸
        const containerRect = container.getBoundingClientRect();
        eclipse2DCanvas.width = containerRect.width;
        eclipse2DCanvas.height = containerRect.height;
        
        // è·å–ç»˜å›¾ä¸Šä¸‹æ–‡
        eclipse2DCtx = eclipse2DCanvas.getContext('2d');
        
        // æ·»åŠ åˆ°å®¹å™¨
        container.appendChild(eclipse2DCanvas);
        
        console.log('2Dæ—¥é£Ÿ/æœˆé£ŸCanvasåˆå§‹åŒ–æˆåŠŸ');
        return true;
      } catch (error) {
        console.error('2Dæ—¥é£Ÿ/æœˆé£ŸCanvasåˆå§‹åŒ–å¤±è´¥:', error);
        return false;
      }
    }

    /**
     * æ¸…ç†2Dæ—¥é£Ÿ/æœˆé£ŸCanvas
     */
    function cleanup2DEclipse() {
      if (eclipseAnimationId) {
        cancelAnimationFrame(eclipseAnimationId);
        eclipseAnimationId = null;
      }
      
      if (eclipse2DCanvas) {
        const container = document.getElementById('moonPhase3D');
        if (container && eclipse2DCanvas.parentNode === container) {
          container.removeChild(eclipse2DCanvas);
        }
        eclipse2DCanvas = null;
        eclipse2DCtx = null;
      }
      
      // æ¸…ç†ç¼“å­˜çš„æ˜Ÿæ˜Ÿ
      cachedStars = null;
    }

    /**
     * è·å–æœˆçƒå¤§å°æ¯”ä¾‹ï¼ˆåŸºäºè·ç¦»è®¾ç½®ï¼‰
     * @param {string} eclipseType - æ—¥é£Ÿç±»å‹ ('total' æˆ– 'partial')
     * @param {number} sunRadius - å¤ªé˜³åŠå¾„
     * @returns {number} æœˆçƒåŠå¾„
     */
    function getMoonRadius(eclipseType, sunRadius) {
      const moonDistanceSelect = document.getElementById('pipMoonDistanceSelect');
      const moonDistance = moonDistanceSelect ? moonDistanceSelect.value : 'average';
      
      // åŸºç¡€æœˆçƒå¤§å°ï¼ˆç›¸å¯¹äºå¤ªé˜³ï¼‰
      let baseScale;
      if (eclipseType === 'total') {
        baseScale = 1.05; // æ—¥å…¨é£Ÿæ—¶æœˆçƒéœ€è¦ç¨å¤§äºå¤ªé˜³
      } else {
        baseScale = 0.95; // æ—¥åé£Ÿæ—¶æœˆçƒå¤§å°é€‚ä¸­
      }
      
      // æ ¹æ®æœˆçƒè·ç¦»è°ƒæ•´å¤§å° - æ¨¡æ‹Ÿæœˆçƒè§†è§’å¤§å°å˜åŒ–
      let distanceScale = 1.0;
      switch (moonDistance) {
        case 'perigee': // è¿‘åœ°ç‚¹ï¼šæœˆçƒçœ‹èµ·æ¥æ›´å¤§ï¼ˆçº¦356,500kmï¼‰
          distanceScale = 1.15; // å¢å¤§15%ï¼Œå®¹æ˜“å½¢æˆæ—¥å…¨é£Ÿ
          break;
        case 'apogee': // è¿œåœ°ç‚¹ï¼šæœˆçƒçœ‹èµ·æ¥æ›´å°ï¼ˆçº¦406,700kmï¼‰
          distanceScale = 0.85; // å‡å°15%ï¼Œå®¹æ˜“å½¢æˆæ—¥ç¯é£Ÿ
          break;
        case 'average': // å¹³å‡è·ç¦»ï¼ˆçº¦384,400kmï¼‰
        default:
          distanceScale = 1.0;
          break;
      }
      
      return sunRadius * baseScale * distanceScale;
    }

    /**
     * ç»˜åˆ¶2Dæ—¥é£ŸåŠ¨ç”»
     * @param {number} progress - é£Ÿåˆ†è¿›åº¦ (0-1)
     * @param {string} eclipseType - æ—¥é£Ÿç±»å‹ ('total' æˆ– 'partial')
     */
    function draw2DSolarEclipse(progress, eclipseType) {
      if (!eclipse2DCtx) return;

      const canvas = eclipse2DCanvas;
      const ctx = eclipse2DCtx;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const sunRadius = Math.min(canvas.width, canvas.height) * 0.3;

      // å…¼å®¹æ–°æ—§è¿›åº¦æ ¼å¼
      const timeProgress = typeof progress === 'object' ? progress.timeProgress : progress;
      const intensity = typeof progress === 'object' ? progress.intensity : progress;
      const combinedProgress = typeof progress === 'object' ? progress.combined : progress;

      // æ¸…é™¤ç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // æ ¹æ®æ—¥é£Ÿç±»å‹ç»˜åˆ¶ä¸åŒçš„èƒŒæ™¯
      const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, Math.max(canvas.width, canvas.height));
      
              if (eclipseType === 'total') {
          // æ—¥å…¨é£Ÿï¼šæ›´æˆå‰§åŒ–çš„å¤©ç©ºå˜åŒ–ï¼ˆåŸºäºé®æŒ¡å¼ºåº¦ï¼‰
          if (intensity > 0.6) {
            // æ¥è¿‘å…¨é£Ÿæ—¶å¤©ç©ºæ€¥å‰§å˜æš—
            const darknessLevel = Math.min(1, (intensity - 0.6) / 0.4);
            gradient.addColorStop(0, `rgba(255, 223, 0, ${1 - darknessLevel * 0.95})`);
            gradient.addColorStop(0.2, `rgba(255, 140, 0, ${1 - darknessLevel * 0.9})`);
            gradient.addColorStop(0.4, `rgba(80, 40, 120, ${0.1 + darknessLevel * 0.7})`);
            gradient.addColorStop(0.7, `rgba(15, 20, 35, ${0.3 + darknessLevel * 0.7})`);
            gradient.addColorStop(1, `rgba(0, 0, 0, ${0.5 + darknessLevel * 0.5})`);
          } else {
            // æ—¥å…¨é£Ÿå‰æœŸï¼šé€æ¸å˜æš—çš„å¤©ç©º
            const shadowLevel = intensity * 0.7;
            gradient.addColorStop(0, `rgba(255, 223, 0, ${0.8 - shadowLevel})`);
            gradient.addColorStop(0.3, `rgba(255, 165, 0, ${0.9 - shadowLevel})`);
            gradient.addColorStop(0.6, `rgba(135, 170, 235, ${0.8 - shadowLevel * 0.6})`);
            gradient.addColorStop(1, `rgba(70, 100, 180, ${1 - shadowLevel * 0.4})`);
          }
        } else {
          // æ—¥åé£Ÿï¼šå¤©ç©ºå˜åŒ–å¾ˆæ¸©å’Œï¼Œä¿æŒæ˜äº®
          const shadowLevel = intensity * 0.2;
          gradient.addColorStop(0, `rgba(255, 223, 0, ${0.5 - shadowLevel})`);
          gradient.addColorStop(0.3, `rgba(255, 165, 0, ${0.8 - shadowLevel})`);
          gradient.addColorStop(0.6, `rgba(135, 206, 235, ${0.9 - shadowLevel * 0.2})`);
          gradient.addColorStop(1, `rgba(70, 130, 180, ${1 - shadowLevel * 0.1})`);
        }

      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶å¤ªé˜³ - æ ¹æ®æ—¥é£Ÿç±»å‹è°ƒæ•´äº®åº¦ï¼ˆåŸºäºé®æŒ¡å¼ºåº¦ï¼‰
      const sunGradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, sunRadius);
      
      if (eclipseType === 'total' && intensity > 0.7) {
        // æ—¥å…¨é£Ÿæ—¶å¤ªé˜³å…‰èŠ’å‡å¼±
        const dimFactor = 1 - (intensity - 0.7) / 0.3 * 0.6;
        sunGradient.addColorStop(0, `rgba(255, 215, 0, ${dimFactor})`);
        sunGradient.addColorStop(0.7, `rgba(255, 165, 0, ${dimFactor})`);
        sunGradient.addColorStop(1, `rgba(255, 140, 0, ${dimFactor})`);
      } else {
        sunGradient.addColorStop(0, '#FFD700');
        sunGradient.addColorStop(0.7, '#FFA500');
        sunGradient.addColorStop(1, '#FF8C00');
      }

      ctx.fillStyle = sunGradient;
      ctx.beginPath();
      ctx.arc(centerX, centerY, sunRadius, 0, 2 * Math.PI);
      ctx.fill();

              // ç»˜åˆ¶å¤ªé˜³å…‰èŠ’ - æ ¹æ®æ—¥é£Ÿç±»å‹è°ƒæ•´ï¼ˆåŸºäºé®æŒ¡å¼ºåº¦ï¼‰
        const raysOpacity = eclipseType === 'total' ? 
          Math.max(0.05, 0.6 - intensity * 0.8) : 
          Math.max(0.4, 0.6 - intensity * 0.2);
        
        ctx.strokeStyle = `rgba(255, 215, 0, ${raysOpacity})`;
        ctx.lineWidth = eclipseType === 'total' ? 2 : 4;
        
        const rayCount = eclipseType === 'total' ? 20 : 16;
        for (let i = 0; i < rayCount; i++) {
          const angle = (i / rayCount) * 2 * Math.PI;
          const rayLength = eclipseType === 'total' ? 
            (25 - intensity * 10) : 
            (40 - intensity * 5);
          const x1 = centerX + Math.cos(angle) * (sunRadius + 20);
          const y1 = centerY + Math.sin(angle) * (sunRadius + 20);
          const x2 = centerX + Math.cos(angle) * (sunRadius + rayLength);
          const y2 = centerY + Math.sin(angle) * (sunRadius + rayLength);
          
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.stroke();
        }

              // ç»˜åˆ¶æœˆçƒé˜´å½±ï¼ˆä½ç½®åŸºäºæ—¶é—´è¿›åº¦ï¼Œé®æŒ¡å¼ºåº¦åŸºäºå¤©æ–‡æ¡ä»¶ï¼‰
        if (timeProgress > 0) {
          let currentX, currentY, moonRadius;
          
          // ä½¿ç”¨æ–°çš„æœˆçƒå¤§å°è®¡ç®—å‡½æ•°
          moonRadius = getMoonRadius(eclipseType, sunRadius);
          
          if (eclipseType === 'total') {
            // æ—¥å…¨é£Ÿï¼šæœˆçƒç›´æ¥ç©¿è¿‡å¤ªé˜³ä¸­å¿ƒ
            const totalDistance = sunRadius * 2.5;
            const startX = centerX + totalDistance * 0.9;
            const startY = centerY; // ä¿æŒåœ¨å¤ªé˜³ä¸­å¿ƒæ°´å¹³çº¿ä¸Š
            const endX = centerX - totalDistance * 0.9;
            const endY = centerY; // ä¿æŒåœ¨å¤ªé˜³ä¸­å¿ƒæ°´å¹³çº¿ä¸Š
            
            currentX = startX + (endX - startX) * timeProgress;
            currentY = startY + (endY - startY) * timeProgress;
            
          } else {
            // æ—¥åé£Ÿï¼šæœˆçƒåªæ“¦è¿‡å¤ªé˜³çš„ä¸Šæ–¹è¾¹ç¼˜
            const partialDistance = sunRadius * 2.0;
            const startX = centerX + partialDistance * 0.8;
            const startY = centerY - sunRadius * 0.7; // åç¦»ä¸­å¿ƒï¼Œä»ä¸Šæ–¹ç»è¿‡
            const endX = centerX - partialDistance * 0.8;
            const endY = centerY - sunRadius * 0.7; // ä¿æŒåœ¨ä¸Šæ–¹
            
            currentX = startX + (endX - startX) * timeProgress;
            currentY = startY + (endY - startY) * timeProgress;
          }
        
        // ç»˜åˆ¶æœˆçƒé˜´å½±æœ¬ä½“ - åªé®æŒ¡å¤ªé˜³æœ¬ä½“ï¼Œä¸é®æŒ¡å…‰èŠ’å’ŒèƒŒæ™¯å¤©ç©º
        ctx.save();
        
        // åˆ›å»ºå¤ªé˜³æœ¬ä½“çš„è£å‰ªåŒºåŸŸï¼ˆåªé®æŒ¡å¤ªé˜³åœ†ç›˜ï¼‰
        ctx.beginPath();
        ctx.arc(centerX, centerY, sunRadius, 0, 2 * Math.PI);
        ctx.clip();
        
        // åœ¨è£å‰ªåŒºåŸŸå†…ç»˜åˆ¶æœˆçƒé˜´å½±
        const shadowOpacity = Math.min(0.95, 0.5 + intensity * 0.45);
        ctx.fillStyle = `rgba(0, 0, 0, ${shadowOpacity})`;
        ctx.beginPath();
        ctx.arc(currentX, currentY, moonRadius, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.restore();
        
        // æ—¥é£Ÿæ—¶æœˆçƒæœ¬èº«ä¸å¯è§ï¼Œä¸ç»˜åˆ¶è¾¹ç¼˜å…‰æ™•
        // æœˆçƒåªåœ¨é®æŒ¡å¤ªé˜³æ—¶æ‰æ˜¾ç¤ºé˜´å½±æ•ˆæœï¼Œåœ¨å¤ªé˜³å¤–éƒ¨ä¸æ˜¾ç¤ºä»»ä½•ç—•è¿¹
        
                  // æ—¥å…¨é£Ÿç‰¹æœ‰çš„æ—¥å†•æ•ˆæœï¼ˆåŸºäºé®æŒ¡å¼ºåº¦ï¼‰
          if (eclipseType === 'total' && intensity > 0.5 && intensity < 0.95) {
            const coronaIntensity = intensity * (1 - Math.abs(timeProgress - 0.5) / 0.5);
            
            // ç»˜åˆ¶å†…æ—¥å†•ï¼ˆç™½è‰²å…‰æ™•ï¼‰
            ctx.strokeStyle = `rgba(255, 255, 255, ${coronaIntensity * 1.0})`;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.arc(centerX, centerY, sunRadius + 5, 0, 2 * Math.PI);
            ctx.stroke();
            
            // ç»˜åˆ¶ä¸­æ—¥å†•
            ctx.strokeStyle = `rgba(255, 255, 255, ${coronaIntensity * 0.8})`;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, sunRadius + 12, 0, 2 * Math.PI);
            ctx.stroke();
            
            // ç»˜åˆ¶å¤–æ—¥å†•å°„çº¿ï¼ˆæ›´é•¿æ›´äº®ï¼Œå½¢çŠ¶ä¸è§„åˆ™ï¼‰
            ctx.strokeStyle = `rgba(255, 255, 255, ${coronaIntensity * 0.9})`;
            ctx.lineWidth = 2;
            for (let i = 0; i < 40; i++) {
              const angle = (i / 40) * 2 * Math.PI;
              // å‡æ…¢éšæœºå˜åŒ–ï¼Œä½¿ç”¨æ›´æ…¢çš„æ—¶é—´å› å­
              const slowTime = Date.now() * 0.001; // ä»0.01æ”¹ä¸º0.001ï¼Œå‡æ…¢10å€
              const rayLength = 40 + Math.sin(angle * 3 + slowTime) * 15 + Math.sin(slowTime + i) * 10;
              const x1 = centerX + Math.cos(angle) * (sunRadius + 2);
              const y1 = centerY + Math.sin(angle) * (sunRadius + 2);
              const x2 = centerX + Math.cos(angle) * (sunRadius + rayLength);
              const y2 = centerY + Math.sin(angle) * (sunRadius + rayLength);
              
              ctx.beginPath();
              ctx.moveTo(x1, y1);
              ctx.lineTo(x2, y2);
              ctx.stroke();
            }
            
            // ç»˜åˆ¶æµå…‰æ•ˆæœï¼ˆæ›´å¤šæ›´äº®ï¼Œå‡æ…¢åŠ¨ç”»é€Ÿåº¦ï¼‰
            ctx.strokeStyle = `rgba(220, 220, 255, ${coronaIntensity * 0.7})`;
            ctx.lineWidth = 1;
            for (let i = 0; i < 20; i++) {
              const angle = (i / 20) * 2 * Math.PI;
              // å‡æ…¢æµå…‰åŠ¨ç”»é€Ÿåº¦
              const waveLength = 50 + Math.sin(Date.now() * 0.003 + i) * 15; // ä»0.01æ”¹ä¸º0.003
              const x1 = centerX + Math.cos(angle) * (sunRadius + 15);
              const y1 = centerY + Math.sin(angle) * (sunRadius + 15);
              const x2 = centerX + Math.cos(angle) * (sunRadius + waveLength);
              const y2 = centerY + Math.sin(angle) * (sunRadius + waveLength);
              
              ctx.beginPath();
              ctx.moveTo(x1, y1);
              ctx.lineTo(x2, y2);
              ctx.stroke();
            }
            
            // ç»˜åˆ¶æ˜Ÿæ˜Ÿæ•ˆæœï¼ˆå…¨é£Ÿæ—¶å¯è§æ˜Ÿæ˜Ÿï¼Œä½¿ç”¨å›ºå®šä½ç½®ï¼‰
            if (intensity > 0.7) {
              ctx.fillStyle = `rgba(255, 255, 255, ${coronaIntensity * 0.8})`;
              
              // ä½¿ç”¨å›ºå®šçš„æ˜Ÿæ˜Ÿä½ç½®é¿å…é—ªçƒ
              if (!window.cachedCoronaStars) {
                window.cachedCoronaStars = [];
                for (let i = 0; i < 8; i++) {
                  const angle = (i / 8) * 2 * Math.PI + Math.sin(i) * 0.5; // å›ºå®šè§’åº¦åˆ†å¸ƒ
                  const distance = sunRadius * 2.2 + (i % 3) * 15; // å›ºå®šè·ç¦»
                  window.cachedCoronaStars.push({ angle, distance });
                }
              }
              
              window.cachedCoronaStars.forEach(star => {
                const x = centerX + Math.cos(star.angle) * star.distance;
                const y = centerY + Math.sin(star.angle) * star.distance;
                
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, 2 * Math.PI);
                ctx.fill();
              });
            }
          }
        
                  // æ—¥åé£Ÿç‰¹æœ‰çš„æ˜æš—å¯¹æ¯”æ•ˆæœ
          if (eclipseType === 'partial' && intensity > 0.2) {
            // ç»˜åˆ¶è¢«é®æŒ¡å¤ªé˜³çš„å‰©ä½™å…‰èŠ’ - æ›´å¼ºçƒˆçš„å¯¹æ¯”
            const remainingLight = 1 - intensity * 0.5;
            ctx.strokeStyle = `rgba(255, 200, 0, ${remainingLight})`;
            ctx.lineWidth = 5;
            
            // åªåœ¨æœªè¢«é®æŒ¡çš„éƒ¨åˆ†ç»˜åˆ¶å…‰èŠ’
            for (let i = 0; i < 16; i++) {
              const angle = (i / 16) * 2 * Math.PI;
              const dx = Math.cos(angle);
              const dy = Math.sin(angle);
              
              // æ£€æŸ¥è¿™ä¸ªæ–¹å‘æ˜¯å¦è¢«æœˆçƒé®æŒ¡
              const testX = centerX + dx * sunRadius;
              const testY = centerY + dy * sunRadius;
              const distToMoon = Math.sqrt((testX - currentX) ** 2 + (testY - currentY) ** 2);
              
              if (distToMoon > moonRadius) {
                const x1 = centerX + dx * (sunRadius + 20);
                const y1 = centerY + dy * (sunRadius + 20);
                const x2 = centerX + dx * (sunRadius + 45);
                const y2 = centerY + dy * (sunRadius + 45);
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
              }
            }
            
            // ç»˜åˆ¶å¤ªé˜³å‰©ä½™éƒ¨åˆ†çš„å¢å¼ºå…‰èŠ’
            ctx.strokeStyle = `rgba(255, 215, 0, ${remainingLight * 0.8})`;
            ctx.lineWidth = 3;
            for (let i = 0; i < 8; i++) {
              const angle = (i / 8) * 2 * Math.PI;
              const dx = Math.cos(angle);
              const dy = Math.sin(angle);
              
              // æ£€æŸ¥è¿™ä¸ªæ–¹å‘æ˜¯å¦è¢«æœˆçƒé®æŒ¡
              const testX = centerX + dx * sunRadius;
              const testY = centerY + dy * sunRadius;
              const distToMoon = Math.sqrt((testX - currentX) ** 2 + (testY - currentY) ** 2);
              
              if (distToMoon > moonRadius) {
                const x1 = centerX + dx * (sunRadius + 10);
                const y1 = centerY + dy * (sunRadius + 10);
                const x2 = centerX + dx * (sunRadius + 30);
                const y2 = centerY + dy * (sunRadius + 30);
                
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
              }
            }
            
            // ç»˜åˆ¶æ–°æœˆå½¢é«˜å…‰ï¼Œçªå‡ºæ˜¾ç¤ºå¤ªé˜³å‰©ä½™éƒ¨åˆ†
            if (progress > 0.4) {
              ctx.fillStyle = `rgba(255, 255, 0, ${remainingLight * 0.3})`;
              ctx.beginPath();
              ctx.arc(centerX, centerY, sunRadius, 0, 2 * Math.PI);
              ctx.fill();
              
              // å†æ¬¡ç»˜åˆ¶æœˆçƒé˜´å½±ï¼Œå½¢æˆæ–°æœˆå½¢æ•ˆæœ - åªé®æŒ¡å¤ªé˜³æœ¬ä½“
              ctx.save();
              
              // åˆ›å»ºå¤ªé˜³æœ¬ä½“çš„è£å‰ªåŒºåŸŸï¼ˆåªé®æŒ¡å¤ªé˜³åœ†ç›˜ï¼‰
              ctx.beginPath();
              ctx.arc(centerX, centerY, sunRadius, 0, 2 * Math.PI);
              ctx.clip();
              
              // åœ¨è£å‰ªåŒºåŸŸå†…ç»˜åˆ¶æœˆçƒé˜´å½±
              ctx.fillStyle = 'rgba(0, 0, 0, 0.95)';
              ctx.beginPath();
              ctx.arc(currentX, currentY, moonRadius, 0, 2 * Math.PI);
              ctx.fill();
              
              ctx.restore();
            }
          }
      }

      // ç»˜åˆ¶è¿›åº¦æ–‡å­— - æ ¹æ®æ—¥é£Ÿç±»å‹è°ƒæ•´é¢œè‰²
      const textColor = eclipseType === 'total' && intensity > 0.7 ? 
        'rgba(255, 255, 255, 0.9)' : 
        'rgba(255, 255, 255, 0.9)';
      
      ctx.fillStyle = textColor;
      ctx.font = 'bold 16px Arial';
      ctx.textAlign = 'center';
      
      // è¿›åº¦è¯´æ˜å·²ç§»é™¤ä»¥ä¿æŒç”»é¢ç®€æ´
    }

    /**
     * ç»˜åˆ¶2Dæœˆé£ŸåŠ¨ç”»
     * @param {number} progress - é£Ÿåˆ†è¿›åº¦ (0-1)
     * @param {string} eclipseType - æœˆé£Ÿç±»å‹ ('total' æˆ– 'partial')
     */
    function draw2DLunarEclipse(progress, eclipseType) {
      if (!eclipse2DCtx) return;

      const canvas = eclipse2DCanvas;
      const ctx = eclipse2DCtx;
      const centerX = canvas.width / 2;
      const centerY = canvas.height / 2;
      const moonRadius = Math.min(canvas.width, canvas.height) * 0.3;

      // å…¼å®¹æ–°æ—§è¿›åº¦æ ¼å¼
      const timeProgress = typeof progress === 'object' ? progress.timeProgress : progress;
      const intensity = typeof progress === 'object' ? progress.intensity : progress;
      const combinedProgress = typeof progress === 'object' ? progress.combined : progress;

      // æ¸…é™¤ç”»å¸ƒ
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶å¤œç©ºèƒŒæ™¯
      const gradient = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, Math.max(canvas.width, canvas.height));
      gradient.addColorStop(0, 'rgba(30, 30, 60, 0.3)');
      gradient.addColorStop(0.5, 'rgba(20, 20, 40, 0.7)');
      gradient.addColorStop(1, 'rgba(10, 10, 20, 1)');

      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      // ç»˜åˆ¶æ˜Ÿæ˜Ÿï¼ˆä½¿ç”¨ç¼“å­˜ä½ç½®ä»¥ä¿æŒä¸€è‡´æ€§ï¼‰
      ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
      
      // å¦‚æœæ²¡æœ‰ç¼“å­˜çš„æ˜Ÿæ˜Ÿæˆ–ç”»å¸ƒå°ºå¯¸æ”¹å˜ï¼Œé‡æ–°ç”Ÿæˆ
      if (!cachedStars || cachedStars.canvasWidth !== canvas.width || cachedStars.canvasHeight !== canvas.height) {
        cachedStars = {
          canvasWidth: canvas.width,
          canvasHeight: canvas.height,
          stars: []
        };
        
        // ç”Ÿæˆ50ä¸ªéšæœºæ˜Ÿæ˜Ÿä½ç½®
        for (let i = 0; i < 50; i++) {
          const x = Math.random() * canvas.width;
          const y = Math.random() * canvas.height;
          const radius = Math.random() * 2 + 1;
          
          // é¿å…åœ¨æœˆçƒé™„è¿‘ç»˜åˆ¶æ˜Ÿæ˜Ÿ
          const distanceFromMoon = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);
          if (distanceFromMoon > moonRadius + 50) {
            cachedStars.stars.push({ x, y, radius });
          }
        }
      }
      
      // ç»˜åˆ¶ç¼“å­˜çš„æ˜Ÿæ˜Ÿ
      cachedStars.stars.forEach(star => {
        ctx.beginPath();
        ctx.arc(star.x, star.y, star.radius, 0, 2 * Math.PI);
        ctx.fill();
      });

      // ç»˜åˆ¶æœˆçƒæœ¬ä½“
      const moonGradient = ctx.createRadialGradient(
        centerX - moonRadius * 0.3, 
        centerY - moonRadius * 0.3, 
        0, 
        centerX, 
        centerY, 
        moonRadius
      );
      moonGradient.addColorStop(0, '#F5F5DC');
      moonGradient.addColorStop(0.7, '#E6E6FA');
      moonGradient.addColorStop(1, '#D3D3D3');

      ctx.fillStyle = moonGradient;
      ctx.beginPath();
      ctx.arc(centerX, centerY, moonRadius, 0, 2 * Math.PI);
      ctx.fill();

      // ç»˜åˆ¶æœˆçƒè¡¨é¢çº¹ç†ï¼ˆä½¿ç”¨å›ºå®šä½ç½®é¿å…é—ªçƒï¼‰
      ctx.fillStyle = 'rgba(180, 180, 180, 0.3)';
      
      // ç”Ÿæˆå›ºå®šçš„æœˆçƒçº¹ç†ä½ç½®ï¼ˆåŸºäºæœˆçƒåŠå¾„ä½œä¸ºç§å­ï¼‰
      if (!window.cachedMoonTexture || window.cachedMoonTexture.radius !== moonRadius) {
        window.cachedMoonTexture = {
          radius: moonRadius,
          craters: []
        };
        
        // ä½¿ç”¨å›ºå®šç§å­ç”Ÿæˆç¨³å®šçš„çº¹ç†
        const tempRandom = Math.random;
        Math.random = () => Math.sin(moonRadius * 12345) % 1; // ä¸´æ—¶å›ºå®šéšæœºæ•°
        
        for (let i = 0; i < 20; i++) {
          const angle = (i / 20) * 2 * Math.PI + Math.sin(i * 3.14) * 0.5;
          const distance = (0.3 + (i % 5) * 0.1) * moonRadius;
          const x = centerX + Math.cos(angle) * distance;
          const y = centerY + Math.sin(angle) * distance;
          const radius = 3 + (i % 3) * 2;
          
          window.cachedMoonTexture.craters.push({ x: x - centerX, y: y - centerY, radius });
        }
        
        Math.random = tempRandom; // æ¢å¤åŸå§‹éšæœºå‡½æ•°
      }
      
      // ç»˜åˆ¶ç¼“å­˜çš„æœˆçƒçº¹ç†
      window.cachedMoonTexture.craters.forEach(crater => {
        ctx.beginPath();
        ctx.arc(centerX + crater.x, centerY + crater.y, crater.radius, 0, 2 * Math.PI);
        ctx.fill();
      });

      // ç»˜åˆ¶åœ°çƒé˜´å½±ï¼ˆä½ç½®åŸºäºæ—¶é—´è¿›åº¦ï¼Œå¼ºåº¦åŸºäºå¤©æ–‡æ¡ä»¶ï¼‰
      if (timeProgress > 0) {
        let shadowCurrentX, shadowCurrentY, umbraRadius, penumbraRadius;
        
        if (eclipseType === 'total') {
          // æœˆå…¨é£Ÿï¼šé˜´å½±ç©¿è¿‡æœˆçƒä¸­å¿ƒï¼Œå¯ä»¥å®Œå…¨é®æŒ¡æœˆçƒ
          const shadowStartX = centerX - moonRadius * 1.3;
          const shadowEndX = centerX + moonRadius * 1.3;
          shadowCurrentX = shadowStartX + (shadowEndX - shadowStartX) * timeProgress;
          shadowCurrentY = centerY; // ä¿æŒåœ¨æœˆçƒä¸­å¿ƒ
          umbraRadius = moonRadius * 0.9; // ç¨å¤§ä¸€ç‚¹ï¼Œç¡®ä¿å®Œå…¨é®æŒ¡
          penumbraRadius = moonRadius * 1.2;
          
        } else {
          // æœˆåé£Ÿï¼šé˜´å½±ä»æœˆçƒä¸Šæ–¹ç»è¿‡ï¼Œåªè¦†ç›–éƒ¨åˆ†æœˆçƒ
          const shadowStartX = centerX - moonRadius * 1.2;
          const shadowEndX = centerX + moonRadius * 1.2;
          shadowCurrentX = shadowStartX + (shadowEndX - shadowStartX) * timeProgress;
          
          // é˜´å½±è·¯å¾„åç¦»æœˆçƒä¸­å¿ƒï¼Œä»ä¸Šæ–¹ç»è¿‡
          const offsetY = moonRadius * 0.4; // å‘ä¸Šåç§»ï¼Œè®©é˜´å½±åªè¦†ç›–æœˆçƒä¸‹åŠéƒ¨åˆ†
          shadowCurrentY = centerY - offsetY;
          
          umbraRadius = moonRadius * 0.7; // ç¨å°ä¸€ç‚¹ï¼Œçªå‡ºåé£Ÿæ•ˆæœ
          penumbraRadius = moonRadius * 1.0;
        }
        
        // ç»˜åˆ¶æœ¬å½±ï¼ˆæ·±è‰²é˜´å½±ï¼‰- åªé®æŒ¡æœˆçƒæœ¬ä½“ï¼Œä¸é®æŒ¡å…‰æ™•å’ŒèƒŒæ™¯æ˜Ÿç©º
        ctx.save();
        
        // åˆ›å»ºæœˆçƒæœ¬ä½“çš„è£å‰ªåŒºåŸŸï¼ˆåªé®æŒ¡æœˆçƒåœ†ç›˜ï¼‰
        ctx.beginPath();
        ctx.arc(centerX, centerY, moonRadius, 0, 2 * Math.PI);
        ctx.clip();
        
        const umbraGradient = ctx.createRadialGradient(
          shadowCurrentX, shadowCurrentY, 0,
          shadowCurrentX, shadowCurrentY, umbraRadius
        );
        
        if (eclipseType === 'total' && intensity > 0.3 && intensity < 0.7) {
          // æœˆå…¨é£Ÿæ—¶çš„çº¢è‰²æ•ˆæœï¼ˆè¡€æœˆï¼‰
          const redIntensity = intensity * 0.9;
          umbraGradient.addColorStop(0, `rgba(139, 0, 0, ${redIntensity})`);
          umbraGradient.addColorStop(0.7, `rgba(100, 0, 0, ${redIntensity * 0.8})`);
          umbraGradient.addColorStop(1, `rgba(60, 0, 0, ${redIntensity * 0.6})`);
        } else {
          // æ­£å¸¸é˜´å½±æ•ˆæœ
          const shadowIntensity = eclipseType === 'total' ? intensity * 0.95 : intensity * 0.8;
          umbraGradient.addColorStop(0, `rgba(0, 0, 0, ${shadowIntensity})`);
          umbraGradient.addColorStop(0.7, `rgba(0, 0, 0, ${shadowIntensity * 0.7})`);
          umbraGradient.addColorStop(1, `rgba(0, 0, 0, ${shadowIntensity * 0.3})`);
        }
        
        ctx.fillStyle = umbraGradient;
        ctx.beginPath();
        ctx.arc(shadowCurrentX, shadowCurrentY, umbraRadius, 0, 2 * Math.PI);
        ctx.fill();
        
        // ç»˜åˆ¶åŠå½±ï¼ˆæµ…è‰²é˜´å½±ï¼‰- ä¹Ÿåªåœ¨æœˆçƒåŒºåŸŸå†…
        const penumbraGradient = ctx.createRadialGradient(
          shadowCurrentX, shadowCurrentY, umbraRadius,
          shadowCurrentX, shadowCurrentY, penumbraRadius
        );
        
        const penumbraIntensity = eclipseType === 'total' ? intensity * 0.4 : intensity * 0.25;
        penumbraGradient.addColorStop(0, `rgba(0, 0, 0, ${penumbraIntensity})`);
        penumbraGradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = penumbraGradient;
        ctx.beginPath();
        ctx.arc(shadowCurrentX, shadowCurrentY, penumbraRadius, 0, 2 * Math.PI);
        ctx.fill();
        
        ctx.restore();
        
                  // æœˆåé£Ÿç‰¹æ•ˆï¼šå¼ºè°ƒæœˆçƒå‰©ä½™çš„æ˜äº®éƒ¨åˆ†ï¼ˆåœ¨æœˆçƒæœ¬ä½“å¤–ç»˜åˆ¶å…‰ç¯ï¼‰
          if (eclipseType === 'partial' && intensity > 0.3) {
            ctx.save();
            
            // åˆ›å»ºæœˆçƒæœ¬ä½“å¤–çš„è£å‰ªï¼ˆåå‘è£å‰ªï¼Œæ’é™¤æœˆçƒæœ¬ä½“ï¼‰
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.arc(centerX, centerY, moonRadius, 0, 2 * Math.PI, true);
            ctx.clip();
          
          // ç»˜åˆ¶æœˆçƒæœªè¢«é®æŒ¡éƒ¨åˆ†çš„å¢å¼ºå…‰èŠ’
          const brightIntensity = (1 - intensity) * 0.4;
          ctx.strokeStyle = `rgba(255, 255, 255, ${brightIntensity})`;
          ctx.lineWidth = 3;
          
          // åªåœ¨æœˆçƒä¸ŠåŠéƒ¨åˆ†ç»˜åˆ¶å…‰ç¯ï¼ˆæœªè¢«é˜´å½±é®æŒ¡çš„éƒ¨åˆ†ï¼‰
          ctx.beginPath();
          ctx.arc(centerX, centerY - moonRadius * 0.2, moonRadius + 8, 0, Math.PI, true);
          ctx.stroke();
          
          // é¢å¤–çš„äº®å…‰æ•ˆæœ
          ctx.strokeStyle = `rgba(240, 240, 255, ${brightIntensity * 0.6})`;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(centerX, centerY - moonRadius * 0.2, moonRadius + 15, 0, Math.PI, true);
          ctx.stroke();
          
          ctx.restore();
        }
        
                  // æœˆå…¨é£Ÿç‰¹æ•ˆï¼šå¢å¼ºè¡€æœˆæ•ˆæœï¼ˆåœ¨æœˆçƒæœ¬ä½“å¤–ç»˜åˆ¶å…‰ç¯ï¼‰
          if (eclipseType === 'total' && intensity > 0.5) {
            ctx.save();
            
            // åˆ›å»ºæœˆçƒæœ¬ä½“å¤–çš„è£å‰ªï¼ˆåå‘è£å‰ªï¼Œæ’é™¤æœˆçƒæœ¬ä½“ï¼‰
            ctx.beginPath();
            ctx.rect(0, 0, canvas.width, canvas.height);
            ctx.arc(centerX, centerY, moonRadius, 0, 2 * Math.PI, true);
            ctx.clip();
          
          const bloodMoonIntensity = intensity * 0.3;
          
          // ç»˜åˆ¶çº¢è‰²å…‰æ™•
          ctx.strokeStyle = `rgba(139, 0, 0, ${bloodMoonIntensity})`;
          ctx.lineWidth = 4;
          ctx.beginPath();
          ctx.arc(centerX, centerY, moonRadius + 12, 0, 2 * Math.PI);
          ctx.stroke();
          
          // å¤–å±‚çº¢è‰²å…‰æ™•
          ctx.strokeStyle = `rgba(100, 0, 0, ${bloodMoonIntensity * 0.6})`;
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(centerX, centerY, moonRadius + 20, 0, 2 * Math.PI);
          ctx.stroke();
          
          ctx.restore();
        }
      }

              // ç»˜åˆ¶æœˆçƒå…‰æ™•ï¼ˆåŸºäºé®æŒ¡å¼ºåº¦ï¼‰- åªåœ¨æœˆçƒæœ¬ä½“å¤–æ˜¾ç¤º
        if (intensity < 0.8) {
          ctx.save();
          
          // åˆ›å»ºæœˆçƒæœ¬ä½“å¤–çš„è£å‰ªï¼ˆåå‘è£å‰ªï¼Œæ’é™¤æœˆçƒæœ¬ä½“ï¼‰
          ctx.beginPath();
          ctx.rect(0, 0, canvas.width, canvas.height);
          ctx.arc(centerX, centerY, moonRadius, 0, 2 * Math.PI, true);
          ctx.clip();
        
        const haloIntensity = 1 - intensity;
        ctx.strokeStyle = `rgba(255, 255, 255, ${haloIntensity * 0.3})`;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(centerX, centerY, moonRadius + 10, 0, 2 * Math.PI);
        ctx.stroke();
        
        ctx.restore();
      }

      // ç»˜åˆ¶è¿›åº¦æ–‡å­—
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.font = 'bold 16px Arial';
      ctx.textAlign = 'center';
      
      // è¿›åº¦è¯´æ˜å·²ç§»é™¤ä»¥ä¿æŒç”»é¢ç®€æ´
    }

    /**
     * ç¡®å®šæ—¥é£Ÿ/æœˆé£Ÿç±»å‹ï¼ˆåŸºäºé£Ÿç”šæ—¶åˆ»çš„å¤©æ–‡æ¡ä»¶ï¼‰
     * è¿™ä¸ªå‡½æ•°ä¼šå¯»æ‰¾å®Œæ•´æ—¥é£Ÿ/æœˆé£Ÿè¿‡ç¨‹çš„å³°å€¼æ—¶åˆ»ï¼Œå¹¶ç¡®å®šæ•´ä¸ªè¿‡ç¨‹çš„ç±»å‹
     */
    function determineEclipseType(currentDay) {
      // æœç´¢å½“å‰æ—¶é—´å‰å5å¤©å†…çš„æ‰€æœ‰å¯èƒ½çš„æ—¥é£Ÿ/æœˆé£Ÿæ—¶åˆ»
      let bestAlignment = 0;
      let bestDay = currentDay;
      let bestEclipseType = 'partial';
      let bestEclipseKind = '';
      let bestNodeDistance = Infinity;
      
      // æ‰©å¤§æœç´¢èŒƒå›´ï¼Œç²¾åº¦æé«˜
      for (let dayOffset = -5; dayOffset <= 5; dayOffset += 0.05) {
        const testDay = currentDay + dayOffset;
        const syzygyData = calculateSyzygyProgressForDay(testDay);
        const nodeData = calculateMoonNodePosition(testDay);
        
        // æ£€æŸ¥æ˜¯å¦æ¥è¿‘é»„ç™½äº¤ç‚¹ä¸”å¯¹é½ç¨‹åº¦è¶³å¤Ÿé«˜
        if (syzygyData.progress > ECLIPSE_THRESHOLDS.ALIGNMENT && nodeData.isNearNode) {
          // åˆ¤æ–­æ˜¯æ—¥é£Ÿè¿˜æ˜¯æœˆé£Ÿ
          if (syzygyData.moonPhase < 20 || syzygyData.moonPhase > 340) {
            // æ–°æœˆ - æ—¥é£Ÿ
            if (syzygyData.progress > bestAlignment) {
              bestAlignment = syzygyData.progress;
              bestDay = testDay;
              bestEclipseKind = 'solar';
              bestNodeDistance = nodeData.minDistanceFromNode;
            }
          } else if (syzygyData.moonPhase > 160 && syzygyData.moonPhase < 200) {
            // æ»¡æœˆ - æœˆé£Ÿ
            if (syzygyData.progress > bestAlignment) {
              bestAlignment = syzygyData.progress;
              bestDay = testDay;
              bestEclipseKind = 'lunar';
              bestNodeDistance = nodeData.minDistanceFromNode;
            }
          }
        }
      }
      
      if (bestAlignment > 70) {
        // æ ¹æ®é£Ÿç”šæ—¶åˆ»çš„äº¤ç‚¹è·ç¦»ç¡®å®šç±»å‹ï¼ˆåªåœ¨è¿™é‡Œç¡®å®šä¸€æ¬¡ï¼‰
        // è¿™ä¸ªåˆ¤æ–­åŸºäºé£Ÿç”šæ—¶åˆ»çš„å¤©æ–‡æ¡ä»¶ï¼Œæ•´ä¸ªè¿‡ç¨‹ä¿æŒä¸å˜
        bestEclipseType = determineEclipseTypeUnified(bestNodeDistance);
        
        console.log(`ç¡®å®š${bestEclipseKind === 'solar' ? 'æ—¥é£Ÿ' : 'æœˆé£Ÿ'}ç±»å‹: ${bestEclipseType === 'total' ? 'å…¨é£Ÿ' : 'åé£Ÿ'}, é£Ÿç”šæ—¶åˆ»: ${bestDay.toFixed(2)}å¤©, æœ€ä½³å¯¹é½: ${bestAlignment.toFixed(1)}%, äº¤ç‚¹è·ç¦»: ${(bestNodeDistance * 180 / Math.PI).toFixed(1)}Â°`);
        console.log(`ä½¿ç”¨ç»Ÿä¸€æ ‡å‡† - å…¨é£Ÿé˜ˆå€¼: ${(ECLIPSE_THRESHOLDS.TOTAL * 180 / Math.PI).toFixed(1)}Â°, åé£Ÿé˜ˆå€¼: ${(ECLIPSE_THRESHOLDS.PARTIAL * 180 / Math.PI).toFixed(1)}Â°, å¯¹é½é˜ˆå€¼: ${ECLIPSE_THRESHOLDS.ALIGNMENT}%`);
        console.log(`ç±»å‹åˆ¤æ–­ä¾æ®: äº¤ç‚¹è·ç¦» ${(bestNodeDistance * 180 / Math.PI).toFixed(1)}Â° ${bestNodeDistance < ECLIPSE_THRESHOLDS.TOTAL ? '<' : '>='} å…¨é£Ÿé˜ˆå€¼ ${(ECLIPSE_THRESHOLDS.TOTAL * 180 / Math.PI).toFixed(1)}Â° â†’ ${bestEclipseType === 'total' ? 'å…¨é£Ÿ' : 'åé£Ÿ'}`);
        
        return {
          isEclipse: true,
          kind: bestEclipseKind,
          type: bestEclipseType,
          bestDay: bestDay,
          bestAlignment: bestAlignment,
          nodeDistance: bestNodeDistance
        };
      }
      
      return {
        isEclipse: false,
        kind: '',
        type: '',
        bestDay: currentDay,
        bestAlignment: 0,
        nodeDistance: Infinity
      };
    }
    
    /**
     * è®¡ç®—æ—¥é£Ÿ/æœˆé£Ÿçš„è¿›åº¦
     * @param {Object} syzygyData - å¯¹é½æ•°æ®
     * @returns {Object} - åŒ…å«è¿›åº¦å’Œç±»å‹çš„å¯¹è±¡
     * ä¿®æ”¹ç‰ˆï¼šä½¿ç”¨é¢„å…ˆç¡®å®šçš„æ—¥é£Ÿç±»å‹ï¼Œç¡®ä¿æ•´ä¸ªè¿‡ç¨‹ä¿æŒä¸€è‡´
     */
    function calculateEclipseProgress(syzygyData) {
      const nodeData = calculateMoonNodePosition(days);
      
      // æ£€æŸ¥æ˜¯å¦æ¥è¿‘é»„ç™½äº¤ç‚¹ä¸”å¯¹é½ç¨‹åº¦è¶³å¤Ÿé«˜
      const isNearNode = nodeData.isNearNode;
      const alignmentProgress = syzygyData.progress;
      
      // åªæœ‰å½“å¯¹é½ç¨‹åº¦>é˜ˆå€¼ä¸”æ¥è¿‘äº¤ç‚¹æ—¶æ‰è®¤ä¸ºæ˜¯æ—¥é£Ÿ/æœˆé£Ÿ
      if (alignmentProgress > ECLIPSE_THRESHOLDS.ALIGNMENT && isNearNode) {
        let eclipseProgress = 0;
        let isEclipse = false;
        let eclipseKind = '';
        let eclipseType = 'partial';
        
        // åˆ¤æ–­æ˜¯æ—¥é£Ÿè¿˜æ˜¯æœˆé£Ÿ
        if (syzygyData.moonPhase < 20 || syzygyData.moonPhase > 340) {
          // æ–°æœˆ - æ—¥é£Ÿ
          isEclipse = true;
          eclipseKind = 'solar';
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç¡®å®šæ—¥é£Ÿç±»å‹
          // å¦‚æœæ˜¯ç”¨æˆ·æ‰‹åŠ¨è·³è½¬çš„ï¼Œç»ä¸é‡æ–°è®¡ç®—ç±»å‹
          const isUserJumped = currentEclipseInfo && currentEclipseInfo.userJumped;
          const needsNewType = !currentEclipseInfo || 
                               (currentEclipseInfo.kind !== 'solar' && !isUserJumped);
          
          if (needsNewType && !isUserJumped) {
            console.log('é‡æ–°ç¡®å®šæ—¥é£Ÿç±»å‹ï¼ŒåŸå› ï¼š', {
              noInfo: !currentEclipseInfo,
              wrongKind: currentEclipseInfo && currentEclipseInfo.kind !== 'solar',
              currentDay: days,
              bestDay: currentEclipseInfo ? currentEclipseInfo.bestDay : 'none'
            });
            currentEclipseInfo = determineEclipseType(days);
            console.log('ç¡®å®šæ—¥é£Ÿç±»å‹ï¼š', currentEclipseInfo);
          } else {
            console.log('ä½¿ç”¨å·²å­˜åœ¨çš„æ—¥é£Ÿç±»å‹ä¿¡æ¯ï¼š', currentEclipseInfo.type, isUserJumped ? '(ç”¨æˆ·æ‰‹åŠ¨è·³è½¬ï¼Œç¦æ­¢é‡æ–°è®¡ç®—)' : '');
          }
          
          // ä½¿ç”¨é¢„å…ˆç¡®å®šçš„æ—¥é£Ÿç±»å‹ï¼ˆæ•´ä¸ªè¿‡ç¨‹ä¿æŒä¸å˜ï¼‰
          eclipseType = currentEclipseInfo.type;
          
          // è®¡ç®—çº¿æ€§æ—¶é—´è¿›åº¦å’Œé®æŒ¡å¼ºåº¦
          const eclipseDuration = 3.0; // æ—¥é£ŸæŒç»­æ—¶é—´çº¦3å¤©
          const eclipseStart = currentEclipseInfo.bestDay - eclipseDuration / 2;
          const eclipseEnd = currentEclipseInfo.bestDay + eclipseDuration / 2;
          
          if (days >= eclipseStart && days <= eclipseEnd) {
            // çº¿æ€§æ—¶é—´è¿›åº¦ï¼ˆæ§åˆ¶é˜´å½±ä½ç½®ï¼‰
            const timeProgress = (days - eclipseStart) / eclipseDuration;
            
            // é®æŒ¡å¼ºåº¦ï¼ˆåŸºäºå¯¹é½ç¨‹åº¦å’Œäº¤ç‚¹è·ç¦»ï¼‰
            const alignmentFactor = Math.max(0, (alignmentProgress - ECLIPSE_THRESHOLDS.ALIGNMENT) / 30); // 0-1
            const nodeFactor = Math.max(0, 1 - nodeData.minDistanceFromNode / ECLIPSE_THRESHOLDS.PARTIAL); // 0-1
            const eclipseIntensity = alignmentFactor * nodeFactor;
            
            // ç»„åˆè¿›åº¦ï¼šæ—¶é—´è¿›åº¦æ§åˆ¶ä½ç½®ï¼Œå¼ºåº¦æ§åˆ¶é®æŒ¡æ•ˆæœ
            eclipseProgress = {
              timeProgress: timeProgress,
              intensity: eclipseIntensity,
              combined: timeProgress * Math.max(0.3, eclipseIntensity) // ç¡®ä¿æœ€å°‘30%çš„å¯è§åº¦
            };
          } else {
            eclipseProgress = {
              timeProgress: 0,
              intensity: 0,
              combined: 0
            };
          }
          
        } else if (syzygyData.moonPhase > 160 && syzygyData.moonPhase < 200) {
          // æ»¡æœˆ - æœˆé£Ÿ
          isEclipse = true;
          eclipseKind = 'lunar';
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°ç¡®å®šæœˆé£Ÿç±»å‹
          // å¦‚æœæ˜¯ç”¨æˆ·æ‰‹åŠ¨è·³è½¬çš„ï¼Œç»ä¸é‡æ–°è®¡ç®—ç±»å‹
          const isUserJumped = currentEclipseInfo && currentEclipseInfo.userJumped;
          const needsNewType = !currentEclipseInfo || 
                               (currentEclipseInfo.kind !== 'lunar' && !isUserJumped);
          
          if (needsNewType && !isUserJumped) {
            console.log('é‡æ–°ç¡®å®šæœˆé£Ÿç±»å‹ï¼ŒåŸå› ï¼š', {
              noInfo: !currentEclipseInfo,
              wrongKind: currentEclipseInfo && currentEclipseInfo.kind !== 'lunar',
              currentDay: days,
              bestDay: currentEclipseInfo ? currentEclipseInfo.bestDay : 'none'
            });
            currentEclipseInfo = determineEclipseType(days);
            console.log('ç¡®å®šæœˆé£Ÿç±»å‹ï¼š', currentEclipseInfo);
          } else {
            console.log('ä½¿ç”¨å·²å­˜åœ¨çš„æœˆé£Ÿç±»å‹ä¿¡æ¯ï¼š', currentEclipseInfo.type, isUserJumped ? '(ç”¨æˆ·æ‰‹åŠ¨è·³è½¬ï¼Œç¦æ­¢é‡æ–°è®¡ç®—)' : '');
          }
          
          // ä½¿ç”¨é¢„å…ˆç¡®å®šçš„æœˆé£Ÿç±»å‹ï¼ˆæ•´ä¸ªè¿‡ç¨‹ä¿æŒä¸å˜ï¼‰
          eclipseType = currentEclipseInfo.type;
          
          // è®¡ç®—çº¿æ€§æ—¶é—´è¿›åº¦å’Œé®æŒ¡å¼ºåº¦
          const eclipseDuration = 3.0; // æœˆé£ŸæŒç»­æ—¶é—´çº¦3å¤©
          const eclipseStart = currentEclipseInfo.bestDay - eclipseDuration / 2;
          const eclipseEnd = currentEclipseInfo.bestDay + eclipseDuration / 2;
          
          if (days >= eclipseStart && days <= eclipseEnd) {
            // çº¿æ€§æ—¶é—´è¿›åº¦ï¼ˆæ§åˆ¶é˜´å½±ä½ç½®ï¼‰
            const timeProgress = (days - eclipseStart) / eclipseDuration;
            
            // é®æŒ¡å¼ºåº¦ï¼ˆåŸºäºå¯¹é½ç¨‹åº¦å’Œäº¤ç‚¹è·ç¦»ï¼‰
            const alignmentFactor = Math.max(0, (alignmentProgress - ECLIPSE_THRESHOLDS.ALIGNMENT) / 30); // 0-1
            const nodeFactor = Math.max(0, 1 - nodeData.minDistanceFromNode / ECLIPSE_THRESHOLDS.PARTIAL); // 0-1
            const eclipseIntensity = alignmentFactor * nodeFactor;
            
            // ç»„åˆè¿›åº¦ï¼šæ—¶é—´è¿›åº¦æ§åˆ¶ä½ç½®ï¼Œå¼ºåº¦æ§åˆ¶é®æŒ¡æ•ˆæœ
            eclipseProgress = {
              timeProgress: timeProgress,
              intensity: eclipseIntensity,
              combined: timeProgress * Math.max(0.3, eclipseIntensity) // ç¡®ä¿æœ€å°‘30%çš„å¯è§åº¦
            };
          } else {
            eclipseProgress = {
              timeProgress: 0,
              intensity: 0,
              combined: 0
            };
          }
        }
        
        return {
          isEclipse: isEclipse,
          progress: typeof eclipseProgress === 'object' ? eclipseProgress : {
            timeProgress: eclipseProgress,
            intensity: eclipseProgress,
            combined: eclipseProgress
          },
          kind: eclipseKind, // 'solar' æˆ– 'lunar'
          type: eclipseType, // 'total' æˆ– 'partial'
          alignmentProgress: alignmentProgress,
          nodeDistance: nodeData.minDistanceFromNode
        };
      }
      
      // å¦‚æœä¸å†æ»¡è¶³æ—¥é£Ÿ/æœˆé£Ÿæ¡ä»¶ï¼Œä½†ä»åœ¨æ—¥é£Ÿæ¨¡å¼ï¼Œè¿™æ˜¯æ­£å¸¸çš„
      // å› ä¸ºæ—¥é£Ÿè¿‡ç¨‹ä¸­ä¼šæœ‰è¿›åº¦ä¸º0çš„æ—¶åˆ»ï¼Œä¸åº”è¯¥æ¸…é™¤ç±»å‹ä¿¡æ¯
      // ç±»å‹ä¿¡æ¯åªåœ¨æ¨¡å¼åˆ‡æ¢æ—¶æ¸…é™¤
      
      return {
        isEclipse: false,
        progress: 0,
        kind: '',
        type: '',
        alignmentProgress: alignmentProgress,
        nodeDistance: nodeData.minDistanceFromNode
      };
    }

    /**
     * å¼€å§‹2Dæ—¥é£Ÿ/æœˆé£ŸåŠ¨ç”»å¾ªç¯
     */
    function start2DEclipseAnimation() {
      function animate2DEclipse() {
        if (!isEclipseMode || !eclipse2DCtx) return;
        
        const syzygyData = calculateSyzygyProgress();
        const eclipseData = calculateEclipseProgress(syzygyData);
        
        if (eclipseData.isEclipse) {
          if (eclipseData.kind === 'solar') {
            draw2DSolarEclipse(eclipseData.progress, eclipseData.type);
          } else if (eclipseData.kind === 'lunar') {
            draw2DLunarEclipse(eclipseData.progress, eclipseData.type);
          }
        }
        
        eclipseAnimationId = requestAnimationFrame(animate2DEclipse);
      }
      
      animate2DEclipse();
    }

    /**
     * è°ƒæ•´2Dæ—¥é£Ÿ/æœˆé£ŸCanvaså¤§å°
     */
    function resize2DEclipse() {
      if (!eclipse2DCanvas) return;
      
      const container = document.getElementById('moonPhase3D');
      if (!container) return;
      
      const containerRect = container.getBoundingClientRect();
      if (containerRect.width === 0 || containerRect.height === 0) return;
      
      eclipse2DCanvas.width = containerRect.width;
      eclipse2DCanvas.height = containerRect.height;
    }
    
    // åˆå§‹åŒ–3Dæœˆç›¸åœºæ™¯ï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿DOMåŠ è½½å®Œæˆï¼‰
    setTimeout(() => {
      if (document.getElementById('moonPhase3D') && pipContainer.style.display !== 'none') {
        init3DMoonPhase();
      }
    }, 500);

    function  stepSimulation(dayDelta, totalDaysFlag = false) {
      if(!totalDaysFlag){
          //æ—¥æœŸæ›´æ–°
          days += dayDelta;
          dateCurrent = new Date(dateOrigin.getTime() + days * 24 * 60 * 60 * 1000);
          updateDate();
          // å¤©ä½“è½¬åŠ¨
          sun.rotation.y += dayDelta * sunRotateAnglePerDay;
          earthOrbit.rotation.y += dayDelta * earthRevolveAnglePerDay;
          earthRotationGroup.rotation.z = 0;
          earthSphere.rotation.y += dayDelta * earthRotateAnglePerDay;
          earthRotationGroup.rotation.z = 0.41015;
          moonOrbit.rotation.y += dayDelta * (moonRevolveAnglePerDay);
          moonOrbitGroup.rotation.y += dayDelta * moonOrbitPrecessionPerDay;
          moon.rotation.y += 0;
      }
      else{
          days = dayDelta;
          dateCurrent = new Date(dateOrigin.getTime() + days * 24 * 60 * 60 * 1000);
          updateDate();
          // å¤©ä½“è½¬åŠ¨
          sun.rotation.y = days * sunRotateAnglePerDay;
          earthOrbit.rotation.y = days * earthRevolveAnglePerDay;
          earthRotationGroup.rotation.z = 0;
          earthSphere.rotation.y = days * earthRotateAnglePerDay;
          earthRotationGroup.rotation.z = 0.41015;
          moonOrbit.rotation.y = days * (moonRevolveAnglePerDay);
          moonOrbitGroup.rotation.y = days * moonOrbitPrecessionPerDay;
      }
      
      // æ›´æ–°æœˆç›¸æ˜¾ç¤ºï¼ˆåªåœ¨æ—¶é—´å˜åŒ–æ—¶æ›´æ–°ï¼‰
      updateMoonPhaseDisplayOptimized();
    }

    /* * * * * * * * * * * *
     * uiç•Œé¢å’Œäº¤äº’å‡½æ•°
     * * * * * * * * * * * */
    //äº‹ä»¶ç»‘å®š
    controlBtn.addEventListener('click', switchControlPanel);
    controlPanel.addEventListener('mouseenter', () => { 
      mouseOnPanel = true;
    });
    controlPanel.addEventListener('mouseleave', () => {
      mouseOnPanel = false;
    });
    tabs.forEach(tab => { tab.addEventListener('click', switchTab); });
    earthTextureRadios.forEach(radio => { 
      radio.addEventListener('change', () => {
        if (radio.checked) changeEarthTexture(radio.value);
      }); 
    });
    sunTextureRadios.forEach(radio => { 
      radio.addEventListener('change', () => {
        if (radio.checked) changeSunTexture(radio.value);
      }); 
    });
    starlandRadios.forEach(radio => { 
      radio.addEventListener('change', () => {
        if (radio.checked) changeStarland(radio.value);
      }); 
    });
    speedInput.addEventListener('input', changeSpeedFactor);
    stopSwitch.addEventListener('change', changeStopSwitch);
    reserveSwitch.addEventListener('change', changeReserveSwitch);
    axisSwitch.addEventListener('change', changeAxisVisibility);
    prevPageBtn.addEventListener('click', prevHelpPage);
    nextPageBtn.addEventListener('click', nextHelpPage);
    moonNormalSwitch.addEventListener('change', changeMoonNormalVisibility);
    pipMinimize.addEventListener('click', togglePipMinimize);
    pipClose.addEventListener('click', togglePipVisibility);

    // æœˆçƒè·ç¦»é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
    const pipMoonDistanceSelect = document.getElementById('pipMoonDistanceSelect');
    if (pipMoonDistanceSelect) {
      pipMoonDistanceSelect.addEventListener('change', function() {
        // å½“æœˆçƒè·ç¦»è®¾ç½®æ”¹å˜æ—¶ï¼Œé‡æ–°æ¸²æŸ“æ—¥é£Ÿç”»é¢
        if (isPipVisible) {
          updateMoonPhaseDisplay();
        }
      });
    }

    // æ—¥é£Ÿå’Œæœˆé£ŸæŒ‰é’®äº‹ä»¶ç»‘å®š
    document.getElementById('nextSolarEclipse').addEventListener('click', jumpToNextSolarEclipse);
    document.getElementById('nextLunarEclipse').addEventListener('click', jumpToNextLunarEclipse);
    document.getElementById('nextTotalSolarEclipse').addEventListener('click', jumpToNextTotalSolarEclipse);
    document.getElementById('nextPartialSolarEclipse').addEventListener('click', jumpToNextPartialSolarEclipse);
    document.getElementById('nextTotalLunarEclipse').addEventListener('click', jumpToNextTotalLunarEclipse);
    document.getElementById('nextPartialLunarEclipse').addEventListener('click', jumpToNextPartialLunarEclipse);

    
    // ç”»ä¸­ç”»å¼€å…³äº‹ä»¶ç»‘å®š
    PIPSwitch.addEventListener('change', function() {
      if (PIPSwitch.checked) {
        pipContainer.style.display = 'block';
        isPipVisible = true;
        // å¼‚æ­¥åˆå§‹åŒ–3Dåœºæ™¯
        setTimeout(() => {
          if (init3DMoonPhase()) {
            // ç›´æ¥æ›´æ–°æœˆç›¸æ˜¾ç¤ºï¼Œä¸éœ€è¦åˆå§‹åŒ–è¿‡æ¸¡å‚æ•°
            updateMoonPhaseDisplay();
          } else {
            // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œå†å°è¯•ä¸€æ¬¡
            setTimeout(() => {
              if (init3DMoonPhase()) {
                updateMoonPhaseDisplay();
              } else {
                console.warn('3Dæœˆç›¸åœºæ™¯åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥DOMç»“æ„');
              }
            }, 500);
          }
        }, 100);
      } else {
        pipContainer.style.display = 'none';
        isPipVisible = false;
        // æ¸…ç†æ‰€æœ‰èµ„æº
        cleanup3DMoonPhase();
        cleanup2DEclipse();
        isEclipseMode = false;
      }
    });
    moonNodesSwitch.addEventListener('change', changeMoonNodesVisibility);
    
    // çª—å£å¤§å°è°ƒæ•´äº‹ä»¶ç›‘å¬å™¨
    window.addEventListener('resize', function() {
      // è°ƒæ•´ä¸»æ¸²æŸ“å™¨å¤§å°
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      
      // è°ƒæ•´3Dæœˆç›¸æ¸²æŸ“å™¨å¤§å°
      resize3DMoonPhase();
      
      // è°ƒæ•´2Dæ—¥é£Ÿ/æœˆé£ŸCanvaså¤§å°
      resize2DEclipse();
    });
    
    //æ§åˆ¶é¢æ¿å¼€å…³
    function switchControlPanel(){
      if (isControlPanelOpen) {
        controlPanel.classList.remove('open');
        controlBtn.style.left = '24px';
        isControlPanelOpen = false;
      }
      else{
        controlPanel.classList.add('open');
        controlBtn.style.left = '400px';
        isControlPanelOpen = true;
      }
    }

    //æ§åˆ¶é¢æ¿æ ‡ç­¾é¡µåˆ‡æ¢
    function switchTab() {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    }

    //ä¿®æ”¹åœ°çƒçº¹ç†
    function changeEarthTexture(value) {
      if (value == "common-map"){
        earthMaterial.map = earthTextureCommon;
        earthMaterial.color = new THREE.Color(0xcccccc);
      }
      else if (value == "satellite-map"){
        earthMaterial.map = earthTextureSatellite;
        earthMaterial.color = new THREE.Color(0xcfe3fc);
      }
      else{
        earthMaterial.map = earthTextureBlue;
        earthMaterial.color = new THREE.Color(0x4488ff);
      }
    }

    //ä¿®æ”¹å¤ªé˜³çº¹ç†
    function changeSunTexture(value) {
      if (value == "true-surface"){
        sunMaterial.map = sunTextureTrue;
        sunMaterial.emissiveMap = sunTextureTrue;
      }
      else{
        sunMaterial.map = sunTextureOrange;
        sunMaterial.emissiveMap = sunTextureOrange;
      }
    }

    //ä¿®æ”¹æ˜Ÿç©ºæ˜¾ç¤º
    function changeStarland(value) {
      if (value == "stars"){
        starfield.visible = true;
      }
      else{
        starfield.visible = false;
      }
    }

    //ä¿®æ”¹åœ°è½´æ˜¾ç¤º
    function changeAxisVisibility() {
      earthAxisGroup.visible = axisSwitch.checked;
    }

    //ä¿®æ”¹æœˆçƒè½¨é“æ³•å‘é‡æ˜¾ç¤º
    function changeMoonNormalVisibility() {
      moonOrbitNormalGroup.visible = moonNormalSwitch.checked;
    }

    //ä¿®æ”¹é»„ç™½äº¤ç‚¹æ˜¾ç¤º
    function changeMoonNodesVisibility() {
      ascendingNode.visible = moonNodesSwitch.checked;
      descendingNode.visible = moonNodesSwitch.checked;
      // åŒæ—¶æ§åˆ¶æœˆçƒäº¤ç‚¹æ ‡ç­¾çš„å¯è§æ€§
      nodeLabels.ascending.visible = moonNodesSwitch.checked;
      nodeLabels.descending.visible = moonNodesSwitch.checked;
    }

    //ä¿®æ”¹é€Ÿåº¦
    function changeSpeedFactor() {
      speedFactor = 2 ** speedInput.value;
      if (speedFactor < 1)
        speedFactor = speedFactor.toFixed(2);
      else
        speedFactor = speedFactor.toFixed(0);
      speedLabel.innerHTML = 'x' + speedFactor;
      toolSpeed.innerHTML = "<i>x" + speedFactor + "</i>";
      dashboardSpeed.innerHTML = speedFactor + 'day/s';
    }

    //æš‚åœã€è¿è¡Œ
    function changeStopSwitch() {
      if (stopSwitch.checked){
        isPaused = true;
        toolPause.innerHTML = '<i class="fa fa-play"></i>';
      }
      else{
        isPaused = false;
        toolPause.innerHTML = '<i class="fa fa-pause"></i>';
      }
    }

    //å€’é€€è¿è¡Œ
    function changeReserveSwitch() {
      if (reserveSwitch.checked)
        isbackwards = true;
      else
        isbackwards = false;
    }

    //æ—¥æœŸè·³è½¬By
    function dateJumpBy(value) { 
      dayDelta = value;
      stepSimulation(dayDelta);
    }

    //å°å·¥å…·æ¡ï¼šæš‚åœ
    function clickOnToolPause() {
      stopSwitch.checked = !stopSwitch.checked;
      changeStopSwitch();
    }

    //å°å·¥å…·æ¡ï¼šé€Ÿåº¦
    function clickOnToolSpeed(value) {
      if(speedFactor >= 1 && speedFactor < 4) 
        speedInput.value = 2;
      else if(speedFactor >= 4 && speedFactor < 16) 
        speedInput.value = 4;
      else if(speedFactor >= 16 && speedFactor < 64) 
        speedInput.value = 6;
      else
        speedInput.value = 0;
      changeSpeedFactor();
    }

    //å°å·¥å…·æ¡ï¼šæˆªå›¾
    function clickOnToolScreenshot() {
      rendererLock = true;
      renderer.render(scene, camera);
      var imgData = renderer.domElement.toDataURL("image/png");
      rendererLock = false;
      var link = document.createElement('a');
      link.href = imgData;
      link.download = 'screenshot.png';
      link.click();
    }

    //å¸®åŠ©çª—å£ç›¸å…³å“åº”
    function clickOnToolHelp() {
      modalMask.style.display = 'flex';
      jumpToHelpPage(0);
    }

    function closeHelpWindow() {
      modalMask.style.display = 'none';
    }

    function nextHelpPage() {
      if(currentHelpPage < 5)
        jumpToHelpPage(currentHelpPage + 1);
      else return;
    }

    function prevHelpPage() {
      if(currentHelpPage > 0)
        jumpToHelpPage(currentHelpPage - 1);
      else return;
    }

    function jumpToHelpPage(page) {
      if(page >= 0 && page <= 5) {
        currentHelpPage = page;
        helpPages.style.transform = 'translateX(' + (-page * 16.66) + '%)';
        pageSwitcherDots.forEach((dot) => {
          dot.classList.remove('active'); 
        })
        pageSwitcherDots[page].classList.add('active');
        prevPageBtn.style.opacity = page === 0 ? '0' : '1';
        nextPageBtn.style.opacity = page === 5 ? '0' : '1';
      }
    }

    //æ—¥æœŸæ›´æ–°
    function updateDate() {
      // è®¡ç®—æ²™ç½—å‘¨æœŸè¿›åº¦
      var sarosProgress = ((days % sarosCurrent) / sarosCurrent * 100);
      if(sarosProgress < 0) sarosProgress = 100 + sarosProgress;
      dashboardSaros.innerHTML = sarosProgress.toFixed(2) + '%';
      
      // è®¡ç®—å¹¶æ˜¾ç¤ºæœˆç›¸çŠ¶æ€
      updateMoonPhaseDisplay();
      
    }

    //ç”»ä¸­ç”»æœ€å°åŒ–åˆ‡æ¢
    function togglePipMinimize() {
      isPipMinimized = !isPipMinimized;
      if (isPipMinimized) {
        pipContainer.classList.add('minimized');
        pipMinimize.innerHTML = '<i class="fa fa-plus"></i>';
        pipMinimize.title = 'å±•å¼€';
      } else {
        pipContainer.classList.remove('minimized');
        pipMinimize.innerHTML = '<i class="fa fa-minus"></i>';
        pipMinimize.title = 'æœ€å°åŒ–';
      }
    }

    //ç”»ä¸­ç”»æ˜¾ç¤º/éšè—åˆ‡æ¢
    function togglePipVisibility() {
      isPipVisible = !isPipVisible;
      pipContainer.style.display = isPipVisible ? 'block' : 'none';
      // åŒæ­¥æ›´æ–°æ§åˆ¶é¢æ¿ä¸­çš„å¼€å…³çŠ¶æ€
      PIPSwitch.checked = isPipVisible;
      
      // å¦‚æœéšè—ï¼Œæ¸…ç†æ‰€æœ‰èµ„æº
      if (!isPipVisible) {
        cleanup3DMoonPhase();
        cleanup2DEclipse();
        isEclipseMode = false;
      }
    }

      // è§†è§’åˆ‡æ¢ç›¸å…³å˜é‡ä¸å‡½æ•°
      const topViewRadio = document.getElementById('top-view');
      const sideViewRadio = document.getElementById('side-view');
      const view3DRadio = document.getElementById('3D-view');

      function switchToTopView() {
          isViewLocked = true;
          camera.position.set(0, 15, 0);
          camera.up.set(0, 0, -1);
          camera.lookAt(scene.position);
      }

      function switchToSideView() {
          isViewLocked = true;
          camera.position.set(15, 0, 0);
          camera.up.set(0, 1, 0);
          camera.lookAt(scene.position);
      }

      function switchTo3DView() {
          isViewLocked = false;
      }

      function clickOnToolView(){
        if (topViewRadio.checked) {
          switchToSideView();
          topViewRadio.checked = false;
          sideViewRadio.checked = true;
        }
        else if (sideViewRadio.checked) {
          switchTo3DView();
          sideViewRadio.checked = false;
          view3DRadio.checked = true;
        }
        else if (view3DRadio.checked) {
          switchToTopView();
          view3DRadio.checked = false;
          topViewRadio.checked = true;
        }
      }

      // ç»‘å®šæŒ‰é’®äº‹ä»¶
      topViewRadio.addEventListener('change', () => {
          if (topViewRadio.checked) switchToTopView();
      });
      sideViewRadio.addEventListener('change', () => {
          if (sideViewRadio.checked) switchToSideView();
      });
      view3DRadio.addEventListener('change', () => {
          if (view3DRadio.checked) switchTo3DView();
      });

    
    /**
     * è®¡ç®—æ—¥åœ°æœˆä¸‰å¤©ä½“å¯¹é½è¿›åº¦
     * ä¿®æ­£ç‰ˆï¼šæ­£ç¡®è®¡ç®—æœˆçƒç›¸å¯¹äºæ—¥åœ°è¿çº¿çš„è§’åº¦ä½ç½®
     */
    function calculateSyzygyProgress() {
      // è·å–å½“å‰å¤©ä½“è§’åº¦ä½ç½®
      const earthAngle = earthOrbit.rotation.y; // åœ°çƒç»•å¤ªé˜³çš„è§’åº¦
      const moonOrbitPrecession = moonOrbitGroup.rotation.y; // æœˆçƒè½¨é“è¿›åŠ¨
      const moonInOrbit = moonOrbit.rotation.y; // æœˆçƒåœ¨è½¨é“å†…çš„è§’åº¦ï¼ˆæ’æ˜Ÿåæ ‡ç³»ï¼‰
      
      // æœˆç›¸è®¡ç®—ï¼šç›´æ¥ä½¿ç”¨æœˆçƒç›¸å¯¹åœ°çƒçš„è§’åº¦ï¼Œå¿½ç•¥è½¨é“è¿›åŠ¨çš„å¾®å°å½±å“
      // æœˆçƒåœ¨å¤ªé˜³åæ ‡ç³»ä¸­çš„è§’åº¦ = åœ°çƒè§’åº¦ + æœˆçƒç›¸å¯¹åœ°çƒçš„è§’åº¦
      const moonRelativeToEarth = moonInOrbit + moonOrbitPrecession;
      
      // è®¡ç®—æœˆç›¸è§’åº¦ï¼šä»åœ°çƒçœ‹æœˆçƒç›¸å¯¹äºå¤ªé˜³çš„è§’åº¦
      // å…³é”®ä¿®æ­£ï¼šæœˆç›¸è§’åº¦åº”è¯¥æ˜¯æœˆçƒç›¸å¯¹åœ°çƒèƒŒå‘å¤ªé˜³æ–¹å‘çš„è§’åº¦
      // å½“moonRelativeToEarth=0æ—¶ï¼Œæœˆçƒåœ¨åœ°çƒ"å‰æ–¹"ï¼ˆé¢å‘å¤ªé˜³ä¾§ï¼‰ï¼Œåº”è¯¥æ˜¯æ»¡æœˆï¼ˆ180Â°ï¼‰
      // å½“moonRelativeToEarth=Ï€æ—¶ï¼Œæœˆçƒåœ¨åœ°çƒ"åæ–¹"ï¼ˆèƒŒç¦»å¤ªé˜³ä¾§ï¼‰ï¼Œåº”è¯¥æ˜¯æ–°æœˆï¼ˆ0Â°ï¼‰
      let moonPhaseAngle = (moonRelativeToEarth + Math.PI) % (2 * Math.PI);
      if (moonPhaseAngle < 0) moonPhaseAngle += 2 * Math.PI;
      
      // å°†è§’åº¦æ ‡å‡†åŒ–åˆ° [0, Ï€] èŒƒå›´ï¼Œç”¨äºè®¡ç®—å¯¹é½åº¦
      let alignmentAngle = Math.abs(moonPhaseAngle);
      if (alignmentAngle > Math.PI) {
        alignmentAngle = 2 * Math.PI - alignmentAngle;
      }
      
      // è®¡ç®—å¯¹é½è¿›åº¦
      // æ–°æœˆæˆ–æ»¡æœˆæ—¶å¯¹é½åº¦æœ€é«˜(100%)ï¼Œä¸Šå¼¦ä¸‹å¼¦æ—¶æœ€ä½(0%)
      let alignmentProgress;
      if (alignmentAngle <= Math.PI/2) {
        // æ–°æœˆæ–¹å‘å¯¹é½
        alignmentProgress = (Math.PI/2 - alignmentAngle) / (Math.PI/2) * 100;
      } else {
        // æ»¡æœˆæ–¹å‘å¯¹é½
        alignmentProgress = (alignmentAngle - Math.PI/2) / (Math.PI/2) * 100;
      }
      
      // åˆ¤æ–­æœˆç›¸å’Œå¯¹é½ç±»å‹
      let alignmentType = '';
      const phaseDegrees = moonPhaseAngle * 180 / Math.PI;
      
      // æ£€æŸ¥æ˜¯å¦æ¥è¿‘é»„ç™½äº¤ç‚¹ï¼ˆæ—¥æœˆé£Ÿå¯èƒ½ï¼‰
      const nodeData = calculateMoonNodePosition(days);
      const isNearNode = nodeData.isNearNode;
      
      // ä½¿ç”¨é¢„å…ˆç¡®å®šçš„æ—¥é£Ÿ/æœˆé£Ÿç±»å‹ï¼Œç¡®ä¿æ•´ä¸ªè¿‡ç¨‹ä¿æŒä¸€è‡´
      let effectiveEclipseType = 'none';
      if (currentEclipseInfo && isNearNode) {
        // æ£€æŸ¥æ˜¯å¦åœ¨å½“å‰æ—¥é£Ÿ/æœˆé£Ÿè¿‡ç¨‹ä¸­ï¼ˆæ‰©å¤§æ—¶é—´èŒƒå›´ï¼‰
        const timeFromBest = Math.abs(days - currentEclipseInfo.bestDay);
        if (timeFromBest <= 2.5) { // åœ¨é£Ÿç”šå‰å2.5å¤©å†…ï¼ˆè¦†ç›–å®Œæ•´çš„è·³è½¬èŒƒå›´ï¼‰
          if (phaseDegrees < 20 || phaseDegrees > 340) {
            // æ–°æœˆæœŸé—´ï¼Œä½¿ç”¨é¢„å…ˆç¡®å®šçš„æ—¥é£Ÿç±»å‹
            if (currentEclipseInfo.kind === 'solar') {
              effectiveEclipseType = currentEclipseInfo.type;
              console.log(`ä½¿ç”¨é¢„è®¾æ—¥é£Ÿç±»å‹: ${effectiveEclipseType}, è·ç¦»é£Ÿç”š: ${timeFromBest.toFixed(1)}å¤©`);
            }
          } else if (phaseDegrees > 160 && phaseDegrees < 200) {
            // æ»¡æœˆæœŸé—´ï¼Œä½¿ç”¨é¢„å…ˆç¡®å®šçš„æœˆé£Ÿç±»å‹
            if (currentEclipseInfo.kind === 'lunar') {
              effectiveEclipseType = currentEclipseInfo.type;
              console.log(`ä½¿ç”¨é¢„è®¾æœˆé£Ÿç±»å‹: ${effectiveEclipseType}, è·ç¦»é£Ÿç”š: ${timeFromBest.toFixed(1)}å¤©`);
            }
          }
        }
      }
      
      // å¦‚æœæ²¡æœ‰é¢„å…ˆç¡®å®šçš„ç±»å‹ï¼Œåˆ™ä½¿ç”¨å®æ—¶è®¡ç®—çš„ç±»å‹
      if (effectiveEclipseType === 'none') {
        effectiveEclipseType = nodeData.eclipseType;
        console.log(`ä½¿ç”¨å®æ—¶è®¡ç®—ç±»å‹: ${effectiveEclipseType}`);
      }

      if (phaseDegrees < 20 || phaseDegrees > 340) {
        // æ–°æœˆæœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿæ—¥é£Ÿ
        if (effectiveEclipseType === 'total') {
          alignmentType = 'æ—¥å…¨é£Ÿå‹æ–°æœˆ';
        } else if (effectiveEclipseType === 'partial') {
          alignmentType = 'æ—¥åé£Ÿå‹æ–°æœˆ';
        } else {
          alignmentType = 'æ–°æœˆ';
        }
      } else if (phaseDegrees > 160 && phaseDegrees < 200) {
        // æ»¡æœˆæœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿæœˆé£Ÿ
        if (effectiveEclipseType === 'total') {
          alignmentType = 'æœˆå…¨é£Ÿå‹æ»¡æœˆ';
        } else if (effectiveEclipseType === 'partial') {
          alignmentType = 'æœˆåé£Ÿå‹æ»¡æœˆ';
        } else {
          alignmentType = 'æ»¡æœˆ';
        }
      } else if (phaseDegrees > 75 && phaseDegrees < 105) {
        alignmentType = 'ä¸Šå¼¦æœˆ';
      } else if (phaseDegrees > 255 && phaseDegrees < 285) {
        alignmentType = 'ä¸‹å¼¦æœˆ';
      } else if (phaseDegrees < 90) {
        alignmentType = 'è›¾çœ‰æœˆ';
      } else if (phaseDegrees < 180) {
        alignmentType = 'ç›ˆå‡¸æœˆ';
      } else if (phaseDegrees < 270) {
        alignmentType = 'äºå‡¸æœˆ';
      } else {
        alignmentType = 'æ®‹æœˆ';
      }
      
      return {
        progress: alignmentProgress,
        type: alignmentType,
        moonPhase: phaseDegrees,
        isNearEclipseNode: isNearNode,
        currentDate: dateCurrent.toLocaleString(),
        earthAngle: earthAngle * 180 / Math.PI,
        debugInfo: {
          moonInOrbit: moonInOrbit * 180 / Math.PI,
          relativeAngle: moonRelativeToEarth * 180 / Math.PI
        }
      };
    }
    
    /**
     * è®¡ç®—æŒ‡å®šæ—¥æœŸçš„æ—¥åœ°æœˆä¸‰å¤©ä½“å¯¹é½è¿›åº¦
     * åŸºäºå¤©æ•°è®¡ç®—ï¼Œè€Œä¸æ˜¯ä»å½“å‰æ¨¡å‹çŠ¶æ€è¯»å–
     */
    function calculateSyzygyProgressForDay(daysSinceOrigin) {
      // åŸºäºå¤©æ•°è®¡ç®—å¤©ä½“è§’åº¦ä½ç½®
      const earthAngle = daysSinceOrigin * earthRevolveAnglePerDay;
      const moonOrbitPrecession = daysSinceOrigin * moonOrbitPrecessionPerDay;
      const moonInOrbit = daysSinceOrigin * moonRevolveAnglePerDay;
      
      // æœˆç›¸è®¡ç®—ï¼šç›´æ¥ä½¿ç”¨æœˆçƒç›¸å¯¹åœ°çƒçš„è§’åº¦ï¼Œå¿½ç•¥è½¨é“è¿›åŠ¨çš„å¾®å°å½±å“
      // æœˆçƒåœ¨å¤ªé˜³åæ ‡ç³»ä¸­çš„è§’åº¦ = åœ°çƒè§’åº¦ + æœˆçƒç›¸å¯¹åœ°çƒçš„è§’åº¦
      const moonRelativeToEarth = moonInOrbit + moonOrbitPrecession;
      
      // è®¡ç®—æœˆç›¸è§’åº¦ï¼šä»åœ°çƒçœ‹æœˆçƒç›¸å¯¹äºå¤ªé˜³çš„è§’åº¦
      // å…³é”®ä¿®æ­£ï¼šæœˆç›¸è§’åº¦åº”è¯¥æ˜¯æœˆçƒç›¸å¯¹åœ°çƒèƒŒå‘å¤ªé˜³æ–¹å‘çš„è§’åº¦
      // å½“moonRelativeToEarth=0æ—¶ï¼Œæœˆçƒåœ¨åœ°çƒ"å‰æ–¹"ï¼ˆé¢å‘å¤ªé˜³ä¾§ï¼‰ï¼Œåº”è¯¥æ˜¯æ»¡æœˆï¼ˆ180Â°ï¼‰
      // å½“moonRelativeToEarth=Ï€æ—¶ï¼Œæœˆçƒåœ¨åœ°çƒ"åæ–¹"ï¼ˆèƒŒç¦»å¤ªé˜³ä¾§ï¼‰ï¼Œåº”è¯¥æ˜¯æ–°æœˆï¼ˆ0Â°ï¼‰
      let moonPhaseAngle = (moonRelativeToEarth + Math.PI) % (2 * Math.PI);
      if (moonPhaseAngle < 0) moonPhaseAngle += 2 * Math.PI;
      
      // å°†è§’åº¦æ ‡å‡†åŒ–åˆ° [0, Ï€] èŒƒå›´ï¼Œç”¨äºè®¡ç®—å¯¹é½åº¦
      let alignmentAngle = Math.abs(moonPhaseAngle);
      if (alignmentAngle > Math.PI) {
        alignmentAngle = 2 * Math.PI - alignmentAngle;
      }
      
      // è®¡ç®—å¯¹é½è¿›åº¦
      // æ–°æœˆæˆ–æ»¡æœˆæ—¶å¯¹é½åº¦æœ€é«˜(100%)ï¼Œä¸Šå¼¦ä¸‹å¼¦æ—¶æœ€ä½(0%)
      let alignmentProgress;
      if (alignmentAngle <= Math.PI/2) {
        // æ–°æœˆæ–¹å‘å¯¹é½
        alignmentProgress = (Math.PI/2 - alignmentAngle) / (Math.PI/2) * 100;
      } else {
        // æ»¡æœˆæ–¹å‘å¯¹é½
        alignmentProgress = (alignmentAngle - Math.PI/2) / (Math.PI/2) * 100;
      }
      
      // åˆ¤æ–­æœˆç›¸å’Œå¯¹é½ç±»å‹
      let alignmentType = '';
      const phaseDegrees = moonPhaseAngle * 180 / Math.PI;
      
      // æ£€æŸ¥æ˜¯å¦æ¥è¿‘é»„ç™½äº¤ç‚¹ï¼ˆæ—¥æœˆé£Ÿå¯èƒ½ï¼‰
      const nodeData = calculateMoonNodePosition(daysSinceOrigin);
      const isNearNode = nodeData.isNearNode;
      
      // ä½¿ç”¨é¢„å…ˆç¡®å®šçš„æ—¥é£Ÿ/æœˆé£Ÿç±»å‹ï¼Œç¡®ä¿æ•´ä¸ªè¿‡ç¨‹ä¿æŒä¸€è‡´
      let effectiveEclipseType = 'none';
      if (currentEclipseInfo && isNearNode) {
        // æ£€æŸ¥æ˜¯å¦åœ¨å½“å‰æ—¥é£Ÿ/æœˆé£Ÿè¿‡ç¨‹ä¸­ï¼ˆæ‰©å¤§æ—¶é—´èŒƒå›´ï¼‰
        const timeFromBest = Math.abs(daysSinceOrigin - currentEclipseInfo.bestDay);
        if (timeFromBest <= 2.5) { // åœ¨é£Ÿç”šå‰å2.5å¤©å†…ï¼ˆè¦†ç›–å®Œæ•´çš„è·³è½¬èŒƒå›´ï¼‰
          if (phaseDegrees < 20 || phaseDegrees > 340) {
            // æ–°æœˆæœŸé—´ï¼Œä½¿ç”¨é¢„å…ˆç¡®å®šçš„æ—¥é£Ÿç±»å‹
            if (currentEclipseInfo.kind === 'solar') {
              effectiveEclipseType = currentEclipseInfo.type;
            }
          } else if (phaseDegrees > 160 && phaseDegrees < 200) {
            // æ»¡æœˆæœŸé—´ï¼Œä½¿ç”¨é¢„å…ˆç¡®å®šçš„æœˆé£Ÿç±»å‹
            if (currentEclipseInfo.kind === 'lunar') {
              effectiveEclipseType = currentEclipseInfo.type;
            }
          }
        }
      }
      
      // å¦‚æœæ²¡æœ‰é¢„å…ˆç¡®å®šçš„ç±»å‹ï¼Œåˆ™ä½¿ç”¨å®æ—¶è®¡ç®—çš„ç±»å‹
      if (effectiveEclipseType === 'none') {
        effectiveEclipseType = nodeData.eclipseType;
      }

      if (phaseDegrees < 20 || phaseDegrees > 340) {
        // æ–°æœˆæœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿæ—¥é£Ÿ
        if (effectiveEclipseType === 'total') {
          alignmentType = 'æ—¥å…¨é£Ÿå‹æ–°æœˆ';
        } else if (effectiveEclipseType === 'partial') {
          alignmentType = 'æ—¥åé£Ÿå‹æ–°æœˆ';
        } else {
          alignmentType = 'æ–°æœˆ';
        }
      } else if (phaseDegrees > 160 && phaseDegrees < 200) {
        // æ»¡æœˆæœŸé—´ï¼Œå¯èƒ½å‘ç”Ÿæœˆé£Ÿ
        if (effectiveEclipseType === 'total') {
          alignmentType = 'æœˆå…¨é£Ÿå‹æ»¡æœˆ';
        } else if (effectiveEclipseType === 'partial') {
          alignmentType = 'æœˆåé£Ÿå‹æ»¡æœˆ';
        } else {
          alignmentType = 'æ»¡æœˆ';
        }
      } else if (phaseDegrees > 75 && phaseDegrees < 105) {
        alignmentType = 'ä¸Šå¼¦æœˆ';
      } else if (phaseDegrees > 255 && phaseDegrees < 285) {
        alignmentType = 'ä¸‹å¼¦æœˆ';
      } else if (phaseDegrees < 90) {
        alignmentType = 'è›¾çœ‰æœˆ';
      } else if (phaseDegrees < 180) {
        alignmentType = 'ç›ˆå‡¸æœˆ';
      } else if (phaseDegrees < 270) {
        alignmentType = 'äºå‡¸æœˆ';
      } else {
        alignmentType = 'æ®‹æœˆ';
      }
      
      // åˆ›å»ºæµ‹è¯•æ—¥æœŸ
      const testDate = new Date(dateOrigin.getTime() + daysSinceOrigin * 24 * 60 * 60 * 1000);
      
      return {
        progress: alignmentProgress,
        type: alignmentType,
        moonPhase: phaseDegrees,
        isNearEclipseNode: isNearNode,
        currentDate: testDate.toLocaleString(),
        earthAngle: earthAngle * 180 / Math.PI,
        debugInfo: {
          moonInOrbit: moonInOrbit * 180 / Math.PI,
          relativeAngle: moonRelativeToEarth * 180 / Math.PI
        }
      };
    }

    /**
     * æ›´æ–°æœˆç›¸çŠ¶æ€æ˜¾ç¤ºï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
     */
    function updateMoonPhaseDisplayOptimized() {
      const syzygyData = calculateSyzygyProgress();
      
      // æ›´æ–°ä»ªè¡¨ç›˜çš„æœˆç›¸æ˜¾ç¤º
      dashboardMoonPhase.innerHTML = `${syzygyData.type}`;
      
      // æ›´æ–°ä»ªè¡¨ç›˜çš„å¯¹é½ç¨‹åº¦æ˜¾ç¤º
      dashboardAlignment.innerHTML = `${syzygyData.progress.toFixed(1)}%`;
      
      // åªåœ¨ç”»ä¸­ç”»å¯è§æ—¶æ›´æ–°æœˆç›¸ç»˜åˆ¶
      if (isPipVisible && (pipRenderer || isEclipseMode)) {
        updatePipMoonPhase(syzygyData);
      }
      
              // è°ƒè¯•ä¿¡æ¯ï¼šæ£€æŸ¥æ—¥é£Ÿ/æœˆé£ŸçŠ¶æ€
        if (isPipVisible) {
          const eclipseData = calculateEclipseProgress(syzygyData);
          const progressValue = typeof eclipseData.progress === 'object' ? eclipseData.progress.combined : eclipseData.progress;
          if (eclipseData.isEclipse && progressValue > 0.05) {
            console.log(`æ—¥é£Ÿ/æœˆé£ŸçŠ¶æ€: ${eclipseData.kind === 'solar' ? 'æ—¥é£Ÿ' : 'æœˆé£Ÿ'} ${eclipseData.type === 'total' ? 'å…¨é£Ÿ' : 'åé£Ÿ'} è¿›åº¦: ${(progressValue * 100).toFixed(1)}%`);
          }
        }
        
        // ç”¨æˆ·æç¤ºï¼šé¦–æ¬¡ä½¿ç”¨æ—¶æ˜¾ç¤ºæ—¥é£Ÿ/æœˆé£ŸåŠŸèƒ½è¯´æ˜
        if (isPipVisible && typeof window.eclipseHelpShown === 'undefined') {
          window.eclipseHelpShown = true;
          console.log('ğŸŒŸ æ—¥é£Ÿ/æœˆé£ŸåŠŸèƒ½å·²å¯ç”¨ï¼');
          console.log('ğŸ’¡ ä½¿ç”¨æç¤ºï¼š');
          console.log('  â€¢ ç‚¹å‡»"ä¸‹ä¸€æ¬¡æ—¥é£Ÿ"æˆ–"ä¸‹ä¸€æ¬¡æœˆé£Ÿ"æŒ‰é’®å¯å¿«é€Ÿè·³è½¬åˆ°æ—¥é£Ÿ/æœˆé£Ÿå‰2.5å¤©');
          console.log('  â€¢ è¿™æ ·å¯ä»¥è§‚çœ‹å®Œæ•´çš„2Dæ—¥é£Ÿ/æœˆé£ŸåŠ¨ç”»è¿‡ç¨‹ï¼ˆä»æ­£å¸¸çŠ¶æ€åˆ°é£Ÿç”šå†åˆ°ç»“æŸï¼‰');
          console.log('  â€¢ å½“å¯¹é½ç¨‹åº¦>75%ä¸”æ¥è¿‘é»„ç™½äº¤ç‚¹æ—¶ï¼Œç”»ä¸­ç”»å°†è‡ªåŠ¨åˆ‡æ¢ä¸º2Dæ—¥é£Ÿ/æœˆé£ŸåŠ¨ç”»');
          console.log('  â€¢ æ—¥é£Ÿå‘ç”Ÿåœ¨æ–°æœˆæ—¶ï¼Œæœˆé£Ÿå‘ç”Ÿåœ¨æ»¡æœˆæ—¶');
          console.log('  â€¢ è§‚å¯Ÿä»ªè¡¨ç›˜çš„"å¯¹é½ç¨‹åº¦"æŒ‡æ ‡æ¥åˆ¤æ–­æ˜¯å¦æ¥è¿‘æ—¥é£Ÿ/æœˆé£Ÿ');
          console.log('  â€¢ å¯ä»¥è°ƒæ•´é€Ÿåº¦æ¥æ§åˆ¶åŠ¨ç”»æ’­æ”¾å¿«æ…¢');
        }
      
      return syzygyData;
    }
    
    /**
     * æ›´æ–°ç”»ä¸­ç”»æœˆç›¸ç»˜åˆ¶ï¼ˆæ™ºèƒ½åˆ‡æ¢3D/2Dæ¨¡å¼ï¼‰
     */
    function updatePipMoonPhase(syzygyData) {
      // è®¡ç®—æ˜¯å¦éœ€è¦æ˜¾ç¤ºæ—¥é£Ÿ/æœˆé£ŸåŠ¨ç”»
      const eclipseData = calculateEclipseProgress(syzygyData);
      
      // åˆ¤æ–­æ˜¯å¦åº”è¯¥åˆ‡æ¢åˆ°2Dæ¨¡å¼
      const progressValue = typeof eclipseData.progress === 'object' ? eclipseData.progress.combined : eclipseData.progress;
      const shouldUse2D = eclipseData.isEclipse && progressValue > 0.05;
      
      // å¤„ç†æ¨¡å¼åˆ‡æ¢
      if (shouldUse2D && !isEclipseMode) {
        // åˆ‡æ¢åˆ°2Dæ¨¡å¼
        console.log(`åˆ‡æ¢åˆ°2D ${eclipseData.kind === 'solar' ? 'æ—¥é£Ÿ' : 'æœˆé£Ÿ'}æ¨¡å¼`);
        
        // éšè—3Dæ¸²æŸ“å™¨
        if (pipRenderer && pipRenderer.domElement) {
          pipRenderer.domElement.style.display = 'none';
        }
        
        // åˆå§‹åŒ–2D Canvas
        if (init2DEclipse()) {
          isEclipseMode = true;
          start2DEclipseAnimation();
        }
        
      } else if (!shouldUse2D && isEclipseMode) {
        // åˆ‡æ¢å›3Dæ¨¡å¼
        console.log('åˆ‡æ¢å›3Dæœˆç›¸æ¨¡å¼');
        
        // æ¸…ç†2D Canvas
        cleanup2DEclipse();
        isEclipseMode = false;
        
        // æ¸…é™¤æ—¥é£Ÿç±»å‹ä¿¡æ¯
        if (currentEclipseInfo) {
          console.log(`é€€å‡º${currentEclipseInfo.kind === 'solar' ? 'æ—¥é£Ÿ' : 'æœˆé£Ÿ'}æ¨¡å¼ï¼Œæ¸…é™¤ç±»å‹ä¿¡æ¯`);
          currentEclipseInfo = null;
        }
        
        // æ˜¾ç¤º3Dæ¸²æŸ“å™¨
        if (pipRenderer && pipRenderer.domElement) {
          pipRenderer.domElement.style.display = 'block';
        }
        
        // é‡æ–°åˆå§‹åŒ–3Dåœºæ™¯ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (!pipRenderer || !pipScene) {
          setTimeout(() => {
            if (init3DMoonPhase()) {
              updatePipMoonPhase(syzygyData);
            }
          }, 100);
          return;
        }
      }
      
      // æ ¹æ®å½“å‰æ¨¡å¼æ›´æ–°æ˜¾ç¤º
      if (isEclipseMode) {
        
        // 2DåŠ¨ç”»ä¼šåœ¨è‡ªå·±çš„å¾ªç¯ä¸­æ›´æ–°
        
      } else {
        // 3Dæ¨¡å¼ï¼šæ›´æ–°3Dæœˆç›¸æ˜¾ç¤º
        const moonRelativeAngle = syzygyData.debugInfo.relativeAngle * Math.PI / 180; // è½¬æ¢ä¸ºå¼§åº¦
        const phaseAngle = syzygyData.moonPhase * Math.PI / 180; // æœˆç›¸è§’åº¦
        const illumination = calculateIllumination(phaseAngle);
        
        // ç›´æ¥æ›´æ–°3Dæœˆç›¸ï¼Œä¸ä½¿ç”¨å¹³æ»‘è¿‡æ¸¡ä»¥ç¡®ä¿å®Œå…¨åŒæ­¥
        update3DMoonPhaseSync(moonRelativeAngle, illumination);
  
      }
      
    }
    
    /**
     * æ›´æ–°æœˆç›¸çŠ¶æ€æ˜¾ç¤ºï¼ˆä¿ç•™åŸå‡½æ•°ç”¨äºæ‰‹åŠ¨è°ƒç”¨ï¼‰
     */
    function updateMoonPhaseDisplay() {
      return updateMoonPhaseDisplayOptimized();
    }
    
    /**
     * æ ¹æ®æœˆç›¸è§’åº¦è®¡ç®—ç…§æ˜ç¨‹åº¦ï¼ˆæ”¹è¿›ç‰ˆ - æ›´è‡ªç„¶çš„è¿‡æ¸¡ï¼‰
     */
    function calculateIllumination(phaseAngle) {
      // å°†è§’åº¦æ ‡å‡†åŒ–åˆ° [0, 2Ï€]
      let normalizedAngle = phaseAngle % (2 * Math.PI);
      if (normalizedAngle < 0) normalizedAngle += 2 * Math.PI;
      
      // åŸºç¡€ç…§æ˜è®¡ç®—
      let baseIllumination = (1 - Math.cos(normalizedAngle)) / 2;
      
      // åº”ç”¨å¹³æ»‘æ›²çº¿ï¼Œä½¿è¿‡æ¸¡æ›´è‡ªç„¶
      // ä½¿ç”¨ smoothstep å‡½æ•°åˆ›å»ºæ›´å¹³æ»‘çš„è¿‡æ¸¡
      let smoothIllumination = smoothStep(0, 1, baseIllumination);
      
      // åœ¨æ–°æœˆå’Œæ»¡æœˆé™„è¿‘å¢åŠ ä¸€äº›éçº¿æ€§æ•ˆæœ
      const newMoonFactor = Math.exp(-Math.pow(normalizedAngle / Math.PI, 2) * 3);
      const fullMoonFactor = Math.exp(-Math.pow((normalizedAngle - Math.PI) / Math.PI, 2) * 3);
      
      // æ–°æœˆæ—¶å‡å°‘äº®åº¦ï¼Œæ»¡æœˆæ—¶å¢åŠ äº®åº¦
      if (normalizedAngle < Math.PI / 2 || normalizedAngle > 3 * Math.PI / 2) {
        smoothIllumination *= (1 - newMoonFactor * 0.3);
      } else if (normalizedAngle > Math.PI / 2 && normalizedAngle < 3 * Math.PI / 2) {
        smoothIllumination = Math.min(1, smoothIllumination * (1 + fullMoonFactor * 0.2));
      }
      
      return Math.max(0, Math.min(1, smoothIllumination));
    }
    
    /**
     * å¹³æ»‘æ’å€¼å‡½æ•° - åˆ›å»ºæ›´è‡ªç„¶çš„è¿‡æ¸¡æ›²çº¿
     */
    function smoothStep(edge0, edge1, x) {
      const t = Math.max(0, Math.min(1, (x - edge0) / (edge1 - edge0)));
      return t * t * (3 - 2 * t);
    }
    
    /* * * * * * * * * * * * * * * * * * * * * * * * *
     * æ—¥é£Ÿå’Œæœˆé£Ÿåˆ¤æ–­åŠŸèƒ½
     * * * * * * * * * * * * * * * * * * * * * * * * */
    
    // è®¡ç®—æœˆçƒç›¸å¯¹äºé»„ç™½äº¤ç‚¹çš„ä½ç½®
    function calculateMoonNodePosition(daysSinceOrigin) {
      // æœˆçƒåœ¨è½¨é“ä¸Šçš„ä½ç½®è§’åº¦ï¼ˆæœˆçƒå…¬è½¬ï¼‰
      const moonOrbitAngle = daysSinceOrigin * moonRevolveAnglePerDay;
      
      // è®¡ç®—æœˆçƒç›¸å¯¹äºäº¤ç‚¹çš„è§’åº¦
      // å‡äº¤ç‚¹ä½äºè§’åº¦Ï€/2ï¼Œé™äº¤ç‚¹ä½äºè§’åº¦3Ï€/2
      const angleFromAscendingNode = moonOrbitAngle - Math.PI/2;
      const angleFromDescendingNode = moonOrbitAngle - 3*Math.PI/2;
      
      // æ ‡å‡†åŒ–è§’åº¦åˆ°[0, Ï€]èŒƒå›´ï¼Œå–æœ€å°å€¼
      const normalizeAngle = (angle) => {
        const normalized = ((angle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
        return Math.min(normalized, 2 * Math.PI - normalized);
      };
      
      const distFromAscending = normalizeAngle(angleFromAscendingNode);
      const distFromDescending = normalizeAngle(angleFromDescendingNode);
      const minDistanceFromNode = Math.min(distFromAscending, distFromDescending);
      
      // åˆ¤æ–­é£Ÿç›¸ç±»å‹ï¼ˆä½¿ç”¨ç»Ÿä¸€æ ‡å‡†ï¼‰
      const eclipseType = determineEclipseTypeUnified(minDistanceFromNode);
      const isNearNode = eclipseType !== 'none';
      
      return {
        moonOrbitAngle: moonOrbitAngle,
        distanceFromAscendingNode: distFromAscending,
        distanceFromDescendingNode: distFromDescending,
        minDistanceFromNode: minDistanceFromNode,
        isNearNode: isNearNode,
        eclipseType: eclipseType, // æ–°å¢ï¼šé£Ÿç›¸ç±»å‹
        nearAscendingNode: distFromAscending < distFromDescending
      };
    }
    

    // å¯»æ‰¾ä¸‹ä¸€æ¬¡æ—¥é£Ÿçš„æ—¶é—´
    function findNextSolarEclipse(currentDays, maxSearchDays = Math.ceil(sarosCurrent), eclipseType = 'any') {
      for (let i = 1; i < maxSearchDays; i++) {
        const testDay = currentDays + i;
        
        // ä½¿ç”¨æ–°çš„å‡½æ•°è®¡ç®—æŒ‡å®šæ—¥æœŸçš„å¯¹é½æ•°æ®
        const syzygyData = calculateSyzygyProgressForDay(testDay);
        
        // åˆ¤æ–­æ˜¯å¦æ»¡è¶³æ—¥é£Ÿæ¡ä»¶ï¼š
        // 1. æ–°æœˆçŠ¶æ€ï¼ˆæœˆç›¸0-20åº¦æˆ–340-360åº¦ï¼‰
        // 2. å¯¹é½ç¨‹åº¦é«˜ï¼ˆ>95%ï¼‰
        // 3. æ ¹æ®å‚æ•°åˆ¤æ–­é£Ÿç›¸ç±»å‹
        if ((syzygyData.moonPhase < 20 || syzygyData.moonPhase > 340) &&
            syzygyData.progress > ECLIPSE_THRESHOLDS.ALIGNMENT + 25) { // 95% å¯¹é½åº¦é˜ˆå€¼
          
          const nodeData = calculateMoonNodePosition(testDay);
          
          // æ ¹æ®å‚æ•°åˆ¤æ–­é£Ÿç›¸ç±»å‹
          if (eclipseType === 'any' && nodeData.isNearNode) {
            return { day: testDay, type: nodeData.eclipseType };
          } else if (eclipseType === 'total' && nodeData.eclipseType === 'total') {
            return { day: testDay, type: 'total' };
          } else if (eclipseType === 'partial' && nodeData.eclipseType === 'partial') {
            return { day: testDay, type: 'partial' };
          }
        }
      }
      
      return null; // æœªæ‰¾åˆ°
    }
    
    // å¯»æ‰¾ä¸‹ä¸€æ¬¡æœˆé£Ÿçš„æ—¶é—´
    function findNextLunarEclipse(currentDays, maxSearchDays = Math.ceil(sarosCurrent), eclipseType = 'any') {
      for (let i = 1; i < maxSearchDays; i++) {
        const testDay = currentDays + i;
        
        // ä½¿ç”¨æ–°çš„å‡½æ•°è®¡ç®—æŒ‡å®šæ—¥æœŸçš„å¯¹é½æ•°æ®
        const syzygyData = calculateSyzygyProgressForDay(testDay);
        
        // åˆ¤æ–­æ˜¯å¦æ»¡è¶³æœˆé£Ÿæ¡ä»¶ï¼š
        // 1. æ»¡æœˆçŠ¶æ€ï¼ˆæœˆç›¸160-200åº¦ï¼‰
        // 2. å¯¹é½ç¨‹åº¦é«˜ï¼ˆ>95%ï¼‰
        // 3. æ ¹æ®å‚æ•°åˆ¤æ–­é£Ÿç›¸ç±»å‹
        if (syzygyData.moonPhase > 160 && syzygyData.moonPhase < 200 &&
            syzygyData.progress > ECLIPSE_THRESHOLDS.ALIGNMENT + 25) { // 95% å¯¹é½åº¦é˜ˆå€¼
          
          const nodeData = calculateMoonNodePosition(testDay);
          
          // æ ¹æ®å‚æ•°åˆ¤æ–­é£Ÿç›¸ç±»å‹
          if (eclipseType === 'any' && nodeData.isNearNode) {
            console.log(`æ‰¾åˆ°æœˆé£Ÿ: ç¬¬${testDay.toFixed(2)}å¤©, ç±»å‹: ${nodeData.eclipseType}, äº¤ç‚¹è·ç¦»: ${(nodeData.minDistanceFromNode * 180 / Math.PI).toFixed(1)}Â°`);
            return { day: testDay, type: nodeData.eclipseType };
          } else if (eclipseType === 'total' && nodeData.eclipseType === 'total') {
            console.log(`æ‰¾åˆ°æœˆå…¨é£Ÿ: ç¬¬${testDay.toFixed(2)}å¤©, äº¤ç‚¹è·ç¦»: ${(nodeData.minDistanceFromNode * 180 / Math.PI).toFixed(1)}Â°`);
            return { day: testDay, type: 'total' };
          } else if (eclipseType === 'partial' && nodeData.eclipseType === 'partial') {
            console.log(`æ‰¾åˆ°æœˆåé£Ÿ: ç¬¬${testDay.toFixed(2)}å¤©, äº¤ç‚¹è·ç¦»: ${(nodeData.minDistanceFromNode * 180 / Math.PI).toFixed(1)}Â°`);
            return { day: testDay, type: 'partial' };
          }
          
          // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºè¢«è·³è¿‡çš„å€™é€‰
          if (eclipseType === 'total' && nodeData.eclipseType === 'partial') {
            console.log(`è·³è¿‡æœˆåé£Ÿå€™é€‰: ç¬¬${testDay.toFixed(2)}å¤©, äº¤ç‚¹è·ç¦»: ${(nodeData.minDistanceFromNode * 180 / Math.PI).toFixed(1)}Â°, éœ€è¦å…¨é£Ÿ`);
          }
        }
      }
      
      return null; // æœªæ‰¾åˆ°
    }
    
    // è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥é£Ÿ
    function jumpToNextSolarEclipse() {
      console.log('æ­£åœ¨æœç´¢ä¸‹ä¸€æ¬¡æ—¥é£Ÿ...');
      
      // æ˜¾ç¤ºåŠ è½½æç¤º
      const button = document.getElementById('nextSolarEclipse');
      const originalText = button.textContent;
      button.textContent = 'æœç´¢ä¸­...';
      button.disabled = true;
      
      // ä½¿ç”¨ setTimeout è®©UIæœ‰æ—¶é—´æ›´æ–°
      setTimeout(() => {
        const nextEclipse = findNextSolarEclipse(days, Math.ceil(sarosCurrent)); // æœç´¢ä¸€ä¸ªæ²™ç½—å‘¨æœŸå†…
        
        if (nextEclipse !== null) {
          // è·³è½¬åˆ°æ—¥é£Ÿå‰2.5å¤©ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„åŠ¨ç”»è¿‡ç¨‹
          const targetDay = nextEclipse.day - 2.5;
          stepSimulation(targetDay, true);
          
          // æ¸…é™¤ä¹‹å‰çš„ç±»å‹ä¿¡æ¯ï¼Œé¿å…å¹²æ‰°
          currentEclipseInfo = null;
          
          // è®¾ç½®æ—¥é£Ÿç±»å‹ä¿¡æ¯
          currentEclipseInfo = {
            isEclipse: true,
            kind: 'solar',
            type: nextEclipse.type, // ç›´æ¥ä½¿ç”¨æŸ¥æ‰¾åˆ°çš„ç±»å‹
            bestDay: nextEclipse.day,
            bestAlignment: 100,
            nodeDistance: calculateMoonNodePosition(nextEclipse.day).minDistanceFromNode,
            userJumped: true // æ ‡è®°ä¸ºç”¨æˆ·æ‰‹åŠ¨è·³è½¬ï¼Œä¸å…è®¸é‡æ–°è®¡ç®—
          };
          
          console.log('è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥é£Ÿå‰2.5å¤©ï¼š', dateCurrent.toLocaleDateString());
          console.log('å¼ºåˆ¶è®¾ç½®æ—¥é£Ÿç±»å‹ä¸ºï¼š', currentEclipseInfo);
          
          // è·å–æ—¥é£Ÿé«˜æ½®æ—¶çš„æ•°æ®ç”¨äºæ˜¾ç¤º
          const syzygyData = calculateSyzygyProgressForDay(nextEclipse.day);
          
          // æ ¹æ®é£Ÿç›¸ç±»å‹æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
          const eclipseTypeText = nextEclipse.type === 'total' ? 'æ—¥å…¨é£Ÿ' : 'æ—¥åé£Ÿ';
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          const eclipseDate = new Date(dateOrigin.getTime() + nextEclipse.day * 24 * 60 * 60 * 1000);
          const currentDate = new Date(dateOrigin.getTime() + targetDay * 24 * 60 * 60 * 1000);
          
          // æ˜¾ç¤ºæ—¥é£Ÿbanner
          showSolarEclipseBanner({
            type: eclipseTypeText,
            title: 'å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥é£Ÿ'
          });
        } else {
          showSolarErrorBanner('åœ¨æ¥ä¸‹æ¥çš„27å¹´å†…æœªæ‰¾åˆ°æ—¥é£Ÿ');
        }
        
        // æ¢å¤æŒ‰é’®
        button.textContent = originalText;
        button.disabled = false;
      }, 100);
    }
    
    // æ˜¾ç¤ºæœˆé£Ÿè·³è½¬æµ®åŠ¨banner
    function showEclipseBanner(data) {
      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (currentBannerTimer) {
        clearTimeout(currentBannerTimer);
        currentBannerTimer = null;
      }
      if (currentProgressTimer) {
        clearTimeout(currentProgressTimer);
        currentProgressTimer = null;
      }
      
      // éšè—å…¶ä»–banner
      hideSolarEclipseBanner();
      
      const banner = document.getElementById('eclipseBanner');
      const typeBadge = banner.querySelector('.eclipse-type-badge');
      const titleElement = banner.querySelector('.banner-title');
      const progressBar = banner.querySelector('.banner-progress');
      
      // æ›´æ–°bannerå†…å®¹
      typeBadge.textContent = data.type;
      titleElement.textContent = data.title || 'å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆé£Ÿ';
      
      // æ ¹æ®æœˆé£Ÿç±»å‹è®¾ç½®æ ·å¼
      typeBadge.className = 'eclipse-type-badge';
      if (data.type === 'æœˆå…¨é£Ÿ') {
        typeBadge.classList.add('total');
      } else if (data.type === 'æœˆåé£Ÿ') {
        typeBadge.classList.add('partial');
      }
      
      // é‡ç½®å¹¶æ˜¾ç¤ºbanner
      banner.classList.remove('hidden');
      banner.classList.add('show');
      
      // é‡ç½®è¿›åº¦æ¡
      progressBar.classList.remove('animate');
      progressBar.style.transitionDuration = '0s';
      progressBar.style.transform = 'scaleX(0)';
      
      // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
      currentProgressTimer = setTimeout(() => {
        progressBar.style.transitionDuration = '5s';
        progressBar.classList.add('animate');
      }, 100);
      
      // 5ç§’åè‡ªåŠ¨éšè—
      currentBannerTimer = setTimeout(() => {
        hideEclipseBanner();
      }, 5000);
    }

    // éšè—æœˆé£Ÿè·³è½¬æµ®åŠ¨banner
    function hideEclipseBanner() {
      const banner = document.getElementById('eclipseBanner');
      const progressBar = banner.querySelector('.banner-progress');
      
      banner.classList.remove('show');
      banner.classList.add('hidden');
      
      // é‡ç½®è¿›åº¦æ¡
      progressBar.classList.remove('animate');
      progressBar.style.transitionDuration = '0s';
      progressBar.style.transform = 'scaleX(0)';
    }

    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯banner
    function showErrorBanner(message) {
      const banner = document.getElementById('eclipseBanner');
      const titleElement = banner.querySelector('.banner-title');
      const typeBadge = banner.querySelector('.eclipse-type-badge');
      const tipsElement = banner.querySelector('.banner-tips');
      const iconElement = banner.querySelector('.banner-icon');
      const progressBar = banner.querySelector('.banner-progress');
      
      // æ›´æ–°bannerä¸ºé”™è¯¯çŠ¶æ€
      titleElement.textContent = message;
      typeBadge.textContent = 'æœªæ‰¾åˆ°';
      typeBadge.style.background = 'linear-gradient(135deg, #d32f2f, #b71c1c)';
      tipsElement.textContent = 'æ‚¨å¯ä»¥å°è¯•è°ƒæ•´æœç´¢èŒƒå›´æˆ–æ—¶é—´';
      iconElement.textContent = 'âŒ';
      
      // æ˜¾ç¤ºbanner
      banner.classList.remove('hidden');
      banner.classList.add('show');
      
      // é‡ç½®å¹¶å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»
      progressBar.classList.remove('animate');
      progressBar.style.transitionDuration = '0s';
      progressBar.style.transform = 'scaleX(0)';
      
      setTimeout(() => {
        progressBar.style.transitionDuration = '4s';
        progressBar.classList.add('animate');
      }, 100);
      
      // 4ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        hideEclipseBanner();
        // æ¢å¤åŸå§‹çŠ¶æ€
        titleElement.textContent = 'å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆé£Ÿ';
        typeBadge.textContent = 'æœˆå…¨é£Ÿ';
        typeBadge.style.background = 'linear-gradient(135deg, #c9a35c, #9b7c3e)';
        iconElement.textContent = 'ğŸŒ™';
        tipsElement.textContent = 'ğŸ’¡ æ‰“å¼€ç”»ä¸­ç”»è§‚çœ‹å®Œæ•´æœˆé£Ÿè¿‡ç¨‹';
      }, 4000);
    }

    // æ˜¾ç¤ºæ—¥é£Ÿè·³è½¬æµ®åŠ¨banner
    function showSolarEclipseBanner(data) {
      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (currentBannerTimer) {
        clearTimeout(currentBannerTimer);
        currentBannerTimer = null;
      }
      if (currentProgressTimer) {
        clearTimeout(currentProgressTimer);
        currentProgressTimer = null;
      }
      
      // éšè—å…¶ä»–banner
      hideEclipseBanner();
      
      const banner = document.getElementById('solarEclipseBanner');
      const typeBadge = banner.querySelector('.eclipse-type-badge');
      const titleElement = banner.querySelector('.banner-title');
      const progressBar = banner.querySelector('.banner-progress');
      
      // æ›´æ–°bannerå†…å®¹
      typeBadge.textContent = data.type;
      titleElement.textContent = data.title || 'å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥é£Ÿ';
      
      // æ ¹æ®æ—¥é£Ÿç±»å‹è®¾ç½®æ ·å¼
      typeBadge.className = 'eclipse-type-badge';
      if (data.type === 'æ—¥å…¨é£Ÿ') {
        typeBadge.classList.add('solar-total');
      } else if (data.type === 'æ—¥åé£Ÿ') {
        typeBadge.classList.add('solar-partial');
      } else if (data.type.includes('æ—¥é£Ÿ')) {
        typeBadge.classList.add('solar-total');
      }
      
      // é‡ç½®å¹¶æ˜¾ç¤ºbanner
      banner.classList.remove('hidden');
      banner.classList.add('show');
      
      // é‡ç½®è¿›åº¦æ¡
      progressBar.classList.remove('animate');
      progressBar.style.transitionDuration = '0s';
      progressBar.style.transform = 'scaleX(0)';
      
      // å¼€å§‹è¿›åº¦æ¡åŠ¨ç”»
      currentProgressTimer = setTimeout(() => {
        progressBar.style.transitionDuration = '5s';
        progressBar.classList.add('animate');
      }, 100);
      
      // 5ç§’åè‡ªåŠ¨éšè—
      currentBannerTimer = setTimeout(() => {
        hideSolarEclipseBanner();
      }, 5000);
    }

    // éšè—æ—¥é£Ÿè·³è½¬æµ®åŠ¨banner
    function hideSolarEclipseBanner() {
      const banner = document.getElementById('solarEclipseBanner');
      const progressBar = banner.querySelector('.banner-progress');
      
      banner.classList.remove('show');
      banner.classList.add('hidden');
      
      // é‡ç½®è¿›åº¦æ¡
      progressBar.classList.remove('animate');
      progressBar.style.transitionDuration = '0s';
      progressBar.style.transform = 'scaleX(0)';
    }

    // æ˜¾ç¤ºæ—¥é£Ÿé”™è¯¯æ¶ˆæ¯banner
    function showSolarErrorBanner(message) {
      const banner = document.getElementById('solarEclipseBanner');
      const titleElement = banner.querySelector('.banner-title');
      const typeBadge = banner.querySelector('.eclipse-type-badge');
      const tipsElement = banner.querySelector('.banner-tips');
      const iconElement = banner.querySelector('.banner-icon');
      const progressBar = banner.querySelector('.banner-progress');
      
      // æ›´æ–°bannerä¸ºé”™è¯¯çŠ¶æ€
      titleElement.textContent = message;
      typeBadge.textContent = 'æœªæ‰¾åˆ°';
      typeBadge.style.background = 'linear-gradient(135deg, #d32f2f, #b71c1c)';
      tipsElement.textContent = 'æ‚¨å¯ä»¥å°è¯•è°ƒæ•´æœç´¢èŒƒå›´æˆ–æ—¶é—´';
      iconElement.textContent = 'âŒ';
      
      // æ˜¾ç¤ºbanner
      banner.classList.remove('hidden');
      banner.classList.add('show');
      
      // é‡ç½®å¹¶å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»
      progressBar.classList.remove('animate');
      progressBar.style.transitionDuration = '0s';
      progressBar.style.transform = 'scaleX(0)';
      
      setTimeout(() => {
        progressBar.style.transitionDuration = '4s';
        progressBar.classList.add('animate');
      }, 100);
      
      // 4ç§’åè‡ªåŠ¨éšè—
      setTimeout(() => {
        hideSolarEclipseBanner();
        // æ¢å¤åŸå§‹çŠ¶æ€
        titleElement.textContent = 'å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥é£Ÿ';
        typeBadge.textContent = '';
        typeBadge.style.background = 'linear-gradient(135deg, #c9a35c, #9b7c3e)';
        iconElement.textContent = 'â˜€ï¸';
        tipsElement.textContent = 'ğŸ’¡ æ‰“å¼€ç”»ä¸­ç”»è§‚çœ‹å®Œæ•´æ—¥é£Ÿè¿‡ç¨‹';
      }, 4000);
    }

    // è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆé£Ÿ
    function jumpToNextLunarEclipse() {
      console.log('æ­£åœ¨æœç´¢ä¸‹ä¸€æ¬¡æœˆé£Ÿ...');
      
      // æ˜¾ç¤ºåŠ è½½æç¤º
      const button = document.getElementById('nextLunarEclipse');
      const originalText = button.textContent;
      button.textContent = 'æœç´¢ä¸­...';
      button.disabled = true;
      
      // ä½¿ç”¨ setTimeout è®©UIæœ‰æ—¶é—´æ›´æ–°
      setTimeout(() => {
        const nextEclipse = findNextLunarEclipse(days, Math.ceil(sarosCurrent)); // æœç´¢ä¸€ä¸ªæ²™ç½—å‘¨æœŸå†…
        
        if (nextEclipse !== null) {
          // è·³è½¬åˆ°æœˆé£Ÿå‰2.5å¤©ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„åŠ¨ç”»è¿‡ç¨‹
          const targetDay = nextEclipse.day - 2.5;
          stepSimulation(targetDay, true);
          
          // æ¸…é™¤ä¹‹å‰çš„ç±»å‹ä¿¡æ¯ï¼Œé¿å…å¹²æ‰°
          currentEclipseInfo = null;
          
          // è®¾ç½®æœˆé£Ÿç±»å‹ä¿¡æ¯
          currentEclipseInfo = {
            isEclipse: true,
            kind: 'lunar',
            type: nextEclipse.type, // ç›´æ¥ä½¿ç”¨æŸ¥æ‰¾åˆ°çš„ç±»å‹
            bestDay: nextEclipse.day,
            bestAlignment: 100,
            nodeDistance: calculateMoonNodePosition(nextEclipse.day).minDistanceFromNode,
            userJumped: true // æ ‡è®°ä¸ºç”¨æˆ·æ‰‹åŠ¨è·³è½¬ï¼Œä¸å…è®¸é‡æ–°è®¡ç®—
          };
          
          console.log('è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆé£Ÿå‰2.5å¤©ï¼š', dateCurrent.toLocaleDateString());
          console.log('å¼ºåˆ¶è®¾ç½®æœˆé£Ÿç±»å‹ä¸ºï¼š', currentEclipseInfo);
          
          // è·å–æœˆé£Ÿé«˜æ½®æ—¶çš„æ•°æ®ç”¨äºæ˜¾ç¤º
          const syzygyData = calculateSyzygyProgressForDay(nextEclipse.day);
          
          // æ ¹æ®é£Ÿç›¸ç±»å‹æ˜¾ç¤ºä¸åŒæ¶ˆæ¯
          const eclipseTypeText = nextEclipse.type === 'total' ? 'æœˆå…¨é£Ÿ' : 'æœˆåé£Ÿ';
          
          // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
          const eclipseDate = new Date(dateOrigin.getTime() + nextEclipse.day * 24 * 60 * 60 * 1000);
          const currentDate = new Date(dateOrigin.getTime() + targetDay * 24 * 60 * 60 * 1000);
          
          // æ˜¾ç¤ºæµ®åŠ¨bannerè€Œä¸æ˜¯alert
          showEclipseBanner({
            type: eclipseTypeText,
            eclipseDate: eclipseDate.toLocaleDateString(),
            currentDate: currentDate.toLocaleDateString(),
            alignment: syzygyData.progress.toFixed(1),
            nodeDistance: (calculateMoonNodePosition(nextEclipse.day).minDistanceFromNode * 180 / Math.PI).toFixed(1)
          });
        } else {
          showErrorBanner('åœ¨æ¥ä¸‹æ¥çš„27å¹´å†…æœªæ‰¾åˆ°æœˆé£Ÿ');
        }
        
        // æ¢å¤æŒ‰é’®
        button.textContent = originalText;
        button.disabled = false;
      }, 100);
    }

    // è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥å…¨é£Ÿ
    function jumpToNextTotalSolarEclipse() {
      console.log('æ­£åœ¨æœç´¢ä¸‹ä¸€æ¬¡æ—¥å…¨é£Ÿ...');
      
      const button = document.getElementById('nextTotalSolarEclipse');
      const originalText = button.textContent;
      button.textContent = 'æœç´¢ä¸­...';
      button.disabled = true;
      
      setTimeout(() => {
        const nextEclipse = findNextSolarEclipse(days, Math.ceil(sarosCurrent), 'total');
        
        if (nextEclipse !== null) {
          // è·³è½¬åˆ°æ—¥å…¨é£Ÿå‰2.5å¤©ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„åŠ¨ç”»è¿‡ç¨‹
          const targetDay = nextEclipse.day - 2.5;
          stepSimulation(targetDay, true);
          
          // æ¸…é™¤ä¹‹å‰çš„ç±»å‹ä¿¡æ¯ï¼Œé¿å…å¹²æ‰°
          currentEclipseInfo = null;
          
          // å¼ºåˆ¶è®¾ç½®æ—¥é£Ÿç±»å‹ä¿¡æ¯ï¼Œç¡®ä¿ç±»å‹ä¸€è‡´æ€§
          currentEclipseInfo = {
            isEclipse: true,
            kind: 'solar',
            type: 'total', // å¼ºåˆ¶è®¾ä¸ºå…¨é£Ÿ
            bestDay: nextEclipse.day,
            bestAlignment: 100,
            nodeDistance: calculateMoonNodePosition(nextEclipse.day).minDistanceFromNode,
            userJumped: true // æ ‡è®°ä¸ºç”¨æˆ·æ‰‹åŠ¨è·³è½¬ï¼Œä¸å…è®¸é‡æ–°è®¡ç®—
          };
          
          console.log('è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥å…¨é£Ÿå‰2.5å¤©ï¼š', dateCurrent.toLocaleDateString());
          console.log('å¼ºåˆ¶è®¾ç½®æ—¥é£Ÿç±»å‹ä¸ºï¼š', currentEclipseInfo);
          
          const syzygyData = calculateSyzygyProgressForDay(nextEclipse.day);
          const eclipseDate = new Date(dateOrigin.getTime() + nextEclipse.day * 24 * 60 * 60 * 1000);
          const currentDate = new Date(dateOrigin.getTime() + targetDay * 24 * 60 * 60 * 1000);
          
          // æ˜¾ç¤ºæ—¥å…¨é£Ÿbanner
          showSolarEclipseBanner({
            type: 'æ—¥å…¨é£Ÿ',
            title: 'å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥é£Ÿ'
          });
        } else {
          showSolarErrorBanner('åœ¨æ¥ä¸‹æ¥çš„27å¹´å†…æœªæ‰¾åˆ°æ—¥å…¨é£Ÿ');
        }
        
        button.textContent = originalText;
        button.disabled = false;
      }, 100);
    }
    
    // è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥åé£Ÿ
    function jumpToNextPartialSolarEclipse() {
      console.log('æ­£åœ¨æœç´¢ä¸‹ä¸€æ¬¡æ—¥åé£Ÿ...');
      
      const button = document.getElementById('nextPartialSolarEclipse');
      const originalText = button.textContent;
      button.textContent = 'æœç´¢ä¸­...';
      button.disabled = true;
      
      setTimeout(() => {
        const nextEclipse = findNextSolarEclipse(days, Math.ceil(sarosCurrent), 'partial');
        
        if (nextEclipse !== null) {
          // è·³è½¬åˆ°æ—¥åé£Ÿå‰2.5å¤©ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„åŠ¨ç”»è¿‡ç¨‹
          const targetDay = nextEclipse.day - 2.5;
          stepSimulation(targetDay, true);
          
          // æ¸…é™¤ä¹‹å‰çš„ç±»å‹ä¿¡æ¯ï¼Œé¿å…å¹²æ‰°
          currentEclipseInfo = null;
          
          // å¼ºåˆ¶è®¾ç½®æ—¥é£Ÿç±»å‹ä¿¡æ¯ï¼Œç¡®ä¿ç±»å‹ä¸€è‡´æ€§
          currentEclipseInfo = {
            isEclipse: true,
            kind: 'solar',
            type: 'partial', // å¼ºåˆ¶è®¾ä¸ºåé£Ÿ
            bestDay: nextEclipse.day,
            bestAlignment: 100,
            nodeDistance: calculateMoonNodePosition(nextEclipse.day).minDistanceFromNode,
            userJumped: true // æ ‡è®°ä¸ºç”¨æˆ·æ‰‹åŠ¨è·³è½¬ï¼Œä¸å…è®¸é‡æ–°è®¡ç®—
          };
          
          console.log('è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥åé£Ÿå‰2.5å¤©ï¼š', dateCurrent.toLocaleDateString());
          console.log('å¼ºåˆ¶è®¾ç½®æ—¥é£Ÿç±»å‹ä¸ºï¼š', currentEclipseInfo);
          
          const syzygyData = calculateSyzygyProgressForDay(nextEclipse.day);
          const eclipseDate = new Date(dateOrigin.getTime() + nextEclipse.day * 24 * 60 * 60 * 1000);
          const currentDate = new Date(dateOrigin.getTime() + targetDay * 24 * 60 * 60 * 1000);
          
          // æ˜¾ç¤ºæ—¥åé£Ÿbanner
          showSolarEclipseBanner({
            type: 'æ—¥åé£Ÿ',
            title: 'å·²è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æ—¥é£Ÿ'
          });
        } else {
          showSolarErrorBanner('åœ¨æ¥ä¸‹æ¥çš„27å¹´å†…æœªæ‰¾åˆ°æ—¥åé£Ÿ');
        }
        
        button.textContent = originalText;
        button.disabled = false;
      }, 100);
    }
    
    // è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆå…¨é£Ÿ
    function jumpToNextTotalLunarEclipse() {
      console.log('æ­£åœ¨æœç´¢ä¸‹ä¸€æ¬¡æœˆå…¨é£Ÿ...');
      
      const button = document.getElementById('nextTotalLunarEclipse');
      const originalText = button.textContent;
      button.textContent = 'æœç´¢ä¸­...';
      button.disabled = true;
      
      setTimeout(() => {
        const nextEclipse = findNextLunarEclipse(days, Math.ceil(sarosCurrent), 'total');
        
        if (nextEclipse !== null) {
          // è·³è½¬åˆ°æœˆå…¨é£Ÿå‰2.5å¤©ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„åŠ¨ç”»è¿‡ç¨‹
          const targetDay = nextEclipse.day - 2.5;
          stepSimulation(targetDay, true);
          
          // æ¸…é™¤ä¹‹å‰çš„ç±»å‹ä¿¡æ¯ï¼Œé¿å…å¹²æ‰°
          currentEclipseInfo = null;
          
          // è®¾ç½®æœˆé£Ÿç±»å‹ä¿¡æ¯
          currentEclipseInfo = {
            isEclipse: true,
            kind: 'lunar',
            type: 'total', // ç›´æ¥è®¾ç½®ä¸ºæœˆå…¨é£Ÿ
            bestDay: nextEclipse.day,
            bestAlignment: 100,
            nodeDistance: calculateMoonNodePosition(nextEclipse.day).minDistanceFromNode,
            userJumped: true // æ ‡è®°ä¸ºç”¨æˆ·æ‰‹åŠ¨è·³è½¬ï¼Œä¸å…è®¸é‡æ–°è®¡ç®—
          };
          
          console.log('è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆå…¨é£Ÿå‰2.5å¤©ï¼š', dateCurrent.toLocaleDateString());
          console.log('å¼ºåˆ¶è®¾ç½®æœˆé£Ÿç±»å‹ä¸ºï¼š', currentEclipseInfo);
          
          const syzygyData = calculateSyzygyProgressForDay(nextEclipse.day);
          const eclipseDate = new Date(dateOrigin.getTime() + nextEclipse.day * 24 * 60 * 60 * 1000);
          const currentDate = new Date(dateOrigin.getTime() + targetDay * 24 * 60 * 60 * 1000);
          
          // æ˜¾ç¤ºæœˆå…¨é£Ÿbanner
          showEclipseBanner({
            type: 'æœˆå…¨é£Ÿ'
          });
        } else {
          showErrorBanner('åœ¨æ¥ä¸‹æ¥çš„27å¹´å†…æœªæ‰¾åˆ°æœˆå…¨é£Ÿ');
        }
        
        button.textContent = originalText;
        button.disabled = false;
      }, 100);
    }
    
    // è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆåé£Ÿ
    function jumpToNextPartialLunarEclipse() {
      console.log('æ­£åœ¨æœç´¢ä¸‹ä¸€æ¬¡æœˆåé£Ÿ...');
      
      const button = document.getElementById('nextPartialLunarEclipse');
      const originalText = button.textContent;
      button.textContent = 'æœç´¢ä¸­...';
      button.disabled = true;
      
      setTimeout(() => {
        const nextEclipse = findNextLunarEclipse(days, Math.ceil(sarosCurrent), 'partial');
        
        if (nextEclipse !== null) {
          // è·³è½¬åˆ°æœˆåé£Ÿå‰2.5å¤©ï¼Œè®©ç”¨æˆ·çœ‹åˆ°å®Œæ•´çš„åŠ¨ç”»è¿‡ç¨‹
          const targetDay = nextEclipse.day - 2.5;
          stepSimulation(targetDay, true);
          
          // æ¸…é™¤ä¹‹å‰çš„ç±»å‹ä¿¡æ¯ï¼Œé¿å…å¹²æ‰°
          currentEclipseInfo = null;
          
          // è®¾ç½®æœˆé£Ÿç±»å‹ä¿¡æ¯
          currentEclipseInfo = {
            isEclipse: true,
            kind: 'lunar',
            type: 'partial', // ç›´æ¥è®¾ç½®ä¸ºæœˆåé£Ÿ
            bestDay: nextEclipse.day,
            bestAlignment: 100,
            nodeDistance: calculateMoonNodePosition(nextEclipse.day).minDistanceFromNode,
            userJumped: true // æ ‡è®°ä¸ºç”¨æˆ·æ‰‹åŠ¨è·³è½¬ï¼Œä¸å…è®¸é‡æ–°è®¡ç®—
          };
          
          console.log('è·³è½¬åˆ°ä¸‹ä¸€æ¬¡æœˆåé£Ÿå‰2.5å¤©ï¼š', dateCurrent.toLocaleDateString());
          console.log('å¼ºåˆ¶è®¾ç½®æœˆé£Ÿç±»å‹ä¸ºï¼š', currentEclipseInfo);
          
          const syzygyData = calculateSyzygyProgressForDay(nextEclipse.day);
          const eclipseDate = new Date(dateOrigin.getTime() + nextEclipse.day * 24 * 60 * 60 * 1000);
          const currentDate = new Date(dateOrigin.getTime() + targetDay * 24 * 60 * 60 * 1000);
          
          // æ˜¾ç¤ºæœˆåé£Ÿbanner
          showEclipseBanner({
            type: 'æœˆåé£Ÿ'
          });
        } else {
          showErrorBanner('åœ¨æ¥ä¸‹æ¥çš„27å¹´å†…æœªæ‰¾åˆ°æœˆåé£Ÿ');
        }
        
        button.textContent = originalText;
        button.disabled = false;
      }, 100);
    }

      </script>
  </body>
</html>