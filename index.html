<!DOCTYPE html>
<html lang="cn">
<head>
  <meta charset="UTF-8">
  <title>Solar System</title>
  <link rel="stylesheet" href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!------ 标题 ------>
  <div id="title">
    <img src="https://cdn.picui.cn/vip/2025/07/11/6870e6590199f.png" alt="Solar System">
    <h1>Solar System Sim</h1>
  </div>

  <!------ 仪表盘区域 ------>
  <div id="dashboard">
    <div class="dashboard-item">
      <span class="db-label">当前日期</span>
      <span class="db-value" id="db-date">2000-1-1</span>
    </div>
    <div class="dashboard-divider"></div>
    <div class="dashboard-item">
      <span class="db-label">速度比例</span>
      <span class="db-value" id="db-speed">1d/s</span>
    </div>
    <div class="dashboard-divider"></div>
    <div class="dashboard-item">
      <span class="db-label">沙罗周期进度</span>
      <span class="db-value" id="db-saros">0%</span>
    </div>
  </div>

  <!------ 控制面板 ------>
  <button id="controlBtn" aria-label="打开/关闭控制面板">
    <span>≡</span>
  </button>
  <aside id="controlPanel">
    <!---- 标签页切换导航 ---->
    <nav id="tabs">
      <button class="tab active" data-tab="page1">
        <i class="fa fa-info-circle"></i>
        <span>信息</span>
      </button>
      <button class="tab" data-tab="page2">
        <i class="fa fa-eye"></i>
        <span>视图</span>
      </button>
      <button class="tab" data-tab="page3">
        <i class="fa fa-cog"></i>
        <span>参数</span>
      </button>
    </nav>
    <!---- 标签页内容 ---->
    <div id="panels">
      <!-- 标签页1：信息页 -->
      <div class="panel active" id="page1">
        <h3>基本信息</h3>
        <p>TODO: 放置关于天体科普（如天体参数、沙罗周期等）或者网页信息（如网页简介、开发者信息、功能描述等）的内容</p>
      </div>
      <!-- 标签页2：视图页 -->
      <div class="panel" id="page2">
        <!-- 控制块：相机视角 -->
        <div class="contorl-block" id="viewSettings">
          <h4>
            <span class="zh">相机视角</span>
            <span class="en">Camera View</span>
          </h4>
          <ul>
            <li>
              <input type="radio" name="view" id="top-view" value="top-view" checked hidden>
              <label for="top-view" class="view-label">
                <i class="fa fa-toggle-down"></i>
                <span>俯视图</span>
              </label>
            </li>
            <li>
              <input type="radio" name="view" id="side-view" value="side-view" hidden>
              <label for="side-view" class="view-label">
                <i class="fa fa-toggle-right"></i>
                <span>侧视图</span>
              </label>
            </li>
            <li>
              <input type="radio" name="view" id="3D-view" value="3D-view" hidden>
              <label for="3D-view" class="view-label">
                <i class="fa fa-cube"></i>
                <span>3D视图</span>
              </label>
            </li>
          </ul>
        </div>
        <hr>
        <!-- 控制块：贴图纹理 -->
        <div class="contorl-block" id="textureSettings">
          <h4>
            <span class="zh">贴图纹理</span>
            <span class="en">Surface Texture</span>
          </h4>
          <div id="earthTexture">
            <h5>地球贴图</h5>
            <ul>
              <li>
                <input type="radio" name="earth-texture" id="solid-blue" value="solid-blue" hidden>
                <label for="solid-blue" class="texture-label">
                  <i></i>
                  <span>纯蓝色</span>
                </label>
              </li>
              <li>
                <input type="radio" name="earth-texture" id="common-map" value="common-map" hidden>
                <label for="common-map" class="texture-label">
                  <i></i>
                  <span>世界区划地图</span>
                </label>
              </li>
              <li>
                <input type="radio" name="earth-texture" id="satellite-map" value="satellite-map" checked hidden>
                <label for="satellite-map" class="texture-label">
                  <i></i>
                  <span>卫星地图</span>
                </label>
              </li>
            </ul>
          </div>
          <div id="sunTexture">
            <h5>太阳贴图</h5>
            <ul>
              <li>
                <input type="radio" name="sun-texture" id="solid-orange" value="solid-orange" hidden>
                <label for="solid-orange" class="texture-label">
                  <i></i>
                  <span>纯橙色</span>
                </label>
              </li>
              <li>
                <input type="radio" name="sun-texture" id="true-surface" value="true-surface" checked hidden>
                <label for="true-surface" class="texture-label">
                  <i></i>
                  <span>真实表面</span>
                </label>
              </li>
            </ul>
          </div>
          <div id="starland">
            <h5>星空背景</h5>
            <ul>
              <li>
                <input type="radio" name="starland" id="solid-black" value="solid-black" hidden>
                <label for="solid-black" class="texture-label">
                  <i></i>
                  <span>纯黑</span>
                </label>
              </li>
              <li>
                <input type="radio" name="starland" id="stars" value="stars" checked hidden>
                <label for="stars" class="texture-label">
                  <i></i>
                  <span>繁星</span>
                </label>
              </li>
            </ul>
          </div>
          <div id="earthAxis">
            <h5>地轴显示</h5>
            <ul>
              <li>
                <input type="checkbox" id="axisSwitch" checked hidden>
                <label for="axisSwitch" class="texture-label">
                  <i></i>
                  <span>显示地轴</span>
                </label>
              </li>
            </ul>
          </div>
          <div id="moonOrbitNormal">
            <h5>月球轨道法向量</h5>
            <ul>
              <li>
                <input type="checkbox" id="moonNormalSwitch" checked hidden>
                <label for="moonNormalSwitch" class="texture-label">
                  <i></i>
                  <span>显示轨道法向量</span>
                </label>
              </li>
            </ul>
          </div>
        </div>
        <hr>
        <!-- 控制块：日月食画中画 -->
        <div class="contorl-block" id="PIPSettings">
          <h4>
            <span class="zh">日月食画中画</span>
            <span class="en">Solar/Moon Eclipse PIP</span>
          </h4>
          <ul><li>
            <input type="checkbox" id="PIPSwitch" hidden>
            <label for="PIPSwitch" class="PIP-label">
              <h5>画中画开关</h5>
              <i></i>
            </label>
          </li></ul>
          <ul><li>
            <label for="latitudePos">在地球上观测的地点</label>
            <select id="latitudePos" name="latitudePos">
              <option value="90">北极附近</option>
              <option value="45">北半球</option>
              <option value="0" selected>赤道</option>
              <option value="-45">南半球</option>
              <option value="-90">南极附近</option>
            </select>
          </li></ul>
        </div>
      <p>TODO: 或许有一些其他需要的配置</p>
      </div>
      <!-- 标签页3：参数调整 -->
      <div class="panel" id="page3">
        <!-- 控制块：速度控制 -->
        <div class="contorl-block" id="speedSettings">
          <h4>
            <span class="zh">速度控制</span>
            <span class="en">Speed Control</span>
          </h4>
          <ul><li>
            <h5>速度调节</h5>
            <input type="range" id="speedInput" min="-7" max="7" step="1" value="1">
            <label for="speedInput" class="speed-label" id="speedLabel">x1</label>
          </li></ul>
          <ul>
            <li>
              <h5>运动反向</h5>
              <input type="checkbox" id="reserveSwitch" hidden>
              <label for="reserveSwitch">
                <i></i>
              </label>
            </li>
            <li>
              <h5>运动暂停</h5>
              <input type="checkbox" id="stopSwitch" hidden>
              <label for="stopSwitch">
                <i></i>
              </label>
            </li>
          </ul>
        </div>
        <hr>
        <!-- 控制块：时间控制 -->
        <div class="contorl-block" id="timeSettings">
          <h4>
            <span class="zh">时间控制</span>
            <span class="en">Time Control</span>
          </h4>
          <ul><li>
            <h5>日期跳转</h5>
            <input type="date" id="dateInput">
            <button id="dateSubmit" onclick="onClickDateSubmit()"><i class="fa fa-check"></i></button>
          </li></ul>
          <ul>
            <h5>快捷选择</h5>
            <li>
              <button id="oneYearAgo" onclick="dateJumpBy(-365)">-1年</button>
              <button id="oneMonthAgo" onclick="dateJumpBy(-30)">-1月</button>
              <button id="oneMonthForward" onclick="dateJumpBy(30)">+1月</button>
              <button id="oneYearForward" onclick="dateJumpBy(365)">+1年</button>
            </li>
            <li>
              <button id="nextSolarEclipse">下一次日食</button>
              <button id="nextLunarEclipse">下一次月食</button>
            </li>
          </ul>
        </div>
        <hr>
        <!-- 控制块：天体尺寸 -->
        <div class="contorl-block" id="sizeSettings">
          <h4>
            <span class="zh">天体尺寸</span>
            <span class="en">Celestial size</span>
          </h4>
          <ul>
            <li>
              <input type="radio" name="size" id="suitable-size" value="suitable-size" checked hidden>
              
              <label for="suitable-size" class="size-label">
                <i class="fa fa-eye"></i>
                <span>适宜观察</span>
              </label>
            </li>
            <li>
              <input type="radio" name="size" id="true-size" value="true-size" hidden>
              <label for="true-size" class="size-label">
                <i class="fa fa-bullseye"></i>
                <span>真实大小</span>
              </label>
            </li>
          </ul>
        </div>
        <hr>
        <p>TODO: 或许有一些其他需要的配置</p>
      </div>
    </div>
  </aside>

  <!------ 小工具条 ------>
  <nav id="toolBar">
    <button class="tool-btn" id="toolPause" title="暂停" onclick="clickOnToolPause()">
      <i class="fa fa-pause"></i>
    </button>
    <button class="tool-btn" id="toolSpeed" title="速度" onclick="clickOnToolSpeed()">
      <i>x1</i>
    </button>
    <hr>
    <button class="tool-btn" id="toolView" title="切换视角">
      <i class="fa fa-eye"></i>
    </button>
    <button class="tool-btn" id="toolScreenshot" title="截图" onclick="clickOnToolScreenshot()">
      <i class="fa fa-camera"></i>
    </button>
    <hr>
    <button class="tool-btn" id="toolHelp" title="帮助">
      <i class="fa fa-question"></i>
    </button>
  </nav>

  <!--------------------------------------------->
  <!------------ 下面是JavaScript代码 ------------>
  <!--------------------------------------------->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script>
    /* * * * * * * * * *
     * 重要全局变量定义
     * * * * * * * * * */
    // 公共变量：控件
    const controlBtn = document.getElementById('controlBtn');
    const controlPanel = document.getElementById('controlPanel');
    const tabs = document.querySelectorAll('#tabs .tab');
    const panels = document.querySelectorAll('#panels .panel');
    const earthTextureRadios = document.querySelectorAll('#earthTexture input');
    const sunTextureRadios = document.querySelectorAll('#sunTexture input');
    const starlandRadios = document.querySelectorAll('#starland input');
    const axisSwitch = document.getElementById('axisSwitch');
    const moonNormalSwitch = document.getElementById('moonNormalSwitch');
    const speedInput = document.getElementById('speedInput');
    const speedLabel = document.getElementById('speedLabel');
    const reserveSwitch = document.getElementById('reserveSwitch');
    const stopSwitch = document.getElementById('stopSwitch');
    const dateInput = document.getElementById('dateInput');
    const dashboardDate = document.getElementById('db-date');
    const dashboardSpeed = document.getElementById('db-speed');
    const dashboardSaros = document.getElementById('db-saros');
    const toolPause = document.getElementById('toolPause');
    const toolSpeed = document.getElementById('toolSpeed');
    let isControlPanelOpen = false;
    let mouseDragging = false;

    // 公共变量：天体和运动参数
    const frameRate = 60; //动画帧数
    const sunRotateAnglePerDay = 0.228729; //太阳每天自转的角度
    const earthRevolveAnglePerDay = 0.017202; //地球每天公转的角度（弧度）
    const earthRotateAnglePerDay = 6.283185; //地球每天自转的角度
    const moonRevolveAnglePerDay = 0.229985; //月球每天公转的角度(恒星坐标系)
    const moonRotateAnglePerDay = 0.229985; //月球每天自转的角度
    // 月球轨道进动：2π / (18.6年 × 365.25天) = 2π / 6793天 ≈ 0.000924
    const moonOrbitPrecessionPerDay = -0.000924; //月球轨道进动角速度（约18.6年一周期，逆行）
    const dateOrigin = new Date(2022, 11, 8); //日期原点（日地月共线，月球黄纬约为0）
    let dateCurrent = new Date(dateOrigin); //当前日期
    let days = 0;             //经历天数（当前日期与原点相差天数）
    const sarosCurrent = 6585.32; //沙罗周期：6585.32天
    let speedFactor = 1;      //速度因子
    let isPaused = false;     //暂停
    let isbackwards = false;  //倒退
    //视角相关参数
    let isViewLocked = false; //是否是3D视角
    let targetAzimuth = 0;     // 水平角
    let targetElevation = 0;   // 垂直角
    let startMouseX = 0;
    let startMouseY = 0;
    let startAzimuth = 0;
    let startElevation = 0;
    // 公共变量：场景、相机、渲染器、纹理
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    camera.position.z = 10;
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.body.appendChild(renderer.domElement);
    let rendererLock = false;    //渲染器锁
    const textureLoader = new THREE.TextureLoader();
    const sunTextureTrue = textureLoader.load('https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/sun.jpg');
    const sunTextureOrange = textureLoader.load('https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/orange.jpg');
    const earthTextureSatellite = textureLoader.load('https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/earth-sate.jpg');
    const earthTextureCommon = textureLoader.load("https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/earth-common.png");
    const earthTextureBlue = textureLoader.load("https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/transparent.png");
    const moonTexture = textureLoader.load("https://cdn.jsdelivr.net/gh/isXSong/FigureBed/SolarSystem/moon.png");


    /* * * * * * * * * *
     * 3D场景初始化
     * 层次结构说明：
     * scene
     * ├── sun (太阳：自转)
     * ├── earthOrbit (地球轨道：绕太阳公转)
     * │   └── earthGroup (地球整体组合，位于轨道上)
     * │       ├── earthRotationGroup (地球自转组：只包含地球球体)
     * │       │   └── earthSphere (地球球体：跟随地球自转)
     * │       ├── moonOrbitGroup (月球轨道组：相对黄道面倾斜5.15°，Z轴倾斜)
     * │       │   └── moonOrbit (月球轨道：绕地球公转)
     * │       │       └── moon (月球：潮汐锁定，一面朝地球)
     * │       └── earthAxisGroup (地轴组：倾斜23.5°，Z轴倾斜，不自转)
     * │           ├── earthAxis (地轴线)
     * │           ├── northArrow (北极箭头)
     * │           └── southArrow (南极箭头)
     * ├── earthOrbitRing (地球轨道环)
     * └── starfield (星空背景)
     * 
     * 倾斜方向说明：
     * - 地轴倾斜23.5°，Z轴正方向倾斜(夏至时北极朝向太阳)
     * - 月球轨道倾斜-5.15°，Z轴负方向，与地轴倾斜方向相对
     * - 这种相对倾斜使得月球轨道与黄道面有交点，是日月食发生的关键
     * * * * * * * * * */
    // 设置背景
    scene.background = new THREE.Color(0x0d0f13);

    // 创建太阳
    const sunGeometry = new THREE.SphereGeometry(2, 32, 32);
    const sunMaterial = new THREE.MeshLambertMaterial({
      map: sunTextureTrue,
      color: 0xfcf083,
      emissive: 0xfcf083,
      emissiveMap: sunTextureTrue,
      emissiveIntensity: 0.8
    });
    const sun = new THREE.Mesh(sunGeometry, sunMaterial);
    scene.add(sun);

    // 光源：太阳光和环境光
    const sunLight = new THREE.PointLight(0xffffff, 100, 1000);
    sunLight.position.set(0, 0, 0);
    sunLight.castShadow = true;
    sunLight.shadow.mapSize.width = 2048;
    sunLight.shadow.mapSize.height = 2048;
    scene.add(sunLight);
    const ambientLight = new THREE.AmbientLight(0x101010, 30);
    scene.add(ambientLight);

    // 创建地球本体（只包含球体，不包含地轴）
    const earthGeometry = new THREE.SphereGeometry(0.5, 32, 32);
    const earthMaterial = new THREE.MeshPhongMaterial({ 
      color: 0xcfe3fc,
      shininess: 30,
      map: earthTextureSatellite,
    });
    earthMaterial.needUpdate = true;
    const earthSphere = new THREE.Mesh(earthGeometry, earthMaterial);
    earthSphere.castShadow = true;
    earthSphere.receiveShadow = true;

    // 创建地球自转组（只包含地球球体）
    const earthRotationGroup = new THREE.Object3D();
    earthRotationGroup.add(earthSphere);

    // 创建月球
    const moonGeometry = new THREE.SphereGeometry(0.15, 16, 16);
    const moonMaterial = new THREE.MeshPhongMaterial({ 
      color: 0xcccccc,
      map: moonTexture,
      shininess: 10
    });
    const moon = new THREE.Mesh(moonGeometry, moonMaterial);
    moon.castShadow = true;
    moon.receiveShadow = true;

    // 月球轨道组（绕地球公转）
    const moonOrbit = new THREE.Object3D();
    moonOrbit.add(moon);
    moon.position.x = 1.2;

    // 月球轨道倾斜组（相对黄道面倾斜5.15°）
    const moonOrbitGroup = new THREE.Object3D();
    moonOrbitGroup.add(moonOrbit);
    // 月球轨道相对黄道面倾斜5.15度，倾斜方向与地轴相关
    // 使用Z轴负方向倾斜，与地轴倾斜方向相对
    moonOrbitGroup.rotation.z = THREE.MathUtils.degToRad(-5.15);
    
    // 注意：月球轨道的进动
    // 1. moonOrbit.rotation.y 控制月球绕地球的公转（约27.3天一周期）
    // 2. moonOrbitGroup.rotation.y 控制月球轨道面的进动（约18.6年一周期）
    // 3. 月球轨道平面相对于黄道面倾斜约5.15度，倾斜方向与地轴相对
    // 4. 月球轨道平面的方向会缓慢进动，交点线在黄道面上旋转

    // 创建月球轨道法向量（显示轨道面的法线方向）
    const moonOrbitNormalGeometry = new THREE.CylinderGeometry(0.01, 0.01, 1.5, 8);
    const moonOrbitNormalMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff0088,
      transparent: true,
      opacity: 1.0
    });
    const moonOrbitNormal = new THREE.Mesh(moonOrbitNormalGeometry, moonOrbitNormalMaterial);

    // 创建法向量箭头（正方向）
    const normalArrowGeometry = new THREE.ConeGeometry(0.03, 0.12, 8);
    const normalArrowMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff0088,
      transparent: true,
      opacity: 1.0
    });
    const normalArrowUp = new THREE.Mesh(normalArrowGeometry, normalArrowMaterial);
    normalArrowUp.position.set(0, 0.81, 0);

    // 创建法向量箭头（负方向）
    const normalArrowDown = new THREE.Mesh(normalArrowGeometry, normalArrowMaterial);
    normalArrowDown.position.set(0, -0.81, 0);
    normalArrowDown.rotation.x = Math.PI;

    // 月球轨道法向量组（位于轨道中心，垂直于轨道平面）
    const moonOrbitNormalGroup = new THREE.Object3D();
    moonOrbitNormalGroup.add(moonOrbitNormal);
    moonOrbitNormalGroup.add(normalArrowUp);
    moonOrbitNormalGroup.add(normalArrowDown);
    
    // 将法向量添加到月球轨道组中，这样它会跟随轨道倾斜和进动
    moonOrbitGroup.add(moonOrbitNormalGroup);

    // 创建地轴（独立的组，不跟随地球自转）
    const axisGeometry = new THREE.CylinderGeometry(0.005, 0.005, 1.5, 8);
    const axisMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff4444,
      transparent: true,
      opacity: 0.8
    });
    const earthAxis = new THREE.Mesh(axisGeometry, axisMaterial);

    // 创建地轴箭头（北极端）
    const arrowGeometry = new THREE.ConeGeometry(0.02, 0.08, 8);
    const arrowMaterial = new THREE.MeshBasicMaterial({ 
      color: 0xff4444,
      transparent: true,
      opacity: 0.8
    });
    const northArrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
    northArrow.position.set(0, 0.79, 0);

    // 创建地轴箭头（南极端）
    const southArrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
    southArrow.position.set(0, -0.79, 0);
    southArrow.rotation.x = Math.PI;

    // 地轴组（包含轴线和箭头，有倾斜角度但不自转）
    const earthAxisGroup = new THREE.Object3D();
    earthAxisGroup.add(earthAxis);
    earthAxisGroup.add(northArrow);
    earthAxisGroup.add(southArrow);
    // 地轴倾斜23.5度
    earthAxisGroup.rotation.z = THREE.MathUtils.degToRad(23.5);

    // 地球整体组（包含自转组 + 月球轨道组 + 地轴组）
    const earthGroup = new THREE.Object3D();
    earthGroup.add(earthRotationGroup);
    earthGroup.add(moonOrbitGroup);
    earthGroup.add(earthAxisGroup);

    // 地球轨道组（地球整体绕太阳公转）
    const earthOrbit = new THREE.Object3D();
    earthOrbit.add(earthGroup);
    earthGroup.position.x = 5;
    scene.add(earthOrbit);

    // 地球、月球轨道环显示
    const earthOrbitGeometry = new THREE.RingGeometry(4.8, 5.2, 64);
    const earthOrbitMaterial = new THREE.MeshBasicMaterial({ 
      color: 0x444444, 
      side: THREE.DoubleSide,
      transparent: true,
      opacity: 0.3
    });
    const earthOrbitRing = new THREE.Mesh(earthOrbitGeometry, earthOrbitMaterial);
    earthOrbitRing.rotation.x = -Math.PI / 2;
    scene.add(earthOrbitRing);
    const moonOrbitGeometry = new THREE.RingGeometry(1.1, 1.3, 32);
    const moonOrbitMaterial = new THREE.MeshBasicMaterial({ 
      color: 0x888888, 
      side: THREE.DoubleSide,
      transparent: true,
      opacity: 0.4
    });
    const moonOrbitRing = new THREE.Mesh(moonOrbitGeometry, moonOrbitMaterial);
    moonOrbitRing.rotation.x = -Math.PI / 2;
    // 月球轨道环相对于月球轨道组的倾斜需要考虑到组本身的倾斜
    moonOrbitGroup.add(moonOrbitRing);

    //星空
    const starfield = createStarfield(scene, 2000, 800);
    function createStarfield(scene, count = 10000, radius = 1000) {
      const positions = new Float32Array(count * 3);
      for (let i = 0; i < count; i++) {
          const i3 = i * 3;
          const phi = Math.random() * Math.PI * 2; 
          const theta = Math.random() * Math.PI;   
          positions[i3] = radius * Math.sin(theta) * Math.cos(phi); 
          positions[i3 + 1] = radius * Math.sin(theta) * Math.sin(phi);
          positions[i3 + 2] = radius * Math.cos(theta);
      }
      const geometry = new THREE.BufferGeometry();
      geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      const material = new THREE.PointsMaterial({
          color: 0xffffff,
          size: 2, 
          sizeAttenuation: true,
          transparent: true,   
          opacity: 0.8           
      });
      const starfield = new THREE.Points(geometry, material);
      starfield.renderOrder = -100;
      starfield.frustumCulled = false; 
      scene.add(starfield);
      return starfield;
    }

    // 鼠标控制
    let mouseX = 0, mouseY = 0;
    let targetX = 0, targetY = 0;
    const windowHalfX = window.innerWidth / 2;
    const windowHalfY = window.innerHeight / 2;
    document.addEventListener('mousedown', (event) => {
        mouseDragging = true;
        startMouseX = event.clientX;
        startMouseY = event.clientY;
        startAzimuth = targetAzimuth;
        startElevation = targetElevation;
    })
    document.addEventListener('mouseup', (event) => {
      mouseDragging = false;
    })
    document.addEventListener('mousemove', (event) => {
        if (!mouseDragging || isViewLocked) return;

        const dx = event.clientX - startMouseX;
        const dy = event.clientY - startMouseY;

        // 调整灵敏度
        targetAzimuth = startAzimuth - dx * 0.005;
        targetElevation = startElevation + dy * 0.005;

        // 限制 elevation（仰角）范围
        const maxElevation = Math.PI / 2 - 0.01;
        const minElevation = -Math.PI / 2 + 0.01;
        targetElevation = Math.max(minElevation, Math.min(maxElevation, targetElevation));
    });

    /* * * * * * * * * *
     * 动画更新
     * * * * * * * * * */
    function animate() {
      requestAnimationFrame(animate);
      // 运动和时间更新
      if(!isPaused){     
        var dayDelta = 1 / 60 * speedFactor;
        if(isbackwards) dayDelta = -dayDelta;
        stepSimulation(dayDelta);
      }
        // 相机控制
        if (!isViewLocked) {
            const r = 10; // 相机半径

            const x = r * Math.cos(targetElevation) * Math.sin(targetAzimuth);
            const y = r * Math.sin(targetElevation);
            const z = r * Math.cos(targetElevation) * Math.cos(targetAzimuth);

            camera.position.set(x, y, z);
            camera.up.set(0, 1, 0);
            camera.lookAt(scene.position);
        }

      if(!rendererLock)  renderer.render(scene, camera);
    }
    
    animate();

    function  stepSimulation(dayDelta, totalDaysFlag = false) {
      if(!totalDaysFlag){
          //日期更新
          days += dayDelta;
          dateCurrent = new Date(dateOrigin.getTime() + days * 24 * 60 * 60 * 1000);
          updateDate();
          // 天体转动
          sun.rotation.y += dayDelta * sunRotateAnglePerDay;
          earthOrbit.rotation.y += dayDelta * earthRevolveAnglePerDay;
          earthRotationGroup.rotation.y += dayDelta * earthRotateAnglePerDay;
          moonOrbit.rotation.y += dayDelta * moonRevolveAnglePerDay;
          moonOrbitGroup.rotation.y += dayDelta * moonOrbitPrecessionPerDay;
          moon.rotation.y += 0;
      }
      else{
          days = dayDelta;
          dateCurrent = new Date(dateOrigin.getTime() + days * 24 * 60 * 60 * 1000);
          updateDate();
          // 天体转动
          sun.rotation.y = days * sunRotateAnglePerDay;
          earthOrbit.rotation.y = days * earthRevolveAnglePerDay;
          earthRotationGroup.rotation.y = days * earthRotateAnglePerDay;
          moonOrbit.rotation.y = days * moonRevolveAnglePerDay;
          moonOrbitGroup.rotation.y = days * moonOrbitPrecessionPerDay;
      }
    }

    /* * * * * * * * * * * *
     * ui界面和交互函数
     * * * * * * * * * * * */
    //事件绑定
    controlBtn.addEventListener('click', switchControlPanel);
    tabs.forEach(tab => { tab.addEventListener('click', switchTab); });
    earthTextureRadios.forEach(radio => { 
      radio.addEventListener('change', () => {
        if (radio.checked) changeEarthTexture(radio.value);
      }); 
    });
    sunTextureRadios.forEach(radio => { 
      radio.addEventListener('change', () => {
        if (radio.checked) changeSunTexture(radio.value);
      }); 
    });
    starlandRadios.forEach(radio => { 
      radio.addEventListener('change', () => {
        if (radio.checked) changeStarland(radio.value);
      }); 
    });
    speedInput.addEventListener('input', changeSpeedFactor);
    stopSwitch.addEventListener('change', changeStopSwitch);
    reserveSwitch.addEventListener('change', changeReserveSwitch);
    axisSwitch.addEventListener('change', changeAxisVisibility);
    moonNormalSwitch.addEventListener('change', changeMoonNormalVisibility);

    //控制面板开关
    function switchControlPanel(){
      if (isControlPanelOpen) {
        controlPanel.style.width = '0';
        controlBtn.style.left = '24px';
        isControlPanelOpen = false;
      }
      else{
        controlPanel.style.width = '360px';
        controlBtn.style.left = '400px';
        isControlPanelOpen = true;
      }
    }

    //控制面板标签页切换
    function switchTab() {
      tabs.forEach(t => t.classList.remove('active'));
      panels.forEach(p => p.classList.remove('active'));
      this.classList.add('active');
      document.getElementById(this.dataset.tab).classList.add('active');
    }

    //修改地球纹理
    function changeEarthTexture(value) {
      if (value == "common-map"){
        earthMaterial.map = earthTextureCommon;
        earthMaterial.color = new THREE.Color(0xcccccc);
      }
      else if (value == "satellite-map"){
        earthMaterial.map = earthTextureSatellite;
        earthMaterial.color = new THREE.Color(0xcfe3fc);
      }
      else{
        earthMaterial.map = earthTextureBlue;
        earthMaterial.color = new THREE.Color(0x4488ff);
      }
    }

    //修改太阳纹理
    function changeSunTexture(value) {
      if (value == "true-surface"){
        sunMaterial.map = sunTextureTrue;
        sunMaterial.emissiveMap = sunTextureTrue;
      }
      else{
        sunMaterial.map = sunTextureOrange;
        sunMaterial.emissiveMap = sunTextureOrange;
      }
    }

    //修改星空显示
    function changeStarland(value) {
      if (value == "stars"){
        starfield.visible = true;
      }
      else{
        starfield.visible = false;
      }
    }

    //修改地轴显示
    function changeAxisVisibility() {
      earthAxisGroup.visible = axisSwitch.checked;
    }

    //修改月球轨道法向量显示
    function changeMoonNormalVisibility() {
      moonOrbitNormalGroup.visible = moonNormalSwitch.checked;
    }

    //修改速度
    function changeSpeedFactor() {
      speedFactor = 2 ** speedInput.value;
      if (speedFactor < 1)
        speedFactor = speedFactor.toFixed(2);
      else
        speedFactor = speedFactor.toFixed(0);
      speedLabel.innerHTML = 'x' + speedFactor;
      toolSpeed.innerHTML = "<i>x" + speedFactor + "</i>";
      dashboardSpeed.innerHTML = speedFactor + 'day/s';
    }

    //暂停、运行
    function changeStopSwitch() {
      if (stopSwitch.checked){
        isPaused = true;
        toolPause.innerHTML = '<i class="fa fa-play"></i>';
      }
      else{
        isPaused = false;
        toolPause.innerHTML = '<i class="fa fa-pause"></i>';
      }
    }

    //倒退运行
    function changeReserveSwitch() {
      if (reserveSwitch.checked)
        isbackwards = true;
      else
        isbackwards = false;
    }

    //日期跳转By
    function dateJumpBy(value) { 
      dayDelta = value;
      stepSimulation(dayDelta);
    }

    //日期跳转To
    function onClickDateSubmit(){
      var dayValue = dateInput.value;
      if (dayValue == '') return;
      var dateTarget = new Date(dayValue);
      var dayDelta = (dateTarget.getTime() - dateOrigin.getTime()) / (1000 * 60 * 60 * 24);
      if(Math.abs(dayDelta-days) < 1) return;
      stepSimulation(dayDelta, true);
    }

    //小工具条：暂停
    function clickOnToolPause() {
      stopSwitch.checked = !stopSwitch.checked;
      changeStopSwitch();
    }

    //小工具条：速度
    function clickOnToolSpeed(value) {
      if(speedFactor >= 1 && speedFactor < 4) 
        speedInput.value = 2;
      else if(speedFactor >= 4 && speedFactor < 16) 
        speedInput.value = 4;
      else if(speedFactor >= 16 && speedFactor < 64) 
        speedInput.value = 6;
      else
        speedInput.value = 0;
      changeSpeedFactor();
    }

    //小工具条：截图
    function clickOnToolScreenshot() {
      rendererLock = true;
      renderer.render(scene, camera);
      var imgData = renderer.domElement.toDataURL("image/png");
      rendererLock = false;
      var link = document.createElement('a');
      link.href = imgData;
      link.download = 'screenshot.png';
      link.click();
    }

    //日期更新
    function updateDate() {
      dashboardDate.innerHTML = dateCurrent.toLocaleString().split(' ')[0];
      var sarosProgress = ((days % sarosCurrent) / sarosCurrent * 100);
      if(sarosProgress < 0) sarosProgress = 100 + sarosProgress;
      dashboardSaros.innerHTML = sarosProgress.toFixed(2) + '%';
    }

      // 视角切换相关变量与函数

      const topViewRadio = document.getElementById('top-view');
      const sideViewRadio = document.getElementById('side-view');
      const view3DRadio = document.getElementById('3D-view');

      function switchToTopView() {
          isViewLocked = true;
          camera.position.set(0, 20, 0);
          camera.up.set(0, 0, -1);
          camera.lookAt(scene.position);
      }

      function switchToSideView() {
          isViewLocked = true;
          camera.position.set(20, 0, 0);
          camera.up.set(0, 1, 0);
          camera.lookAt(scene.position);
      }

      function switchTo3DView() {
          isViewLocked = false;
      }

      // 绑定按钮事件
      topViewRadio.addEventListener('change', () => {
          if (topViewRadio.checked) switchToTopView();
      });
      sideViewRadio.addEventListener('change', () => {
          if (sideViewRadio.checked) switchToSideView();
      });
      view3DRadio.addEventListener('change', () => {
          if (view3DRadio.checked) switchTo3DView();
      });

  </script>
</body>
</html>
